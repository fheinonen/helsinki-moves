(()=>{(()=>{let N=window.HMApp||(window.HMApp={}),o=N.api||={};N.dom={locateBtn:document.getElementById("locateBtn"),voiceLocateBtn:document.getElementById("voiceLocateBtn"),voiceLocateBtnLabel:document.getElementById("voiceLocateBtnLabel"),skeletonEl:document.getElementById("skeleton"),segmentControlEl:document.querySelector(".segment-control"),modeRailBtn:document.getElementById("modeRailBtn"),modeTramBtn:document.getElementById("modeTramBtn"),modeMetroBtn:document.getElementById("modeMetroBtn"),modeBusBtn:document.getElementById("modeBusBtn"),helsinkiOnlyBtn:document.getElementById("helsinkiOnlyBtn"),busControlsEl:document.getElementById("busControls"),busStopSelectEl:document.getElementById("busStopSelect"),busStopSelectLabelEl:document.getElementById("busStopSelectLabel"),busStopSelectListEl:document.getElementById("busStopSelectList"),busStopSelectWrapEl:document.getElementById("busStopSelectWrap"),busLineFiltersEl:document.getElementById("busLineFilters"),busDestinationFiltersEl:document.getElementById("busDestinationFilters"),stopFiltersToggleBtnEl:document.getElementById("stopFiltersToggleBtn"),stopFiltersPanelEl:document.getElementById("stopFiltersPanel"),stopFilterSummaryEl:document.getElementById("stopFilterSummary"),resultsLimitSelectEl:document.getElementById("resultsLimitSelect"),resultsLimitSelectLabelEl:document.getElementById("resultsLimitSelectLabel"),resultsLimitSelectListEl:document.getElementById("resultsLimitSelectList"),resultsLimitSelectWrapEl:document.getElementById("resultsLimitSelectWrap"),modeEyebrowEl:document.getElementById("modeEyebrow"),statusEl:document.getElementById("status"),resolvedLocationEl:document.getElementById("resolvedLocation"),voiceLocationChoicesEl:document.getElementById("voiceLocationChoices"),voiceLocationChoicesTitleEl:document.getElementById("voiceLocationChoicesTitle"),voiceLocationChoicesOptionsEl:document.getElementById("voiceLocationChoicesOptions"),voiceLocationChoicesCancelEl:document.getElementById("voiceLocationChoicesCancel"),dataScopeEl:document.getElementById("dataScope"),resultEl:document.getElementById("result"),permissionCardEl:document.getElementById("permissionCard"),stationTitleEl:document.getElementById("stationTitle"),stationMetaEl:document.getElementById("stationMeta"),departuresEl:document.getElementById("departures"),nextSummaryEl:document.getElementById("nextSummary"),nextLabelEl:document.getElementById("nextLabel"),nextMinsEl:document.getElementById("nextMins"),nextLineEl:document.getElementById("nextLine"),nextTrackEl:document.getElementById("nextTrack"),nextDestinationEl:document.getElementById("nextDestination"),nowClockEl:document.getElementById("nowClock"),lastUpdatedEl:document.getElementById("lastUpdated")},N.constants={MODE_RAIL:"rail",MODE_TRAM:"tram",MODE_METRO:"metro",MODE_BUS:"bus",STORAGE_MODE_KEY:"prefs:mode",STORAGE_HELSINKI_ONLY_KEY:"prefs:helsinkiOnly",STORAGE_BUS_STOP_KEY:"prefs:busStopId",STORAGE_BUS_LINES_KEY:"prefs:busLines",STORAGE_BUS_DESTINATIONS_KEY:"prefs:busDestinations",STORAGE_RESULTS_LIMIT_RAIL_KEY:"prefs:resultsLimitRail",STORAGE_RESULTS_LIMIT_TRAM_KEY:"prefs:resultsLimitTram",STORAGE_RESULTS_LIMIT_METRO_KEY:"prefs:resultsLimitMetro",STORAGE_RESULTS_LIMIT_BUS_KEY:"prefs:resultsLimitBus",DEFAULT_RESULTS_LIMIT_RAIL:8,DEFAULT_RESULTS_LIMIT_TRAM:8,DEFAULT_RESULTS_LIMIT_METRO:8,DEFAULT_RESULTS_LIMIT_BUS:24,RESULT_LIMIT_OPTIONS:[8,12,16,20,24,30],VOICE_RECOGNITION_TIMEOUT_MS:8e3,VOICE_SILENCE_STOP_MS:1200,VOICE_QUERY_MIN_LENGTH:3,FETCH_TIMEOUT_MS:8e3,ERROR_REPORT_LIMIT:5,METRIC_REPORT_LIMIT:10,METRIC_SAMPLE_RATE:1};let{MODE_RAIL:n,MODE_TRAM:e,MODE_METRO:A,MODE_BUS:x}=N.constants;N.state={isLoading:!1,isVoiceListening:!1,currentCoords:null,latestResponse:null,mode:n,helsinkiOnly:!1,busStopId:null,busLineFilters:[],busDestinationFilters:[],stopFiltersPanelOpen:!1,deferInitialStopContext:!1,deferredBusStopId:null,deferredBusLineFilters:[],deferredBusDestinationFilters:[],resultsLimitByMode:{[n]:N.constants.DEFAULT_RESULTS_LIMIT_RAIL,[e]:N.constants.DEFAULT_RESULTS_LIMIT_TRAM,[A]:N.constants.DEFAULT_RESULTS_LIMIT_METRO,[x]:N.constants.DEFAULT_RESULTS_LIMIT_BUS},busStops:[],busFilterOptions:{lines:[],destinations:[]},resolvedLocationHint:null,suppressBusStopChange:!1,hasCompletedInitialStopModeLoad:!1,errorReportCount:0,metricReportCount:0,isMetricSessionSampled:Math.random()<N.constants.METRIC_SAMPLE_RATE,sessionStartedAtMs:Date.now(),hasReportedFirstSuccessfulRenderMetric:!1,hasReportedFirstManualInteractionMetric:!1,hasReportedFirstManualStopContextMetric:!1,hasReportedInitialNearestStopResolvedMetric:!1,latestLoadToken:0};let{dom:I,state:l,constants:h}=N;function M(){let t=l.isLoading||l.isVoiceListening,r=l.isLoading;I.locateBtn&&(I.locateBtn.disabled=t),I.voiceLocateBtn&&(I.voiceLocateBtn.disabled=r,I.voiceLocateBtn.classList.toggle("is-listening",l.isVoiceListening),I.voiceLocateBtn.setAttribute("aria-pressed",String(l.isVoiceListening))),I.voiceLocateBtnLabel&&(I.voiceLocateBtnLabel.textContent=l.isVoiceListening?"Listening...":"Describe Location")}function p(t){l.isLoading=t,M(),I.skeletonEl&&I.skeletonEl.classList.toggle("hidden",!t)}function v(t){l.isVoiceListening=!!t,M()}function w(t){I.statusEl&&(I.statusEl.textContent=t)}function _(t){let r=Number(t);return Number.isFinite(r)?r.toFixed(5):null}function E(t){let r=t&&typeof t=="object";if(l.resolvedLocationHint=r?{query:B(t.query,120).trim(),label:B(t.label,180).trim(),lat:Number(t.lat),lon:Number(t.lon)}:null,!I.resolvedLocationEl)return;if(!l.resolvedLocationHint){I.resolvedLocationEl.classList.add("hidden"),I.resolvedLocationEl.textContent="";return}let L=l.resolvedLocationHint.label||"Unknown place",C=l.resolvedLocationHint.query,k=_(l.resolvedLocationHint.lat),R=_(l.resolvedLocationHint.lon),i=C?` (from "${C}")`:"",s=k&&R?` - ${k}, ${R}`:"";I.resolvedLocationEl.textContent=`Resolved location: ${L}${i}${s}`,I.resolvedLocationEl.classList.remove("hidden")}function O(t){I.permissionCardEl&&I.permissionCardEl.classList.toggle("hidden",!t)}function F(t){!I.lastUpdatedEl||!(t instanceof Date)||(I.lastUpdatedEl.textContent=`Last updated: ${t.toLocaleTimeString([],{hour:"2-digit",minute:"2-digit",second:"2-digit",hour12:!1})}`)}function T(t){try{return window.localStorage.getItem(t)}catch{return null}}function D(t,r){try{window.localStorage.setItem(t,r)}catch{}}function B(t,r){let L=String(t||"");return L.length<=r?L:L.slice(0,r)}function j(t){if(t instanceof Error)return t;try{let r=typeof t=="string"?t:JSON.stringify(t);return new Error(r||"Unknown error")}catch{return new Error(String(t||"Unknown error"))}}function W(t){let r=JSON.stringify(t);if(navigator.sendBeacon){let L=new Blob([r],{type:"application/json"});navigator.sendBeacon("/api/v1/client-error",L);return}fetch("/api/v1/client-error",{method:"POST",headers:{"content-type":"application/json"},body:r,keepalive:!0}).catch(()=>{})}function J(t,r,L=null){if(l.errorReportCount>=h.ERROR_REPORT_LIMIT)return;l.errorReportCount+=1;let C=j(r),k={type:B(t,40),message:B(C.message,400),stack:B(C.stack||"",1200),url:B(window.location.href,500),userAgent:B(navigator.userAgent||"",300),timestamp:new Date().toISOString(),context:L&&typeof L=="object"?L:null};W(k)}function X(){return Math.max(0,Date.now()-l.sessionStartedAtMs)}function P(t,r=null){if(!l.isMetricSessionSampled||l.metricReportCount>=h.METRIC_REPORT_LIMIT)return!1;l.metricReportCount+=1;let L={type:"metric",message:B(t,400),stack:"",url:B(window.location.href,500),userAgent:B(navigator.userAgent||"",300),timestamp:new Date().toISOString(),context:{metricName:B(t,80),sessionElapsedMs:X(),mode:l.mode,...r&&typeof r=="object"?r:{}}};return W(L),!0}function H(t,r){if(l.hasReportedFirstSuccessfulRenderMetric)return;l.hasReportedFirstSuccessfulRenderMetric=!0;let L=Array.isArray(t?.station?.departures)?t.station.departures:[];P("first_successful_render",{requestMode:String(r||"").trim(),hasStation:!!t?.station,departureCount:L.length})}function Z(t,r=null){l.hasReportedFirstManualInteractionMetric||(l.hasReportedFirstManualInteractionMetric=!0,P("first_manual_interaction",{interactionType:B(t,80),...r&&typeof r=="object"?r:{}}))}function ee(t,r=null){l.hasReportedFirstManualStopContextMetric||(l.hasReportedFirstManualStopContextMetric=!0,P("first_manual_stop_context_change",{changeType:B(t,80),lineFilterCount:l.busLineFilters.length,destinationFilterCount:l.busDestinationFilters.length,...r&&typeof r=="object"?r:{}}))}function te(t,r){if(l.hasReportedInitialNearestStopResolvedMetric)return;let L=String(t?.selectedStopId||"").trim();if(!L)return;l.hasReportedInitialNearestStopResolvedMetric=!0;let k=(Array.isArray(t?.stops)?t.stops:[]).find(i=>i?.id===L)||null,R=Array.isArray(t?.station?.departures)?t.station.departures:[];P("initial_nearest_stop_resolved",{requestMode:String(r||"").trim(),selectedStopId:L,distanceMeters:Number(k?.distanceMeters)||null,departureCount:R.length})}function V(t){if(!t)return null;let r=String(t).trim().toLowerCase();return r===n||r===e||r===A||r===x?r:null}function q(t){if(t==null)return null;let r=String(t).trim().toLowerCase();return["1","true","yes","on"].includes(r)?!0:["0","false","no","off"].includes(r)?!1:null}function G(t){return Array.isArray(t)?[...new Set(t.map(r=>String(r||"").trim()).filter(Boolean))]:[]}function U(t){if(t==null||t==="")return null;let r=Number(t);return!Number.isInteger(r)||!h.RESULT_LIMIT_OPTIONS.includes(r)?null:r}function Y(t=l.mode){return t===x?h.DEFAULT_RESULTS_LIMIT_BUS:t===A?h.DEFAULT_RESULTS_LIMIT_METRO:t===e?h.DEFAULT_RESULTS_LIMIT_TRAM:h.DEFAULT_RESULTS_LIMIT_RAIL}function $(t=l.mode){let r=U(l.resultsLimitByMode?.[t]);return r??Y(t)}function K(t){let r=T(t);if(!r)return[];try{let L=JSON.parse(r);return G(L)}catch{return[]}}function a(){let t=new URLSearchParams(window.location.search);return{mode:V(t.get("mode")),helsinkiOnly:q(t.get("helsinkiOnly")),stopProvided:t.has("stop"),busStopId:t.get("stop")?t.get("stop").trim():null,linesProvided:t.has("line"),busLines:G(t.getAll("line")),destinationsProvided:t.has("dest"),busDestinations:G(t.getAll("dest")),resultsProvided:t.has("results"),resultsLimit:U(t.get("results"))}}function u(){let t=a(),r=V(T(h.STORAGE_MODE_KEY)),L=q(T(h.STORAGE_HELSINKI_ONLY_KEY));l.mode=t.mode||r||n,l.helsinkiOnly=t.helsinkiOnly??L??!1,l.mode!==n&&(l.helsinkiOnly=!1);let C=String(T(h.STORAGE_BUS_STOP_KEY)||"").trim()||null,k=t.stopProvided?t.busStopId:C,R=K(h.STORAGE_BUS_LINES_KEY),i=K(h.STORAGE_BUS_DESTINATIONS_KEY),s=t.linesProvided?t.busLines:R,c=t.destinationsProvided?t.busDestinations:i,m=!!k||s.length>0||c.length>0;l.deferInitialStopContext=m,m?(l.deferredBusStopId=k,l.deferredBusLineFilters=[...s],l.deferredBusDestinationFilters=[...c],l.busStopId=null,l.busLineFilters=[],l.busDestinationFilters=[]):(l.deferredBusStopId=null,l.deferredBusLineFilters=[],l.deferredBusDestinationFilters=[],l.busStopId=k,l.busLineFilters=s,l.busDestinationFilters=c);let y=U(T(h.STORAGE_RESULTS_LIMIT_RAIL_KEY)),g=U(T(h.STORAGE_RESULTS_LIMIT_TRAM_KEY)),b=U(T(h.STORAGE_RESULTS_LIMIT_METRO_KEY)),Q=U(T(h.STORAGE_RESULTS_LIMIT_BUS_KEY));l.resultsLimitByMode[n]=y??h.DEFAULT_RESULTS_LIMIT_RAIL,l.resultsLimitByMode[e]=g??h.DEFAULT_RESULTS_LIMIT_TRAM,l.resultsLimitByMode[A]=b??h.DEFAULT_RESULTS_LIMIT_METRO,l.resultsLimitByMode[x]=Q??h.DEFAULT_RESULTS_LIMIT_BUS,t.resultsProvided&&t.resultsLimit!=null&&(l.resultsLimitByMode[l.mode]=t.resultsLimit)}function d(){D(h.STORAGE_MODE_KEY,l.mode),D(h.STORAGE_HELSINKI_ONLY_KEY,l.helsinkiOnly?"1":"0"),D(h.STORAGE_BUS_STOP_KEY,l.busStopId||""),D(h.STORAGE_BUS_LINES_KEY,JSON.stringify(l.busLineFilters)),D(h.STORAGE_BUS_DESTINATIONS_KEY,JSON.stringify(l.busDestinationFilters)),D(h.STORAGE_RESULTS_LIMIT_RAIL_KEY,String($(n))),D(h.STORAGE_RESULTS_LIMIT_TRAM_KEY,String($(e))),D(h.STORAGE_RESULTS_LIMIT_METRO_KEY,String($(A))),D(h.STORAGE_RESULTS_LIMIT_BUS_KEY,String($(x)))}function S(){let t=new URLSearchParams(window.location.search);l.mode===n?t.delete("mode"):t.set("mode",l.mode),l.mode===n&&l.helsinkiOnly?t.set("helsinkiOnly","1"):t.delete("helsinkiOnly");let r=$(),L=Y();if(r===L?t.delete("results"):t.set("results",String(r)),t.delete("stop"),t.delete("line"),t.delete("dest"),l.mode===x||l.mode===e||l.mode===A){l.busStopId&&t.set("stop",l.busStopId);for(let R of l.busLineFilters)t.append("line",R);for(let R of l.busDestinationFilters)t.append("dest",R)}let C=t.toString(),k=`${window.location.pathname}${C?`?${C}`:""}${window.location.hash}`;window.history.replaceState(null,"",k)}function f(){d(),S()}M(),Object.assign(o,{updateLocationActionButtons:M,setLoading:p,setVoiceListening:v,setStatus:w,setResolvedLocationHint:E,setPermissionRequired:O,setLastUpdated:F,getStorageItem:T,setStorageItem:D,safeString:B,toError:j,sendClientReport:W,reportClientError:J,reportClientMetric:P,getSessionElapsedMs:X,trackFirstSuccessfulRender:H,trackFirstManualInteraction:Z,trackFirstManualStopContextChange:ee,trackInitialNearestStopResolved:te,normalizeMode:V,parseBoolean:q,uniqueNonEmptyStrings:G,parseResultLimit:U,getDefaultResultsLimit:Y,getActiveResultsLimit:$,parseStoredArray:K,readStateFromUrl:a,hydrateInitialState:u,syncStateToStorage:d,syncStateToUrl:S,persistUiState:f})})();(()=>{let N=window.HMApp,{api:o,dom:n,state:e,constants:A}=N,{MODE_RAIL:x,MODE_TRAM:I,MODE_METRO:l,MODE_BUS:h}=A;function M(i=e.mode){return i===h||i===I||i===l}function p(i=e.mode){return i===I?{singular:"tram",plural:"trams",title:"Tram"}:i===l?{singular:"metro",plural:"metros",title:"Metro"}:{singular:"bus",plural:"buses",title:"Bus"}}function v(i){let s=w(i);return s<=0?"Now":`${s}m`}function w(i){let s=new Date(i);return Math.floor((s.getTime()-Date.now())/6e4)}function _(i){let s=w(i);return s<=0||s<3?"departure-now":s<=10?"departure-soon":"departure-later"}function E(i){let s=i?.destination||"";return/\bhelsinki\b/i.test(s)}function O(){let i=new Set((e.busFilterOptions.lines||[]).map(c=>c.value)),s=new Set((e.busFilterOptions.destinations||[]).map(c=>c.value));e.busLineFilters=e.busLineFilters.filter(c=>i.has(c)),e.busDestinationFilters=e.busDestinationFilters.filter(c=>s.has(c))}function F(i){if(!Array.isArray(i))return[];if(e.mode===x)return e.helsinkiOnly?i.filter(E):i;if(!M())return i;let s=new Set(e.busLineFilters),c=new Set(e.busDestinationFilters);return i.filter(m=>{if(s.size===0)return!0;let y=String(m?.line||"").trim();return s.has(y)}).filter(m=>{if(c.size===0)return!0;let y=String(m?.destination||"").trim();return c.has(y)})}function T(){let i=[{el:n.modeRailBtn,mode:x,index:0},{el:n.modeTramBtn,mode:I,index:1},{el:n.modeMetroBtn,mode:l,index:2},{el:n.modeBusBtn,mode:h,index:3}];for(let{el:s,mode:c,index:m}of i){if(!s)continue;let y=e.mode===c;if(s.setAttribute("aria-checked",String(y)),s.classList.toggle("is-active",y),y){let g=s.closest(".segment-control");g&&g.style.setProperty("--active-index",m)}}}function D(){let i=M()?p().title:"Rail",s=M()?`Next ${p().title}`:"Next Train";n.modeEyebrowEl&&(n.modeEyebrowEl.textContent=`Helsinki Moves \u2022 ${i}`),n.nextLabelEl&&(n.nextLabelEl.textContent=s)}function B(i){if(!n.resultsLimitSelectEl||!n.resultsLimitSelectListEl)return;let s=n.resultsLimitSelectEl.getAttribute("aria-expanded")==="true",c=typeof i=="boolean"?i:!s;n.resultsLimitSelectEl.setAttribute("aria-expanded",String(c)),n.resultsLimitSelectListEl.classList.toggle("hidden",!c)}function j(i){let s=o.parseResultLimit(i);s==null||(B(!1),o.getActiveResultsLimit()===s)||(o.trackFirstManualInteraction("results_limit_change",{nextLimit:s,currentMode:e.mode}),e.resultsLimitByMode[e.mode]=s,o.persistUiState(),n.resultsLimitSelectLabelEl&&(n.resultsLimitSelectLabelEl.textContent=String(s)),e.currentCoords?o.load(e.currentCoords.lat,e.currentCoords.lon):o.requestLocationAndLoad())}function W(){if(!n.resultsLimitSelectListEl)return;let i=Array.isArray(A.RESULT_LIMIT_OPTIONS)?A.RESULT_LIMIT_OPTIONS:[],s=o.getActiveResultsLimit();n.resultsLimitSelectListEl.innerHTML="";for(let c of i){let m=document.createElement("li");m.setAttribute("role","option"),m.dataset.value=String(c),m.textContent=String(c),c===s&&m.setAttribute("aria-selected","true"),m.addEventListener("click",()=>j(String(c))),n.resultsLimitSelectListEl.appendChild(m)}n.resultsLimitSelectLabelEl&&(n.resultsLimitSelectLabelEl.textContent=String(s))}function J(){if(n.helsinkiOnlyBtn){if(e.mode!==x){n.helsinkiOnlyBtn.setAttribute("aria-pressed","false"),n.helsinkiOnlyBtn.classList.remove("is-active"),n.helsinkiOnlyBtn.disabled=!0,n.helsinkiOnlyBtn.textContent="Helsinki Only (Rail)";return}n.helsinkiOnlyBtn.disabled=!1,n.helsinkiOnlyBtn.setAttribute("aria-pressed",String(e.helsinkiOnly)),n.helsinkiOnlyBtn.classList.toggle("is-active",e.helsinkiOnly),n.helsinkiOnlyBtn.textContent=e.helsinkiOnly?"Helsinki Only: On":"Helsinki Only: Off"}}function X(){return Math.max(0,e.busLineFilters.length)+Math.max(0,e.busDestinationFilters.length)}function P(i=e.busLineFilters.length,s=e.busDestinationFilters.length){let c=Math.max(0,Number(i)||0)+Math.max(0,Number(s)||0);return c===0?"No filters":c===1?"1 filter":`${c} filters`}function H(){n.stopFilterSummaryEl&&(n.stopFilterSummaryEl.textContent=P()),!(!n.stopFiltersToggleBtnEl||!n.stopFiltersPanelEl)&&(n.stopFiltersToggleBtnEl.setAttribute("aria-expanded",String(!!e.stopFiltersPanelOpen)),n.stopFiltersPanelEl.classList.toggle("hidden",!e.stopFiltersPanelOpen))}function Z(i){e.stopFiltersPanelOpen=!!i,H()}function ee(i){let s=typeof i=="boolean"?i:!e.stopFiltersPanelOpen;Z(s)}function te(i){n.busControlsEl&&(n.busControlsEl.classList.toggle("hidden",!i),i||(e.stopFiltersPanelOpen=!1),H())}function V(i){return e.busStops.find(s=>s.id===i)||null}function q(i){let s=o.uniqueNonEmptyStrings([...Array.isArray(i?.stopCodes)?i.stopCodes:[],i?.code]);return s.length===0&&i?.id&&s.push(String(i.id)),s}function G(i,s=null){let c=V(e.busStopId),m=String(s?.stopName||i?.stopName||c?.name||"").trim(),g=o.uniqueNonEmptyStrings([s?.stopCode,...Array.isArray(i?.stopCodes)?i.stopCodes:[],i?.stopCode,...q(c)])[0]||"";return m&&g?`${m} ${g}`:m||g||"\u2014"}function U(i,s=null){if(M())return G(i,s);let c=String(s?.stopName||i?.stopName||"").trim(),m=String(s?.stopCode||i?.stopCode||"").trim();return c&&m?`${c} ${m}`:c||m||"\u2014"}function Y(i){if(!n.dataScopeEl)return;if(!M()){n.dataScopeEl.classList.add("hidden"),n.dataScopeEl.textContent="";return}let s=String(i?.station?.stopName||V(e.busStopId)?.name||"").trim(),m=o.uniqueNonEmptyStrings([...Array.isArray(i?.station?.stopCodes)?i.station.stopCodes:[],i?.station?.stopCode,...q(V(e.busStopId))]).join(", "),y=e.busLineFilters.length===0?"all lines":`${e.busLineFilters.length} line${e.busLineFilters.length===1?"":"s"} selected`,g=e.busDestinationFilters.length===0?"all destinations":`${e.busDestinationFilters.length} destination${e.busDestinationFilters.length===1?"":"s"} selected`,b=`${o.getActiveResultsLimit()} results`;s?n.dataScopeEl.textContent=`Selected stop ${s} (${m||"\u2014"}) - ${y}, ${g}, ${b}`:n.dataScopeEl.textContent=`Selecting stop... (${y}, ${g}, ${b})`,n.dataScopeEl.classList.remove("hidden")}function $(i,s,c,m){if(!i)return;if(i.innerHTML="",!Array.isArray(s)||s.length===0){let g=document.createElement("span");g.className="chip-empty",g.textContent="No options",i.appendChild(g);return}let y=new Set(c);for(let g of s){let b=document.createElement("button");b.type="button",b.className="chip-toggle",y.has(g.value)?(b.classList.add("is-active"),b.setAttribute("aria-pressed","true")):b.setAttribute("aria-pressed","false"),b.textContent=`${g.value} (${g.count})`,b.addEventListener("click",()=>m(g.value)),i.appendChild(b)}}function K(i){if(!n.busStopSelectEl||!n.busStopSelectListEl)return;let s=n.busStopSelectEl.getAttribute("aria-expanded")==="true",c=typeof i=="boolean"?i:!s;n.busStopSelectEl.setAttribute("aria-expanded",String(c)),n.busStopSelectListEl.classList.toggle("hidden",!c)}function a(i){if(!e.suppressBusStopChange){if(!i||i===e.busStopId){K(!1);return}if(o.trackFirstManualInteraction("stop_select",{currentMode:e.mode}),o.trackFirstManualStopContextChange("stop_select",{selectedStopId:i}),e.busStopId=i,o.persistUiState(),K(!1),n.busStopSelectLabelEl){let s=e.busStops.find(c=>c.id===i);n.busStopSelectLabelEl.textContent=s?`${s.name} (${s.distanceMeters}m)`:i}e.currentCoords&&o.load(e.currentCoords.lat,e.currentCoords.lon)}}function u(){let i=M();if(te(i),!!i){if(H(),n.busStopSelectListEl){if(e.suppressBusStopChange=!0,n.busStopSelectListEl.innerHTML="",e.busStops.length===0)n.busStopSelectLabelEl&&(n.busStopSelectLabelEl.textContent=`No nearby ${p().singular} stops`),n.busStopSelectEl&&(n.busStopSelectEl.disabled=!0);else{n.busStopSelectEl&&(n.busStopSelectEl.disabled=!1);let s=e.busStopId;(!s||!e.busStops.some(c=>c.id===s))&&(s=e.busStops[0].id);for(let c of e.busStops){let m=document.createElement("li");m.setAttribute("role","option"),m.dataset.value=c.id,m.textContent=`${c.name} (${c.distanceMeters}m)`,c.id===s&&m.setAttribute("aria-selected","true"),m.addEventListener("click",()=>a(c.id)),n.busStopSelectListEl.appendChild(m)}if(n.busStopSelectLabelEl){let c=e.busStops.find(m=>m.id===s);n.busStopSelectLabelEl.textContent=c?`${c.name} (${c.distanceMeters}m)`:"Select stop"}}e.suppressBusStopChange=!1}$(n.busLineFiltersEl,e.busFilterOptions.lines,e.busLineFilters,s=>{e.busLineFilters.includes(s)?e.busLineFilters=e.busLineFilters.filter(c=>c!==s):e.busLineFilters=[...e.busLineFilters,s],o.trackFirstManualInteraction("line_filter_toggle",{currentMode:e.mode}),o.trackFirstManualStopContextChange("line_filter_toggle"),o.persistUiState(),H(),e.latestResponse&&(o.render(e.latestResponse),o.setStatus(o.buildStatusFromResponse(e.latestResponse)))}),$(n.busDestinationFiltersEl,e.busFilterOptions.destinations,e.busDestinationFilters,s=>{e.busDestinationFilters.includes(s)?e.busDestinationFilters=e.busDestinationFilters.filter(c=>c!==s):e.busDestinationFilters=[...e.busDestinationFilters,s],o.trackFirstManualInteraction("destination_filter_toggle",{currentMode:e.mode}),o.trackFirstManualStopContextChange("destination_filter_toggle"),o.persistUiState(),H(),e.latestResponse&&(o.render(e.latestResponse),o.setStatus(o.buildStatusFromResponse(e.latestResponse)))})}}function d(i,s=null){if(!n.nextSummaryEl||!n.nextMinsEl||!n.nextLineEl||!n.nextTrackEl||!n.nextDestinationEl)return;if(!i){n.nextSummaryEl.classList.add("hidden"),n.nextSummaryEl.classList.remove("next-summary-now","next-summary-soon","next-summary-later");return}let c=w(i.departureIso);n.nextMinsEl.textContent=v(i.departureIso),n.nextLineEl.textContent=i.line||"\u2014",n.nextLineEl.classList.toggle("next-letter-now",c<3),n.nextTrackEl.textContent=M()?`Stop ${U(s,i)}`:i.track?`Track ${i.track}`:"Track \u2014",n.nextDestinationEl.textContent=i.destination||"\u2014",n.nextSummaryEl.classList.remove("next-summary-now","next-summary-soon","next-summary-later"),c<3?n.nextSummaryEl.classList.add("next-summary-now"):c<=10?n.nextSummaryEl.classList.add("next-summary-soon"):n.nextSummaryEl.classList.add("next-summary-later"),n.nextSummaryEl.classList.remove("hidden")}function S(i){if(!i||!i.station)return M()?i?.message||`No nearby ${p().singular} stops found.`:i?.message||"No nearby train stations found.";let c=F(i.station.departures)[0];if(!c)return M()?e.busLineFilters.length>0||e.busDestinationFilters.length>0?`No upcoming ${p().plural} match selected filters.`:"No upcoming departures from this stop.":e.helsinkiOnly?"No Helsinki-bound trains in upcoming departures.":"No upcoming commuter trains right now.";let m=c.destination?` \u2022 ${c.destination}`:"",y=e.mode===x?c.track?` \u2022 Track ${c.track}`:"":i.station.stopName||i.station.stopCode?` \u2022 ${U(i.station,c)}`:"",g=M()?p().singular:"train";return`Next ${c.line||g} in ${v(c.departureIso)}${m}${y}`}function f(i){if(!(i instanceof Error))return"Could not refresh departures. Please try again.";if(i.name==="AbortError")return"Request timed out. Please try again.";let s=(i.message||"").trim();return s==="Temporary server error. Please try again."?s:s==="Invalid lat/lon"?"Location coordinates were invalid. Please refresh your location.":s==="Invalid mode"?"Unsupported transport mode.":"Could not refresh departures. Please try again."}function t(i){return i?.code===1?"Location permission denied.":i?.code===2?"Location unavailable. Please try again.":i?.code===3?"Location request timed out. Please try again.":"Unable to get your location."}function r(i){let s=String(i?.code||"").trim();return s==="voice_unsupported"?"Voice location is not supported in this browser.":s==="voice_permission_denied"?"Microphone permission denied.":s==="voice_no_microphone"?"No microphone was found for voice location.":s==="voice_no_speech"?"No speech detected. Please try again.":s==="voice_recognition_timeout"?"Voice listening timed out. Please try again.":s==="voice_language_not_supported"?"Voice language was not supported on this device.":s==="voice_query_too_short"?"Please describe your location with a few words.":s==="voice_location_not_found"?"Could not match that place. Try a nearby landmark or street.":s==="voice_location_selection_cancelled"?"Location selection was cancelled.":s==="voice_location_selection_invalid"?"Please choose one of the suggested locations.":s==="voice_recognition_network"?"Voice recognition failed due to a network error. On iPhone, try enabling Siri & Dictation.":"Could not use voice location. Please try again."}function L(){n.skeletonEl&&n.skeletonEl.classList.remove("hidden")}function C(){n.skeletonEl&&n.skeletonEl.classList.add("hidden")}function k(i){if(C(),u(),Y(i),!i||!i.station){n.resultEl.classList.add("hidden"),d(null);return}let s=i.station;n.resultEl.classList.remove("hidden"),n.stationTitleEl.textContent=s.stopName,n.stationMetaEl.textContent=`${s.distanceMeters}m away`,n.departuresEl.innerHTML="";let c=F(s.departures);if(c.length===0){d(null);let y=document.createElement("li");y.className="empty-row",M()?y.textContent=e.busLineFilters.length>0||e.busDestinationFilters.length>0?`No upcoming ${p().plural} match selected filters.`:"No upcoming departures from this stop.":y.textContent=e.helsinkiOnly?"No Helsinki-bound trains in upcoming departures.":"No upcoming commuter trains right now.",n.departuresEl.appendChild(y);return}d(c[0],s);let m=c.slice(1);if(m.length===0){let y=document.createElement("li");y.className="empty-row",y.textContent=M()?`No additional upcoming ${p().plural} right now.`:"No additional upcoming commuter trains right now.",n.departuresEl.appendChild(y);return}for(let y=0;y<m.length;y++){let g=m[y],b=document.createElement("li");b.className=`departure-row ${_(g.departureIso)}`,b.style.setProperty("--i",y);let Q=document.createElement("div");Q.className="letter-badge",Q.textContent=g.line||"?";let z=document.createElement("div");z.className="train";let ie=document.createElement("div");ie.className="destination",ie.textContent=g.destination||"\u2014",z.appendChild(ie);let ne=document.createElement("span");ne.className="track",M()?ne.textContent=`Stop ${U(s,g)}`:ne.textContent=g.track?`Track ${g.track}`:"Track \u2014",z.appendChild(ne);let oe=document.createElement("div");oe.className="time";let se=document.createElement("span");se.className="remaining",se.textContent=v(g.departureIso);let re=document.createElement("span");re.className="clock-time",re.textContent=new Date(g.departureIso).toLocaleTimeString([],{hour:"2-digit",minute:"2-digit",hour12:!1}),oe.appendChild(se),oe.appendChild(re),b.appendChild(Q),b.appendChild(z),b.appendChild(oe),n.departuresEl.appendChild(b)}}function R(){n.nowClockEl&&(n.nowClockEl.textContent=new Date().toLocaleTimeString([],{hour:"2-digit",minute:"2-digit",second:"2-digit",hour12:!1}))}Object.assign(o,{formatMinutes:v,minutesUntil:w,departureRowClass:_,isHelsinkiBound:E,sanitizeStopSelections:O,getVisibleDepartures:F,updateModeButtons:T,updateModeLabels:D,toggleResultsLimitDropdown:B,selectResultsLimit:j,renderResultsLimitControl:W,updateHelsinkiFilterButton:J,countActiveStopFilters:X,buildStopFilterSummary:P,syncStopFiltersPanelUi:H,setStopFiltersPanelOpen:Z,toggleStopFiltersPanel:ee,setStopControlsVisibility:te,getStopMeta:V,getStopCodes:q,buildStopDisplay:G,buildModeStopDisplay:U,updateDataScope:Y,renderFilterButtons:$,toggleStopDropdown:K,selectStop:a,renderStopControls:u,updateNextSummary:d,buildStatusFromResponse:S,getLoadErrorStatus:f,getGeolocationErrorStatus:t,getVoiceLocationErrorStatus:r,showSkeleton:L,hideSkeleton:C,render:k,updateClock:R})})();(()=>{let N=window.HMApp,{api:o,dom:n,state:e,constants:A}=N,{MODE_TRAM:x,MODE_METRO:I,MODE_BUS:l}=A;function h(a){return a===l||a===x||a===I}function M(a){return new Promise(u=>setTimeout(u,a))}async function p(a,u={},d=A.FETCH_TIMEOUT_MS){let S=new AbortController,f=setTimeout(()=>S.abort(),d);try{return await fetch(a,{...u,signal:S.signal})}finally{clearTimeout(f)}}async function v(a,u={}){let d;try{d=await p(a,u)}catch{return await M(350),p(a,u)}return d.status>=500?(await M(350),p(a,u)):d}function w(a){let u=new Map,d=new Map;for(let f of a||[]){let t=String(f?.line||"").trim();t&&u.set(t,(u.get(t)||0)+1);let r=String(f?.destination||"").trim();r&&d.set(r,(d.get(r)||0)+1)}let S=f=>[...f.entries()].sort((t,r)=>r[1]-t[1]||t[0].localeCompare(r[0])).map(([t,r])=>({value:t,count:r}));return{lines:S(u),destinations:S(d)}}function _(a){let u=Array.isArray(a?.stops)?a.stops.filter(t=>t&&t.id&&t.name).map(t=>({id:t.id,name:t.name,code:String(t.code||"").trim()||null,stopCodes:o.uniqueNonEmptyStrings([...Array.isArray(t.stopCodes)?t.stopCodes:[],t.code]),distanceMeters:Number(t.distanceMeters)||0})):[];e.busStops=u;let d=String(a?.selectedStopId||"").trim()||null,S=t=>u.some(r=>r.id===t);d&&S(d)?e.busStopId=d:(!e.busStopId||!S(e.busStopId))&&(e.busStopId=u[0]?.id||null),e.deferInitialStopContext&&(e.deferInitialStopContext=!1,e.deferredBusStopId=null,e.deferredBusLineFilters=[],e.deferredBusDestinationFilters=[],e.busLineFilters=[],e.busDestinationFilters=[]),e.hasCompletedInitialStopModeLoad=!0;let f=Array.isArray(a?.station?.departures)?a.station.departures:[];e.busFilterOptions=w(f),o.sanitizeStopSelections()}function E(a,u){let d=new Error(u);return d.code=a,d}function O(a){return String(a?.code||"").trim().toLowerCase()}function F(){return o.uniqueNonEmptyStrings(["fi-FI","en-US",...Array.isArray(navigator.languages)?navigator.languages:[],navigator.language])}function T(){return typeof window.SpeechRecognition=="function"?window.SpeechRecognition:typeof window.webkitSpeechRecognition=="function"?window.webkitSpeechRecognition:null}function D(){return!!T()}function B(a){return a==="not-allowed"||a==="service-not-allowed"?E("voice_permission_denied","Microphone permission denied."):a==="audio-capture"?E("voice_no_microphone","No microphone available."):a==="language-not-supported"?E("voice_language_not_supported","Speech language is not supported."):a==="network"?E("voice_recognition_network","Voice recognition network error."):a==="no-speech"?E("voice_no_speech","No speech detected."):E("voice_not_understood","Voice recognition failed.")}function j(a){let u=T();return u?new Promise((d,S)=>{let f=new u,t=String(a||navigator.language||"fi-FI").trim();f.lang=t||"fi-FI",f.continuous=!1,f.interimResults=!0,f.maxAlternatives=1;let r=!1,L="",C=null,k=!1,R=()=>{clearTimeout(C),C=null},i=()=>{if(!(k||r)){k=!0;try{f.stop()}catch{}}},s=()=>{R(),C=setTimeout(i,A.VOICE_SILENCE_STOP_MS)},c=()=>{clearTimeout(y),R(),f.onresult=null,f.onerror=null,f.onend=null,f.onspeechend=null,f.onsoundend=null,f.onaudioend=null,f.onnomatch=null},m=(g,b)=>{r||(r=!0,c(),g(b))},y=setTimeout(()=>{try{f.abort()}catch{}m(S,E("voice_recognition_timeout","Voice recognition timed out."))},A.VOICE_RECOGNITION_TIMEOUT_MS);f.onresult=g=>{for(let b=g?.resultIndex||0;b<(g?.results?.length||0);b+=1){let Q=g.results[b],z=String(Q?.[0]?.transcript||"").trim();if(z&&(L=z,s(),Q?.isFinal)){i();return}}},f.onerror=g=>{let b=String(g?.error||"").trim().toLowerCase();m(S,B(b))},f.onend=()=>{if(r)return;let g=String(L||"").trim();if(!g){m(S,E("voice_no_speech","No speech detected."));return}m(d,g)},f.onspeechend=()=>{i()},f.onsoundend=()=>{s()},f.onaudioend=()=>{s()},f.onnomatch=()=>{m(S,E("voice_not_understood","Could not understand speech."))};try{f.start()}catch(g){let b=String(g?.name||"").trim().toLowerCase();if(b==="notallowederror"||b==="securityerror"){m(S,E("voice_permission_denied","Microphone permission denied."));return}m(S,E("voice_not_understood","Unable to start voice recognition."))}}):Promise.reject(E("voice_unsupported","Voice recognition not supported."))}function W(a){return a==="voice_no_speech"||a==="voice_not_understood"||a==="voice_recognition_timeout"||a==="voice_language_not_supported"}async function J(){let a=F(),u=null;for(let d of a)try{return await j(d)}catch(S){if(u=S,!W(O(S)))break}throw u||E("voice_not_understood","Voice recognition failed.")}function X(a){return Array.isArray(a)?a.map(u=>{let d=Number(u?.lat),S=Number(u?.lon);return!Number.isFinite(d)||!Number.isFinite(S)?null:{lat:d,lon:S,label:String(u?.label||"").trim()}}).filter(Boolean):[]}function P(){n.voiceLocationChoicesEl&&n.voiceLocationChoicesEl.classList.add("hidden"),n.voiceLocationChoicesTitleEl&&(n.voiceLocationChoicesTitleEl.textContent=""),n.voiceLocationChoicesOptionsEl&&(n.voiceLocationChoicesOptionsEl.innerHTML=""),n.voiceLocationChoicesCancelEl&&(n.voiceLocationChoicesCancelEl.onclick=null)}function H(a,u){if(typeof window.prompt!="function")throw E("voice_location_selection_cancelled","Location selection was cancelled.");let d=u.map((t,r)=>`${r+1}. ${t.label||`${t.lat}, ${t.lon}`}`).join(`
`),S=window.prompt(`Multiple matches found for "${o.safeString(a,80)}". Select number:
${d}`,"1");if(S==null)throw E("voice_location_selection_cancelled","Location selection was cancelled.");let f=Number.parseInt(String(S).trim(),10);if(!Number.isInteger(f)||f<1||f>u.length)throw E("voice_location_selection_invalid","Invalid location selection.");return u[f-1]}async function Z(a,u){if(!Array.isArray(u)||u.length===0)throw E("voice_location_not_found","No matching location found.");return!n.voiceLocationChoicesEl||!n.voiceLocationChoicesTitleEl||!n.voiceLocationChoicesOptionsEl||!n.voiceLocationChoicesCancelEl?H(a,u):new Promise((d,S)=>{let f=!1,t=(r,L)=>{f||(f=!0,P(),r(L))};n.voiceLocationChoicesTitleEl.textContent=`Multiple matches for "${o.safeString(a,80)}". Choose one:`,o.setStatus("Multiple matches found. Choose one below."),n.voiceLocationChoicesOptionsEl.innerHTML="";for(let r of u){let L=document.createElement("button");L.type="button",L.className="voice-location-choice-option",L.textContent=r.label||`${r.lat.toFixed(5)}, ${r.lon.toFixed(5)}`,L.addEventListener("click",()=>t(d,r),{once:!0}),n.voiceLocationChoicesOptionsEl.appendChild(L)}n.voiceLocationChoicesCancelEl.onclick=()=>t(S,E("voice_location_selection_cancelled","Location selection was cancelled.")),n.voiceLocationChoicesEl.classList.remove("hidden")})}async function ee(a){let u=String(a||"").trim();if(u.length<A.VOICE_QUERY_MIN_LENGTH)throw E("voice_query_too_short","Voice query too short.");let d=new URLSearchParams({text:u});e.currentCoords&&(d.set("lat",String(e.currentCoords.lat)),d.set("lon",String(e.currentCoords.lon)));let S=Array.isArray(navigator.languages)&&navigator.languages[0]||navigator.language||"";S&&d.set("lang",String(S));let f;try{f=await v(`/api/v1/geocode?${d.toString()}`)}catch{throw E("voice_geocode_failed","Location lookup failed.")}if(!(f.headers.get("content-type")||"").includes("application/json"))throw E("voice_geocode_failed","Unexpected location lookup response.");let r=await f.json();if(!f.ok)throw E("voice_geocode_failed",String(r?.error||"Location lookup failed.").trim());let L=X(r?.choices);if(r?.ambiguous&&L.length>1){let R=await Z(u,L);return{lat:R.lat,lon:R.lon,label:R.label,query:u}}let C=Number(r?.location?.lat),k=Number(r?.location?.lon);if(!Number.isFinite(C)||!Number.isFinite(k))throw E("voice_location_not_found","No matching location found.");return{lat:C,lon:k,label:String(r?.location?.label||"").trim(),query:u}}function te(a){return a==="voice_unsupported"||a==="voice_no_speech"||a==="voice_recognition_timeout"||a==="voice_recognition_network"||a==="voice_not_understood"}function V(a){if(!te(a)||typeof window.prompt!="function")return null;let u=a==="voice_unsupported"?"Voice input is limited in this browser. Type your location instead:":"Could not capture your voice on this device. Type your location:",d=window.prompt(`${u}
Example: Kamppi Helsinki`,"");return String(d||"").trim()||null}async function q(a){let u=String(a||"").trim();P(),o.setStatus(`Looking up "${o.safeString(u,80)}"...`);let d=await ee(u);return o.setResolvedLocationHint({query:u,label:d.label,lat:d.lat,lon:d.lon}),e.currentCoords={lat:d.lat,lon:d.lon},o.setPermissionRequired(!1),await U(d.lat,d.lon),!0}async function G(){if(e.isLoading||e.isVoiceListening)return!1;P(),o.setVoiceListening(!0),o.setStatus("Listening... speak now, then pause.");try{if(!D()){let u=E("voice_unsupported","Voice recognition not supported."),d=V(O(u));return d?q(d):(o.setStatus(o.getVoiceLocationErrorStatus(u)),!1)}let a=await J();return q(a)}catch(a){let u=O(a),d=V(u);if(d)try{return await q(d)}catch(S){return console.error("voice fallback location error:",S),o.reportClientError("voice-location-fallback",S,{mode:e.mode,sourceCode:u||"unknown"}),o.setStatus(o.getVoiceLocationErrorStatus(S)),!1}return(!u||u==="unknown")&&console.error("voice location error:",a),o.reportClientError("voice-location",a,{mode:e.mode,code:u||"unknown"}),o.setStatus(o.getVoiceLocationErrorStatus(a)),!1}finally{o.setVoiceListening(!1)}}async function U(a,u){let d=++e.latestLoadToken,S=e.mode,f=e.busStopId,t=h(S)&&!e.hasCompletedInitialStopModeLoad;o.setLoading(!0),o.setStatus("Loading departures...");try{let r=new URLSearchParams({lat:String(a),lon:String(u),mode:S.toUpperCase(),results:String(o.getActiveResultsLimit(S))}),L=h(S)&&(e.deferInitialStopContext||!e.hasCompletedInitialStopModeLoad);h(S)&&f&&!L&&r.set("stopId",f);let C=await v(`/api/v1/departures?${r.toString()}`);if(!(C.headers.get("content-type")||"").includes("application/json"))throw C.ok?new Error("Unexpected server response."):new Error("Request failed");let R=await C.json();if(!C.ok)throw new Error(R.error||"Request failed");if(d!==e.latestLoadToken)return;h(S)&&(_(R),o.persistUiState(),t&&o.trackInitialNearestStopResolved(R,S)),e.latestResponse=R,o.render(R),o.setPermissionRequired(!1),o.setLastUpdated(new Date),o.setStatus(o.buildStatusFromResponse(R)),o.trackFirstSuccessfulRender(R,S)}catch(r){if(d!==e.latestLoadToken)return;e.latestResponse=null,console.error("load departures error:",r),o.reportClientError("load",r,{mode:S}),o.setStatus(o.getLoadErrorStatus(r)),n.resultEl.classList.add("hidden"),o.updateNextSummary(null)}finally{d===e.latestLoadToken&&o.setLoading(!1)}}function Y(){return P(),o.setResolvedLocationHint(null),navigator.geolocation?e.isLoading||e.isVoiceListening?!1:(o.setStatus("Getting your location..."),o.setLoading(!0),navigator.geolocation.getCurrentPosition(a=>{e.currentCoords={lat:a.coords.latitude,lon:a.coords.longitude},o.setPermissionRequired(!1),o.setLoading(!1),U(e.currentCoords.lat,e.currentCoords.lon)},a=>{if(o.setLoading(!1),a.code===1){o.setPermissionRequired(!0),o.setStatus(o.getGeolocationErrorStatus(a)),e.latestResponse=null,n.resultEl.classList.add("hidden"),o.updateNextSummary(null);return}o.setPermissionRequired(!1),o.setStatus(o.getGeolocationErrorStatus(a)),e.latestResponse=null,n.resultEl.classList.add("hidden"),o.updateNextSummary(null)},{enableHighAccuracy:!1,timeout:1e4,maximumAge:0}),!0):(o.setStatus("Geolocation not supported in this browser."),o.setPermissionRequired(!0),!1)}function $(){if(!e.isVoiceListening){if(e.currentCoords){U(e.currentCoords.lat,e.currentCoords.lon);return}Y()}}function K(){o.updateModeButtons(),o.updateModeLabels(),o.renderResultsLimitControl(),o.updateHelsinkiFilterButton(),o.renderStopControls(),o.updateDataScope(e.latestResponse)}Object.assign(o,{delay:M,fetchWithTimeout:p,fetchWithRetryOnce:v,updateStopModeStateFromResponse:_,buildFilterOptionsFromDepartures:w,load:U,requestLocationAndLoad:Y,requestVoiceLocationAndLoad:G,supportsVoiceLocation:D,captureVoiceQuery:j,captureVoiceQueryWithRetry:J,getVoiceRecognitionLanguages:F,shouldRetryVoiceRecognition:W,resolveVoiceLocationQuery:ee,refreshDeparturesOnly:$,applyModeUiState:K})})();(()=>{let N=window.HMApp,{api:o,dom:n,state:e,constants:A}=N,{MODE_RAIL:x,MODE_TRAM:I,MODE_METRO:l,MODE_BUS:h}=A;function M(){if(e.currentCoords){o.load(e.currentCoords.lat,e.currentCoords.lon);return}o.requestLocationAndLoad()}n.locateBtn?.addEventListener("click",()=>{o.trackFirstManualInteraction("refresh_location_click"),o.requestLocationAndLoad()}),n.voiceLocateBtn?.addEventListener("click",()=>{o.trackFirstManualInteraction("voice_location_click"),o.requestVoiceLocationAndLoad()}),n.modeRailBtn?.addEventListener("click",()=>{e.mode!==x&&(o.trackFirstManualInteraction("mode_change",{toMode:x}),e.mode=x,o.applyModeUiState(),o.persistUiState(),M())}),n.modeTramBtn?.addEventListener("click",()=>{e.mode!==I&&(o.trackFirstManualInteraction("mode_change",{toMode:I}),e.mode=I,e.helsinkiOnly=!1,o.applyModeUiState(),o.persistUiState(),M())}),n.modeMetroBtn?.addEventListener("click",()=>{e.mode!==l&&(o.trackFirstManualInteraction("mode_change",{toMode:l}),e.mode=l,e.helsinkiOnly=!1,o.applyModeUiState(),o.persistUiState(),M())}),n.modeBusBtn?.addEventListener("click",()=>{e.mode!==h&&(o.trackFirstManualInteraction("mode_change",{toMode:h}),e.mode=h,e.helsinkiOnly=!1,o.applyModeUiState(),o.persistUiState(),M())}),n.resultsLimitSelectEl?.addEventListener("click",p=>{p.stopPropagation(),o.toggleResultsLimitDropdown()}),document.addEventListener("click",p=>{n.resultsLimitSelectWrapEl&&(n.resultsLimitSelectWrapEl.contains(p.target)||o.toggleResultsLimitDropdown(!1))}),n.resultsLimitSelectEl?.addEventListener("keydown",p=>{let v=n.resultsLimitSelectListEl;if(!v)return;let w=n.resultsLimitSelectEl.getAttribute("aria-expanded")==="true";if(p.key==="Escape"){o.toggleResultsLimitDropdown(!1),n.resultsLimitSelectEl.focus(),p.preventDefault();return}if(p.key==="Enter"||p.key===" "){if(!w){o.toggleResultsLimitDropdown(!0),p.preventDefault();return}let _=v.querySelector(".is-focused");_?.dataset?.value&&o.selectResultsLimit(_.dataset.value),p.preventDefault();return}if(p.key==="ArrowDown"||p.key==="ArrowUp"){if(p.preventDefault(),!w){o.toggleResultsLimitDropdown(!0);return}let _=[...v.querySelectorAll("li[role='option']")];if(_.length===0)return;let E=_.findIndex(F=>F.classList.contains("is-focused")),O;p.key==="ArrowDown"?O=E<_.length-1?E+1:0:O=E>0?E-1:_.length-1;for(let F of _)F.classList.remove("is-focused");_[O].classList.add("is-focused"),_[O].scrollIntoView({block:"nearest"})}}),n.busStopSelectEl?.addEventListener("click",p=>{p.stopPropagation(),o.toggleStopDropdown()}),document.addEventListener("click",p=>{n.busStopSelectWrapEl&&(n.busStopSelectWrapEl.contains(p.target)||o.toggleStopDropdown(!1))}),n.busStopSelectEl?.addEventListener("keydown",p=>{let v=n.busStopSelectListEl;if(!v)return;let w=n.busStopSelectEl.getAttribute("aria-expanded")==="true";if(p.key==="Escape"){o.toggleStopDropdown(!1),n.busStopSelectEl.focus(),p.preventDefault();return}if(p.key==="Enter"||p.key===" "){if(!w){o.toggleStopDropdown(!0),p.preventDefault();return}let _=v.querySelector(".is-focused");_?.dataset?.value&&o.selectStop(_.dataset.value),p.preventDefault();return}if(p.key==="ArrowDown"||p.key==="ArrowUp"){if(p.preventDefault(),!w){o.toggleStopDropdown(!0);return}let _=[...v.querySelectorAll("li[role='option']")];if(_.length===0)return;let E=_.findIndex(F=>F.classList.contains("is-focused")),O;p.key==="ArrowDown"?O=E<_.length-1?E+1:0:O=E>0?E-1:_.length-1;for(let F of _)F.classList.remove("is-focused");_[O].classList.add("is-focused"),_[O].scrollIntoView({block:"nearest"})}}),n.stopFiltersToggleBtnEl?.addEventListener("click",()=>{o.trackFirstManualInteraction("stop_filters_panel_toggle",{currentMode:e.mode}),o.toggleStopFiltersPanel()}),n.helsinkiOnlyBtn?.addEventListener("click",()=>{e.mode===x&&(o.trackFirstManualInteraction("helsinki_only_toggle"),e.helsinkiOnly=!e.helsinkiOnly,o.persistUiState(),o.updateHelsinkiFilterButton(),e.latestResponse&&(o.render(e.latestResponse),o.setStatus(o.buildStatusFromResponse(e.latestResponse))))}),o.hydrateInitialState(),o.applyModeUiState(),o.updateClock(),setInterval(o.updateClock,1e3),o.requestLocationAndLoad(),setInterval(o.refreshDeparturesOnly,3e4),window.addEventListener("error",p=>{o.reportClientError("error",p.error||p.message||"Unknown error",{source:p.filename||"",line:p.lineno||null,column:p.colno||null})}),window.addEventListener("unhandledrejection",p=>{o.reportClientError("unhandledrejection",p.reason||"Unhandled promise rejection")}),(()=>{let p=document.getElementById("themeToggle");if(!p)return;let v=document.documentElement,w=window.matchMedia("(prefers-color-scheme: dark)"),_=()=>{let T=o.getStorageItem("theme");return T==="dark"||T==="light"?T:null},E=T=>{v.setAttribute("data-theme",T==="light"?"light":"dark")},O=()=>{let T=_();if(T){E(T);return}E(w.matches?"dark":"light")},F=T=>{_()||E(T.matches?"dark":"light")};O(),typeof w.addEventListener=="function"?w.addEventListener("change",F):typeof w.addListener=="function"&&w.addListener(F),p.addEventListener("click",()=>{let T=v.getAttribute("data-theme")==="dark"?"light":"dark";E(T),o.setStorageItem("theme",T)})})()})();})();
