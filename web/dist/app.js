(()=>{(()=>{let O=window.HMApp||(window.HMApp={}),s=O.api||={};O.dom={locateBtn:document.getElementById("locateBtn"),modeRailBtn:document.getElementById("modeRailBtn"),modeBusBtn:document.getElementById("modeBusBtn"),helsinkiOnlyBtn:document.getElementById("helsinkiOnlyBtn"),busControlsEl:document.getElementById("busControls"),busStopSelectEl:document.getElementById("busStopSelect"),busLineFiltersEl:document.getElementById("busLineFilters"),busDestinationFiltersEl:document.getElementById("busDestinationFilters"),resultsLimitSelectEl:document.getElementById("resultsLimitSelect"),modeEyebrowEl:document.getElementById("modeEyebrow"),statusEl:document.getElementById("status"),dataScopeEl:document.getElementById("dataScope"),resultEl:document.getElementById("result"),permissionCardEl:document.getElementById("permissionCard"),stationTitleEl:document.getElementById("stationTitle"),stationMetaEl:document.getElementById("stationMeta"),departuresEl:document.getElementById("departures"),nextSummaryEl:document.getElementById("nextSummary"),nextLabelEl:document.getElementById("nextLabel"),nextMinsEl:document.getElementById("nextMins"),nextLineEl:document.getElementById("nextLine"),nextTrackEl:document.getElementById("nextTrack"),nextDestinationEl:document.getElementById("nextDestination"),nowClockEl:document.getElementById("nowClock"),lastUpdatedEl:document.getElementById("lastUpdated")},O.constants={MODE_RAIL:"rail",MODE_BUS:"bus",STORAGE_MODE_KEY:"prefs:mode",STORAGE_HELSINKI_ONLY_KEY:"prefs:helsinkiOnly",STORAGE_BUS_STOP_KEY:"prefs:busStopId",STORAGE_BUS_LINES_KEY:"prefs:busLines",STORAGE_BUS_DESTINATIONS_KEY:"prefs:busDestinations",STORAGE_RESULTS_LIMIT_RAIL_KEY:"prefs:resultsLimitRail",STORAGE_RESULTS_LIMIT_BUS_KEY:"prefs:resultsLimitBus",DEFAULT_RESULTS_LIMIT_RAIL:8,DEFAULT_RESULTS_LIMIT_BUS:24,RESULT_LIMIT_OPTIONS:[8,12,16,20,24,30],FETCH_TIMEOUT_MS:8e3,ERROR_REPORT_LIMIT:5};let{MODE_RAIL:n,MODE_BUS:t}=O.constants;O.state={isLoading:!1,currentCoords:null,latestResponse:null,mode:n,helsinkiOnly:!1,busStopId:null,busLineFilters:[],busDestinationFilters:[],resultsLimitByMode:{[n]:O.constants.DEFAULT_RESULTS_LIMIT_RAIL,[t]:O.constants.DEFAULT_RESULTS_LIMIT_BUS},busStops:[],busFilterOptions:{lines:[],destinations:[]},suppressBusStopChange:!1,errorReportCount:0,latestLoadToken:0};let{dom:T,state:l,constants:u}=O;function R(i){l.isLoading=i,T.locateBtn&&(T.locateBtn.disabled=i)}function f(i){T.statusEl&&(T.statusEl.textContent=i)}function k(i){T.permissionCardEl&&T.permissionCardEl.classList.toggle("hidden",!i)}function _(i){!T.lastUpdatedEl||!(i instanceof Date)||(T.lastUpdatedEl.textContent=`Last updated: ${i.toLocaleTimeString([],{hour:"2-digit",minute:"2-digit",second:"2-digit",hour12:!1})}`)}function C(i){try{return window.localStorage.getItem(i)}catch{return null}}function b(i,m){try{window.localStorage.setItem(i,m)}catch{}}function w(i,m){let B=String(i||"");return B.length<=m?B:B.slice(0,m)}function M(i){if(i instanceof Error)return i;try{let m=typeof i=="string"?i:JSON.stringify(i);return new Error(m||"Unknown error")}catch{return new Error(String(i||"Unknown error"))}}function a(i,m,B=null){if(l.errorReportCount>=u.ERROR_REPORT_LIMIT)return;l.errorReportCount+=1;let e=M(m),o={type:w(i,40),message:w(e.message,400),stack:w(e.stack||"",1200),url:w(window.location.href,500),userAgent:w(navigator.userAgent||"",300),timestamp:new Date().toISOString(),context:B&&typeof B=="object"?B:null},r=JSON.stringify(o);if(navigator.sendBeacon){let p=new Blob([r],{type:"application/json"});navigator.sendBeacon("/api/v1/client-error",p);return}fetch("/api/v1/client-error",{method:"POST",headers:{"content-type":"application/json"},body:r,keepalive:!0}).catch(()=>{})}function L(i){if(!i)return null;let m=String(i).trim().toLowerCase();return m===n||m===t?m:null}function E(i){if(i==null)return null;let m=String(i).trim().toLowerCase();return["1","true","yes","on"].includes(m)?!0:["0","false","no","off"].includes(m)?!1:null}function g(i){return Array.isArray(i)?[...new Set(i.map(m=>String(m||"").trim()).filter(Boolean))]:[]}function h(i){if(i==null||i==="")return null;let m=Number(i);return!Number.isInteger(m)||!u.RESULT_LIMIT_OPTIONS.includes(m)?null:m}function c(i=l.mode){return i===t?u.DEFAULT_RESULTS_LIMIT_BUS:u.DEFAULT_RESULTS_LIMIT_RAIL}function y(i=l.mode){let m=h(l.resultsLimitByMode?.[i]);return m??c(i)}function U(i){let m=C(i);if(!m)return[];try{let B=JSON.parse(m);return g(B)}catch{return[]}}function A(){let i=new URLSearchParams(window.location.search);return{mode:L(i.get("mode")),helsinkiOnly:E(i.get("helsinkiOnly")),stopProvided:i.has("stop"),busStopId:i.get("stop")?i.get("stop").trim():null,linesProvided:i.has("line"),busLines:g(i.getAll("line")),destinationsProvided:i.has("dest"),busDestinations:g(i.getAll("dest")),resultsProvided:i.has("results"),resultsLimit:h(i.get("results"))}}function F(){let i=A(),m=L(C(u.STORAGE_MODE_KEY)),B=E(C(u.STORAGE_HELSINKI_ONLY_KEY));l.mode=i.mode||m||n,l.helsinkiOnly=i.helsinkiOnly??B??!1,l.mode!==n&&(l.helsinkiOnly=!1);let e=String(C(u.STORAGE_BUS_STOP_KEY)||"").trim()||null;l.busStopId=i.stopProvided?i.busStopId:e;let o=U(u.STORAGE_BUS_LINES_KEY),r=U(u.STORAGE_BUS_DESTINATIONS_KEY);l.busLineFilters=i.linesProvided?i.busLines:o,l.busDestinationFilters=i.destinationsProvided?i.busDestinations:r;let p=h(C(u.STORAGE_RESULTS_LIMIT_RAIL_KEY)),S=h(C(u.STORAGE_RESULTS_LIMIT_BUS_KEY));l.resultsLimitByMode[n]=p??u.DEFAULT_RESULTS_LIMIT_RAIL,l.resultsLimitByMode[t]=S??u.DEFAULT_RESULTS_LIMIT_BUS,i.resultsProvided&&i.resultsLimit!=null&&(l.resultsLimitByMode[l.mode]=i.resultsLimit)}function D(){b(u.STORAGE_MODE_KEY,l.mode),b(u.STORAGE_HELSINKI_ONLY_KEY,l.helsinkiOnly?"1":"0"),b(u.STORAGE_BUS_STOP_KEY,l.busStopId||""),b(u.STORAGE_BUS_LINES_KEY,JSON.stringify(l.busLineFilters)),b(u.STORAGE_BUS_DESTINATIONS_KEY,JSON.stringify(l.busDestinationFilters)),b(u.STORAGE_RESULTS_LIMIT_RAIL_KEY,String(y(n))),b(u.STORAGE_RESULTS_LIMIT_BUS_KEY,String(y(t)))}function $(){let i=new URLSearchParams(window.location.search);l.mode===n?i.delete("mode"):i.set("mode",l.mode),l.mode===n&&l.helsinkiOnly?i.set("helsinkiOnly","1"):i.delete("helsinkiOnly");let m=y(),B=c();if(m===B?i.delete("results"):i.set("results",String(m)),i.delete("stop"),i.delete("line"),i.delete("dest"),l.mode===t){l.busStopId&&i.set("stop",l.busStopId);for(let r of l.busLineFilters)i.append("line",r);for(let r of l.busDestinationFilters)i.append("dest",r)}let e=i.toString(),o=`${window.location.pathname}${e?`?${e}`:""}${window.location.hash}`;window.history.replaceState(null,"",o)}function G(){D(),$()}Object.assign(s,{setLoading:R,setStatus:f,setPermissionRequired:k,setLastUpdated:_,getStorageItem:C,setStorageItem:b,safeString:w,toError:M,reportClientError:a,normalizeMode:L,parseBoolean:E,uniqueNonEmptyStrings:g,parseResultLimit:h,getDefaultResultsLimit:c,getActiveResultsLimit:y,parseStoredArray:U,readStateFromUrl:A,hydrateInitialState:F,syncStateToStorage:D,syncStateToUrl:$,persistUiState:G})})();(()=>{let O=window.HMApp,{api:s,dom:n,state:t,constants:T}=O,{MODE_RAIL:l,MODE_BUS:u}=T;function R(e){let o=f(e);return o<=0?"Now":`${o}m`}function f(e){let o=new Date(e);return Math.floor((o.getTime()-Date.now())/6e4)}function k(e){let o=f(e);return o<=0||o<5?"departure-now":o<=15?"departure-soon":"departure-later"}function _(e){let o=e?.destination||"";return/\bhelsinki\b/i.test(o)}function C(){let e=new Set((t.busFilterOptions.lines||[]).map(r=>r.value)),o=new Set((t.busFilterOptions.destinations||[]).map(r=>r.value));t.busLineFilters=t.busLineFilters.filter(r=>e.has(r)),t.busDestinationFilters=t.busDestinationFilters.filter(r=>o.has(r))}function b(e){if(!Array.isArray(e))return[];if(t.mode===l)return t.helsinkiOnly?e.filter(_):e;let o=new Set(t.busLineFilters),r=new Set(t.busDestinationFilters);return e.filter(p=>{if(o.size===0)return!0;let S=String(p?.line||"").trim();return o.has(S)}).filter(p=>{if(r.size===0)return!0;let S=String(p?.destination||"").trim();return r.has(S)})}function w(){if(n.modeRailBtn){let e=t.mode===l;n.modeRailBtn.setAttribute("aria-pressed",String(e)),n.modeRailBtn.classList.toggle("is-active",e)}if(n.modeBusBtn){let e=t.mode===u;n.modeBusBtn.setAttribute("aria-pressed",String(e)),n.modeBusBtn.classList.toggle("is-active",e)}}function M(){n.modeEyebrowEl&&(n.modeEyebrowEl.textContent=t.mode===u?"Helsinki Moves \u2022 Bus":"Helsinki Moves \u2022 Rail"),n.nextLabelEl&&(n.nextLabelEl.textContent=t.mode===u?"Next Bus":"Next Train")}function a(){if(!n.resultsLimitSelectEl)return;let e=Array.isArray(T.RESULT_LIMIT_OPTIONS)?T.RESULT_LIMIT_OPTIONS:[],o=s.getActiveResultsLimit();n.resultsLimitSelectEl.innerHTML="";for(let r of e){let p=document.createElement("option");p.value=String(r),p.textContent=`${r}`,n.resultsLimitSelectEl.appendChild(p)}n.resultsLimitSelectEl.value=String(o)}function L(){if(n.helsinkiOnlyBtn){if(t.mode!==l){n.helsinkiOnlyBtn.setAttribute("aria-pressed","false"),n.helsinkiOnlyBtn.classList.remove("is-active"),n.helsinkiOnlyBtn.disabled=!0,n.helsinkiOnlyBtn.textContent="Helsinki Only (Rail)";return}n.helsinkiOnlyBtn.disabled=!1,n.helsinkiOnlyBtn.setAttribute("aria-pressed",String(t.helsinkiOnly)),n.helsinkiOnlyBtn.classList.toggle("is-active",t.helsinkiOnly),n.helsinkiOnlyBtn.textContent=t.helsinkiOnly?"Helsinki Only: On":"Helsinki Only: Off"}}function E(e){n.busControlsEl&&n.busControlsEl.classList.toggle("hidden",!e)}function g(e){return t.busStops.find(o=>o.id===e)||null}function h(e){let o=s.uniqueNonEmptyStrings([...Array.isArray(e?.stopCodes)?e.stopCodes:[],e?.code]);return o.length===0&&e?.id&&o.push(String(e.id)),o}function c(e,o=null){let r=g(t.busStopId),p=String(o?.stopName||e?.stopName||r?.name||"").trim(),d=s.uniqueNonEmptyStrings([o?.stopCode,...Array.isArray(e?.stopCodes)?e.stopCodes:[],e?.stopCode,...h(r)])[0]||"";return p&&d?`${p} ${d}`:p||d||"\u2014"}function y(e){if(!n.dataScopeEl)return;if(t.mode!==u){n.dataScopeEl.classList.add("hidden"),n.dataScopeEl.textContent="";return}let o=String(e?.station?.stopName||g(t.busStopId)?.name||"").trim(),p=s.uniqueNonEmptyStrings([...Array.isArray(e?.station?.stopCodes)?e.station.stopCodes:[],e?.station?.stopCode,...h(g(t.busStopId))]).join(", "),S=t.busLineFilters.length===0?"all lines":`${t.busLineFilters.length} line${t.busLineFilters.length===1?"":"s"} selected`,d=t.busDestinationFilters.length===0?"all destinations":`${t.busDestinationFilters.length} destination${t.busDestinationFilters.length===1?"":"s"} selected`,I=`${s.getActiveResultsLimit()} results`;o?n.dataScopeEl.textContent=`Selected stop ${o} (${p||"\u2014"}) - ${S}, ${d}, ${I}`:n.dataScopeEl.textContent=`Selecting stop... (${S}, ${d}, ${I})`,n.dataScopeEl.classList.remove("hidden")}function U(e,o,r,p){if(!e)return;if(e.innerHTML="",!Array.isArray(o)||o.length===0){let d=document.createElement("span");d.className="chip-empty",d.textContent="No options",e.appendChild(d);return}let S=new Set(r);for(let d of o){let I=document.createElement("button");I.type="button",I.className="chip-toggle",S.has(d.value)?(I.classList.add("is-active"),I.setAttribute("aria-pressed","true")):I.setAttribute("aria-pressed","false"),I.textContent=`${d.value} (${d.count})`,I.addEventListener("click",()=>p(d.value)),e.appendChild(I)}}function A(){let e=t.mode===u;if(E(e),!!e){if(n.busStopSelectEl){if(t.suppressBusStopChange=!0,n.busStopSelectEl.innerHTML="",t.busStops.length===0){let o=document.createElement("option");o.value="",o.textContent="No nearby bus stops",n.busStopSelectEl.appendChild(o),n.busStopSelectEl.disabled=!0}else{n.busStopSelectEl.disabled=!1;for(let o of t.busStops){let r=document.createElement("option");r.value=o.id,r.textContent=`${o.name} (${o.distanceMeters}m)`,n.busStopSelectEl.appendChild(r)}t.busStopId&&t.busStops.some(o=>o.id===t.busStopId)?n.busStopSelectEl.value=t.busStopId:n.busStopSelectEl.value=t.busStops[0].id}t.suppressBusStopChange=!1}U(n.busLineFiltersEl,t.busFilterOptions.lines,t.busLineFilters,o=>{t.busLineFilters.includes(o)?t.busLineFilters=t.busLineFilters.filter(r=>r!==o):t.busLineFilters=[...t.busLineFilters,o],s.persistUiState(),t.latestResponse&&(s.render(t.latestResponse),s.setStatus(s.buildStatusFromResponse(t.latestResponse)))}),U(n.busDestinationFiltersEl,t.busFilterOptions.destinations,t.busDestinationFilters,o=>{t.busDestinationFilters.includes(o)?t.busDestinationFilters=t.busDestinationFilters.filter(r=>r!==o):t.busDestinationFilters=[...t.busDestinationFilters,o],s.persistUiState(),t.latestResponse&&(s.render(t.latestResponse),s.setStatus(s.buildStatusFromResponse(t.latestResponse)))})}}function F(e,o=null){if(!n.nextSummaryEl||!n.nextMinsEl||!n.nextLineEl||!n.nextTrackEl||!n.nextDestinationEl)return;if(!e){n.nextSummaryEl.classList.add("hidden"),n.nextSummaryEl.classList.remove("next-summary-now","next-summary-soon","next-summary-later");return}let r=f(e.departureIso);n.nextMinsEl.textContent=R(e.departureIso),n.nextLineEl.textContent=e.line||"\u2014",n.nextLineEl.classList.toggle("next-letter-now",r<5),n.nextTrackEl.textContent=t.mode===u?`Stop ${c(o,e)}`:e.track?`Track ${e.track}`:"Track \u2014",n.nextDestinationEl.textContent=e.destination||"\u2014",n.nextSummaryEl.classList.remove("next-summary-now","next-summary-soon","next-summary-later"),r<5?n.nextSummaryEl.classList.add("next-summary-now"):r<=15?n.nextSummaryEl.classList.add("next-summary-soon"):n.nextSummaryEl.classList.add("next-summary-later"),n.nextSummaryEl.classList.remove("hidden")}function D(e){if(!e||!e.station)return t.mode===u?e?.message||"No nearby bus stops found.":e?.message||"No nearby train stations found.";let r=b(e.station.departures)[0];if(!r)return t.mode===u?t.busLineFilters.length>0||t.busDestinationFilters.length>0?"No upcoming buses match selected filters.":"No upcoming buses right now.":t.helsinkiOnly?"No Helsinki-bound trains in upcoming departures.":"No upcoming commuter trains right now.";let p=r.destination?` \u2022 ${r.destination}`:"",S=t.mode===l?r.track?` \u2022 Track ${r.track}`:"":e.station.stopName||e.station.stopCode?` \u2022 ${c(e.station)}`:"",d=t.mode===u?"bus":"train";return`Next ${r.line||d} in ${R(r.departureIso)}${p}${S}`}function $(e){if(!(e instanceof Error))return"Could not refresh departures. Please try again.";if(e.name==="AbortError")return"Request timed out. Please try again.";let o=(e.message||"").trim();return o==="Temporary server error. Please try again."?o:o==="Invalid lat/lon"?"Location coordinates were invalid. Please refresh your location.":o==="Invalid mode"?"Unsupported transport mode.":"Could not refresh departures. Please try again."}function G(e){return e?.code===1?"Location permission denied.":e?.code===2?"Location unavailable. Please try again.":e?.code===3?"Location request timed out. Please try again.":"Unable to get your location."}function i(){let e=[...document.querySelectorAll(".departure-row .train-top")];if(e.length===0)return;let o=e.map(d=>d.querySelector(".destination")).filter(Boolean);for(let d of o)d.style.width="auto";let r=0;for(let d of o)r=Math.max(r,Math.ceil(d.scrollWidth));let p=Number.POSITIVE_INFINITY;for(let d of e){let I=d.querySelector(".time");if(!I)continue;let N=getComputedStyle(d),v=parseFloat(N.columnGap||N.gap||"0")||0,x=d.clientWidth-I.offsetWidth-v;x>0&&(p=Math.min(p,x))}let S=Math.max(0,Math.min(r,p));for(let d of o)d.style.width=`${S}px`}function m(e){if(A(),y(e),!e||!e.station){n.resultEl.classList.add("hidden"),F(null);return}let o=e.station;n.resultEl.classList.remove("hidden"),n.stationTitleEl.textContent=o.stopName,n.stationMetaEl.textContent=`${o.distanceMeters}m away`,n.departuresEl.innerHTML="";let r=b(o.departures);if(r.length===0){F(null);let S=document.createElement("li");S.className="empty-row",t.mode===u?S.textContent=t.busLineFilters.length>0||t.busDestinationFilters.length>0?"No upcoming buses match selected filters.":"No upcoming buses right now.":S.textContent=t.helsinkiOnly?"No Helsinki-bound trains in upcoming departures.":"No upcoming commuter trains right now.",n.departuresEl.appendChild(S);return}F(r[0],o);let p=r.slice(1);if(p.length===0){let S=document.createElement("li");S.className="empty-row",S.textContent=t.mode===u?"No additional upcoming buses right now.":"No additional upcoming commuter trains right now.",n.departuresEl.appendChild(S);return}for(let S=0;S<p.length;S++){let d=p[S],I=document.createElement("li");I.className=`departure-row ${k(d.departureIso)}`,I.style.setProperty("--i",S);let N=document.createElement("div");N.className="letter-badge",N.textContent=d.line||"?";let v=document.createElement("div");v.className="train";let x=document.createElement("div");x.className="train-top";let H=document.createElement("div");H.className="destination",H.textContent=d.destination||"\u2014",x.appendChild(H);let P=document.createElement("div");P.className="time";let Y=document.createElement("span");Y.className="remaining",Y.textContent=R(d.departureIso);let K=document.createElement("span");K.className="clock-time",K.textContent=new Date(d.departureIso).toLocaleTimeString([],{hour:"2-digit",minute:"2-digit",hour12:!1}),P.appendChild(Y),P.appendChild(K),x.appendChild(P),v.appendChild(x);let q=document.createElement("span");q.className="track",t.mode===u?q.textContent=`Stop ${c(o,d)}`:q.textContent=d.track?`Track ${d.track}`:"Track \u2014",v.appendChild(q),I.appendChild(N),I.appendChild(v),n.departuresEl.appendChild(I)}requestAnimationFrame(i)}function B(){n.nowClockEl&&(n.nowClockEl.textContent=new Date().toLocaleTimeString([],{hour:"2-digit",minute:"2-digit",second:"2-digit",hour12:!1}))}Object.assign(s,{formatMinutes:R,minutesUntil:f,departureRowClass:k,isHelsinkiBound:_,sanitizeBusSelections:C,getVisibleDepartures:b,updateModeButtons:w,updateModeLabels:M,renderResultsLimitControl:a,updateHelsinkiFilterButton:L,setBusControlsVisibility:E,getBusStopMeta:g,getBusStopCodes:h,buildBusStopDisplay:c,updateDataScope:y,renderFilterButtons:U,renderBusControls:A,updateNextSummary:F,buildStatusFromResponse:D,getLoadErrorStatus:$,getGeolocationErrorStatus:G,alignDepartureColumns:i,render:m,updateClock:B})})();(()=>{let O=window.HMApp,{api:s,dom:n,state:t,constants:T}=O,{MODE_BUS:l}=T;function u(a){return new Promise(L=>setTimeout(L,a))}async function R(a,L={},E=T.FETCH_TIMEOUT_MS){let g=new AbortController,h=setTimeout(()=>g.abort(),E);try{return await fetch(a,{...L,signal:g.signal})}finally{clearTimeout(h)}}async function f(a,L={}){let E;try{E=await R(a,L)}catch{return await u(350),R(a,L)}return E.status>=500?(await u(350),R(a,L)):E}function k(a){let L=new Map,E=new Map;for(let h of a||[]){let c=String(h?.line||"").trim();c&&L.set(c,(L.get(c)||0)+1);let y=String(h?.destination||"").trim();y&&E.set(y,(E.get(y)||0)+1)}let g=h=>[...h.entries()].sort((c,y)=>y[1]-c[1]||c[0].localeCompare(y[0])).map(([c,y])=>({value:c,count:y}));return{lines:g(L),destinations:g(E)}}function _(a){let L=Array.isArray(a?.stops)?a.stops.filter(c=>c&&c.id&&c.name).map(c=>({id:c.id,name:c.name,code:String(c.code||"").trim()||null,stopCodes:s.uniqueNonEmptyStrings([...Array.isArray(c.stopCodes)?c.stopCodes:[],c.code]),distanceMeters:Number(c.distanceMeters)||0})):[];t.busStops=L;let E=String(a?.selectedStopId||"").trim()||null,g=c=>L.some(y=>y.id===c);E&&g(E)?t.busStopId=E:(!t.busStopId||!g(t.busStopId))&&(t.busStopId=L[0]?.id||null);let h=Array.isArray(a?.station?.departures)?a.station.departures:[];t.busFilterOptions=k(h),s.sanitizeBusSelections()}async function C(a,L){let E=++t.latestLoadToken,g=t.mode,h=t.busStopId;s.setLoading(!0),s.setStatus("Loading departures...");try{let c=new URLSearchParams({lat:String(a),lon:String(L),mode:g.toUpperCase(),results:String(s.getActiveResultsLimit(g))});g===l&&h&&c.set("stopId",h);let y=await f(`/api/v1/departures?${c.toString()}`);if(!(y.headers.get("content-type")||"").includes("application/json"))throw y.ok?new Error("Unexpected server response."):new Error("Request failed");let A=await y.json();if(!y.ok)throw new Error(A.error||"Request failed");if(E!==t.latestLoadToken)return;g===l&&(_(A),s.persistUiState()),t.latestResponse=A,s.render(A),s.setPermissionRequired(!1),s.setLastUpdated(new Date),s.setStatus(s.buildStatusFromResponse(A))}catch(c){if(E!==t.latestLoadToken)return;t.latestResponse=null,console.error("load departures error:",c),s.reportClientError("load",c,{mode:g}),s.setStatus(s.getLoadErrorStatus(c)),n.resultEl.classList.add("hidden"),s.updateNextSummary(null)}finally{E===t.latestLoadToken&&s.setLoading(!1)}}function b(){return navigator.geolocation?t.isLoading?!1:(s.setStatus("Getting your location..."),s.setLoading(!0),navigator.geolocation.getCurrentPosition(a=>{t.currentCoords={lat:a.coords.latitude,lon:a.coords.longitude},s.setPermissionRequired(!1),s.setLoading(!1),C(t.currentCoords.lat,t.currentCoords.lon)},a=>{if(s.setLoading(!1),a.code===1){s.setPermissionRequired(!0),s.setStatus(s.getGeolocationErrorStatus(a)),t.latestResponse=null,n.resultEl.classList.add("hidden"),s.updateNextSummary(null);return}s.setPermissionRequired(!1),s.setStatus(s.getGeolocationErrorStatus(a)),t.latestResponse=null,n.resultEl.classList.add("hidden"),s.updateNextSummary(null)},{enableHighAccuracy:!1,timeout:1e4,maximumAge:0}),!0):(s.setStatus("Geolocation not supported in this browser."),s.setPermissionRequired(!0),!1)}function w(){if(t.currentCoords){C(t.currentCoords.lat,t.currentCoords.lon);return}b()}function M(){s.updateModeButtons(),s.updateModeLabels(),s.renderResultsLimitControl(),s.updateHelsinkiFilterButton(),s.renderBusControls(),s.updateDataScope(t.latestResponse)}Object.assign(s,{delay:u,fetchWithTimeout:R,fetchWithRetryOnce:f,updateBusStateFromResponse:_,buildFilterOptionsFromDepartures:k,load:C,requestLocationAndLoad:b,refreshDeparturesOnly:w,applyModeUiState:M})})();(()=>{let O=window.HMApp,{api:s,dom:n,state:t,constants:T}=O,{MODE_RAIL:l,MODE_BUS:u}=T;function R(){if(t.currentCoords){s.load(t.currentCoords.lat,t.currentCoords.lon);return}s.requestLocationAndLoad()}n.locateBtn?.addEventListener("click",()=>{s.requestLocationAndLoad()}),n.modeRailBtn?.addEventListener("click",()=>{t.mode!==l&&(t.mode=l,s.applyModeUiState(),s.persistUiState(),R())}),n.modeBusBtn?.addEventListener("click",()=>{t.mode!==u&&(t.mode=u,t.helsinkiOnly=!1,s.applyModeUiState(),s.persistUiState(),R())}),n.resultsLimitSelectEl?.addEventListener("change",()=>{let f=s.parseResultLimit(n.resultsLimitSelectEl.value);if(f==null){s.renderResultsLimitControl();return}s.getActiveResultsLimit()!==f&&(t.resultsLimitByMode[t.mode]=f,s.persistUiState(),R())}),n.busStopSelectEl?.addEventListener("change",()=>{if(t.suppressBusStopChange||t.mode!==u)return;let f=String(n.busStopSelectEl.value||"").trim();!f||f===t.busStopId||(t.busStopId=f,s.persistUiState(),t.currentCoords&&s.load(t.currentCoords.lat,t.currentCoords.lon))}),n.helsinkiOnlyBtn?.addEventListener("click",()=>{t.mode===l&&(t.helsinkiOnly=!t.helsinkiOnly,s.persistUiState(),s.updateHelsinkiFilterButton(),t.latestResponse&&(s.render(t.latestResponse),s.setStatus(s.buildStatusFromResponse(t.latestResponse))))}),s.hydrateInitialState(),s.persistUiState(),s.applyModeUiState(),s.updateClock(),setInterval(s.updateClock,1e3),s.requestLocationAndLoad(),setInterval(s.refreshDeparturesOnly,3e4),window.addEventListener("resize",()=>{requestAnimationFrame(s.alignDepartureColumns)}),window.addEventListener("error",f=>{s.reportClientError("error",f.error||f.message||"Unknown error",{source:f.filename||"",line:f.lineno||null,column:f.colno||null})}),window.addEventListener("unhandledrejection",f=>{s.reportClientError("unhandledrejection",f.reason||"Unhandled promise rejection")}),(()=>{let f=document.getElementById("themeToggle");if(!f)return;let k=document.documentElement,_=window.matchMedia("(prefers-color-scheme: dark)"),C=()=>{let a=s.getStorageItem("theme");return a==="dark"||a==="light"?a:null},b=a=>{k.setAttribute("data-theme",a==="light"?"light":"dark")},w=()=>{let a=C();if(a){b(a);return}b(_.matches?"dark":"light")},M=a=>{C()||b(a.matches?"dark":"light")};w(),typeof _.addEventListener=="function"?_.addEventListener("change",M):typeof _.addListener=="function"&&_.addListener(M),f.addEventListener("click",()=>{let a=k.getAttribute("data-theme")==="dark"?"light":"dark";b(a),s.setStorageItem("theme",a)})})()})();})();
