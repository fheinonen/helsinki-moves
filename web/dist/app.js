(()=>{(()=>{let b=window.HMApp||(window.HMApp={}),i=b.api||={};b.dom={locateBtn:document.getElementById("locateBtn"),voiceLocateBtn:document.getElementById("voiceLocateBtn"),voiceLocateBtnLabel:document.getElementById("voiceLocateBtnLabel"),modeRailBtn:document.getElementById("modeRailBtn"),modeTramBtn:document.getElementById("modeTramBtn"),modeMetroBtn:document.getElementById("modeMetroBtn"),modeBusBtn:document.getElementById("modeBusBtn"),helsinkiOnlyBtn:document.getElementById("helsinkiOnlyBtn"),busControlsEl:document.getElementById("busControls"),busStopSelectEl:document.getElementById("busStopSelect"),busLineFiltersEl:document.getElementById("busLineFilters"),busDestinationFiltersEl:document.getElementById("busDestinationFilters"),resultsLimitSelectEl:document.getElementById("resultsLimitSelect"),modeEyebrowEl:document.getElementById("modeEyebrow"),statusEl:document.getElementById("status"),resolvedLocationEl:document.getElementById("resolvedLocation"),voiceLocationChoicesEl:document.getElementById("voiceLocationChoices"),voiceLocationChoicesTitleEl:document.getElementById("voiceLocationChoicesTitle"),voiceLocationChoicesOptionsEl:document.getElementById("voiceLocationChoicesOptions"),voiceLocationChoicesCancelEl:document.getElementById("voiceLocationChoicesCancel"),dataScopeEl:document.getElementById("dataScope"),resultEl:document.getElementById("result"),permissionCardEl:document.getElementById("permissionCard"),stationTitleEl:document.getElementById("stationTitle"),stationMetaEl:document.getElementById("stationMeta"),departuresEl:document.getElementById("departures"),nextSummaryEl:document.getElementById("nextSummary"),nextLabelEl:document.getElementById("nextLabel"),nextMinsEl:document.getElementById("nextMins"),nextLineEl:document.getElementById("nextLine"),nextTrackEl:document.getElementById("nextTrack"),nextDestinationEl:document.getElementById("nextDestination"),nowClockEl:document.getElementById("nowClock"),lastUpdatedEl:document.getElementById("lastUpdated")},b.constants={MODE_RAIL:"rail",MODE_TRAM:"tram",MODE_METRO:"metro",MODE_BUS:"bus",STORAGE_MODE_KEY:"prefs:mode",STORAGE_HELSINKI_ONLY_KEY:"prefs:helsinkiOnly",STORAGE_BUS_STOP_KEY:"prefs:busStopId",STORAGE_BUS_LINES_KEY:"prefs:busLines",STORAGE_BUS_DESTINATIONS_KEY:"prefs:busDestinations",STORAGE_RESULTS_LIMIT_RAIL_KEY:"prefs:resultsLimitRail",STORAGE_RESULTS_LIMIT_TRAM_KEY:"prefs:resultsLimitTram",STORAGE_RESULTS_LIMIT_METRO_KEY:"prefs:resultsLimitMetro",STORAGE_RESULTS_LIMIT_BUS_KEY:"prefs:resultsLimitBus",DEFAULT_RESULTS_LIMIT_RAIL:8,DEFAULT_RESULTS_LIMIT_TRAM:8,DEFAULT_RESULTS_LIMIT_METRO:8,DEFAULT_RESULTS_LIMIT_BUS:24,RESULT_LIMIT_OPTIONS:[8,12,16,20,24,30],VOICE_RECOGNITION_TIMEOUT_MS:8e3,VOICE_SILENCE_STOP_MS:1200,VOICE_QUERY_MIN_LENGTH:3,FETCH_TIMEOUT_MS:8e3,ERROR_REPORT_LIMIT:5};let{MODE_RAIL:o,MODE_TRAM:n,MODE_METRO:y,MODE_BUS:T}=b.constants;b.state={isLoading:!1,isVoiceListening:!1,currentCoords:null,latestResponse:null,mode:o,helsinkiOnly:!1,busStopId:null,busLineFilters:[],busDestinationFilters:[],resultsLimitByMode:{[o]:b.constants.DEFAULT_RESULTS_LIMIT_RAIL,[n]:b.constants.DEFAULT_RESULTS_LIMIT_TRAM,[y]:b.constants.DEFAULT_RESULTS_LIMIT_METRO,[T]:b.constants.DEFAULT_RESULTS_LIMIT_BUS},busStops:[],busFilterOptions:{lines:[],destinations:[]},resolvedLocationHint:null,suppressBusStopChange:!1,errorReportCount:0,latestLoadToken:0};let{dom:E,state:d,constants:f}=b;function L(){let r=d.isLoading||d.isVoiceListening,m=d.isLoading;E.locateBtn&&(E.locateBtn.disabled=r),E.voiceLocateBtn&&(E.voiceLocateBtn.disabled=m,E.voiceLocateBtn.classList.toggle("is-listening",d.isVoiceListening),E.voiceLocateBtn.setAttribute("aria-pressed",String(d.isVoiceListening))),E.voiceLocateBtnLabel&&(E.voiceLocateBtnLabel.textContent=d.isVoiceListening?"Listening...":"Describe Location")}function S(r){d.isLoading=r,L()}function R(r){d.isVoiceListening=!!r,L()}function I(r){E.statusEl&&(E.statusEl.textContent=r)}function U(r){let m=Number(r);return Number.isFinite(m)?m.toFixed(5):null}function g(r){let m=r&&typeof r=="object";if(d.resolvedLocationHint=m?{query:O(r.query,120).trim(),label:O(r.label,180).trim(),lat:Number(r.lat),lon:Number(r.lon)}:null,!E.resolvedLocationEl)return;if(!d.resolvedLocationHint){E.resolvedLocationEl.classList.add("hidden"),E.resolvedLocationEl.textContent="";return}let l=d.resolvedLocationHint.label||"Unknown place",e=d.resolvedLocationHint.query,t=U(d.resolvedLocationHint.lat),s=U(d.resolvedLocationHint.lon),a=e?` (from "${e}")`:"",u=t&&s?` - ${t}, ${s}`:"";E.resolvedLocationEl.textContent=`Resolved location: ${l}${a}${u}`,E.resolvedLocationEl.classList.remove("hidden")}function P(r){E.permissionCardEl&&E.permissionCardEl.classList.toggle("hidden",!r)}function N(r){!E.lastUpdatedEl||!(r instanceof Date)||(E.lastUpdatedEl.textContent=`Last updated: ${r.toLocaleTimeString([],{hour:"2-digit",minute:"2-digit",second:"2-digit",hour12:!1})}`)}function h(r){try{return window.localStorage.getItem(r)}catch{return null}}function v(r,m){try{window.localStorage.setItem(r,m)}catch{}}function O(r,m){let l=String(r||"");return l.length<=m?l:l.slice(0,m)}function K(r){if(r instanceof Error)return r;try{let m=typeof r=="string"?r:JSON.stringify(r);return new Error(m||"Unknown error")}catch{return new Error(String(r||"Unknown error"))}}function j(r,m,l=null){if(d.errorReportCount>=f.ERROR_REPORT_LIMIT)return;d.errorReportCount+=1;let e=K(m),t={type:O(r,40),message:O(e.message,400),stack:O(e.stack||"",1200),url:O(window.location.href,500),userAgent:O(navigator.userAgent||"",300),timestamp:new Date().toISOString(),context:l&&typeof l=="object"?l:null},s=JSON.stringify(t);if(navigator.sendBeacon){let a=new Blob([s],{type:"application/json"});navigator.sendBeacon("/api/v1/client-error",a);return}fetch("/api/v1/client-error",{method:"POST",headers:{"content-type":"application/json"},body:s,keepalive:!0}).catch(()=>{})}function x(r){if(!r)return null;let m=String(r).trim().toLowerCase();return m===o||m===n||m===y||m===T?m:null}function V(r){if(r==null)return null;let m=String(r).trim().toLowerCase();return["1","true","yes","on"].includes(m)?!0:["0","false","no","off"].includes(m)?!1:null}function B(r){return Array.isArray(r)?[...new Set(r.map(m=>String(m||"").trim()).filter(Boolean))]:[]}function C(r){if(r==null||r==="")return null;let m=Number(r);return!Number.isInteger(m)||!f.RESULT_LIMIT_OPTIONS.includes(m)?null:m}function H(r=d.mode){return r===T?f.DEFAULT_RESULTS_LIMIT_BUS:r===y?f.DEFAULT_RESULTS_LIMIT_METRO:r===n?f.DEFAULT_RESULTS_LIMIT_TRAM:f.DEFAULT_RESULTS_LIMIT_RAIL}function M(r=d.mode){let m=C(d.resultsLimitByMode?.[r]);return m??H(r)}function G(r){let m=h(r);if(!m)return[];try{let l=JSON.parse(m);return B(l)}catch{return[]}}function D(){let r=new URLSearchParams(window.location.search);return{mode:x(r.get("mode")),helsinkiOnly:V(r.get("helsinkiOnly")),stopProvided:r.has("stop"),busStopId:r.get("stop")?r.get("stop").trim():null,linesProvided:r.has("line"),busLines:B(r.getAll("line")),destinationsProvided:r.has("dest"),busDestinations:B(r.getAll("dest")),resultsProvided:r.has("results"),resultsLimit:C(r.get("results"))}}function Q(){let r=D(),m=x(h(f.STORAGE_MODE_KEY)),l=V(h(f.STORAGE_HELSINKI_ONLY_KEY));d.mode=r.mode||m||o,d.helsinkiOnly=r.helsinkiOnly??l??!1,d.mode!==o&&(d.helsinkiOnly=!1);let e=String(h(f.STORAGE_BUS_STOP_KEY)||"").trim()||null;d.busStopId=r.stopProvided?r.busStopId:e;let t=G(f.STORAGE_BUS_LINES_KEY),s=G(f.STORAGE_BUS_DESTINATIONS_KEY);d.busLineFilters=r.linesProvided?r.busLines:t,d.busDestinationFilters=r.destinationsProvided?r.busDestinations:s;let a=C(h(f.STORAGE_RESULTS_LIMIT_RAIL_KEY)),u=C(h(f.STORAGE_RESULTS_LIMIT_TRAM_KEY)),c=C(h(f.STORAGE_RESULTS_LIMIT_METRO_KEY)),p=C(h(f.STORAGE_RESULTS_LIMIT_BUS_KEY));d.resultsLimitByMode[o]=a??f.DEFAULT_RESULTS_LIMIT_RAIL,d.resultsLimitByMode[n]=u??f.DEFAULT_RESULTS_LIMIT_TRAM,d.resultsLimitByMode[y]=c??f.DEFAULT_RESULTS_LIMIT_METRO,d.resultsLimitByMode[T]=p??f.DEFAULT_RESULTS_LIMIT_BUS,r.resultsProvided&&r.resultsLimit!=null&&(d.resultsLimitByMode[d.mode]=r.resultsLimit)}function z(){v(f.STORAGE_MODE_KEY,d.mode),v(f.STORAGE_HELSINKI_ONLY_KEY,d.helsinkiOnly?"1":"0"),v(f.STORAGE_BUS_STOP_KEY,d.busStopId||""),v(f.STORAGE_BUS_LINES_KEY,JSON.stringify(d.busLineFilters)),v(f.STORAGE_BUS_DESTINATIONS_KEY,JSON.stringify(d.busDestinationFilters)),v(f.STORAGE_RESULTS_LIMIT_RAIL_KEY,String(M(o))),v(f.STORAGE_RESULTS_LIMIT_TRAM_KEY,String(M(n))),v(f.STORAGE_RESULTS_LIMIT_METRO_KEY,String(M(y))),v(f.STORAGE_RESULTS_LIMIT_BUS_KEY,String(M(T)))}function q(){let r=new URLSearchParams(window.location.search);d.mode===o?r.delete("mode"):r.set("mode",d.mode),d.mode===o&&d.helsinkiOnly?r.set("helsinkiOnly","1"):r.delete("helsinkiOnly");let m=M(),l=H();if(m===l?r.delete("results"):r.set("results",String(m)),r.delete("stop"),r.delete("line"),r.delete("dest"),d.mode===T||d.mode===n||d.mode===y){d.busStopId&&r.set("stop",d.busStopId);for(let s of d.busLineFilters)r.append("line",s);for(let s of d.busDestinationFilters)r.append("dest",s)}let e=r.toString(),t=`${window.location.pathname}${e?`?${e}`:""}${window.location.hash}`;window.history.replaceState(null,"",t)}function J(){z(),q()}L(),Object.assign(i,{updateLocationActionButtons:L,setLoading:S,setVoiceListening:R,setStatus:I,setResolvedLocationHint:g,setPermissionRequired:P,setLastUpdated:N,getStorageItem:h,setStorageItem:v,safeString:O,toError:K,reportClientError:j,normalizeMode:x,parseBoolean:V,uniqueNonEmptyStrings:B,parseResultLimit:C,getDefaultResultsLimit:H,getActiveResultsLimit:M,parseStoredArray:G,readStateFromUrl:D,hydrateInitialState:Q,syncStateToStorage:z,syncStateToUrl:q,persistUiState:J})})();(()=>{let b=window.HMApp,{api:i,dom:o,state:n,constants:y}=b,{MODE_RAIL:T,MODE_TRAM:E,MODE_METRO:d,MODE_BUS:f}=y;function L(e=n.mode){return e===f||e===E||e===d}function S(e=n.mode){return e===E?{singular:"tram",plural:"trams",title:"Tram"}:e===d?{singular:"metro",plural:"metros",title:"Metro"}:{singular:"bus",plural:"buses",title:"Bus"}}function R(e){let t=I(e);return t<=0?"Now":`${t}m`}function I(e){let t=new Date(e);return Math.floor((t.getTime()-Date.now())/6e4)}function U(e){let t=I(e);return t<=0||t<5?"departure-now":t<=15?"departure-soon":"departure-later"}function g(e){let t=e?.destination||"";return/\bhelsinki\b/i.test(t)}function P(){let e=new Set((n.busFilterOptions.lines||[]).map(s=>s.value)),t=new Set((n.busFilterOptions.destinations||[]).map(s=>s.value));n.busLineFilters=n.busLineFilters.filter(s=>e.has(s)),n.busDestinationFilters=n.busDestinationFilters.filter(s=>t.has(s))}function N(e){if(!Array.isArray(e))return[];if(n.mode===T)return n.helsinkiOnly?e.filter(g):e;if(!L())return e;let t=new Set(n.busLineFilters),s=new Set(n.busDestinationFilters);return e.filter(a=>{if(t.size===0)return!0;let u=String(a?.line||"").trim();return t.has(u)}).filter(a=>{if(s.size===0)return!0;let u=String(a?.destination||"").trim();return s.has(u)})}function h(){if(o.modeRailBtn){let e=n.mode===T;o.modeRailBtn.setAttribute("aria-pressed",String(e)),o.modeRailBtn.classList.toggle("is-active",e)}if(o.modeTramBtn){let e=n.mode===E;o.modeTramBtn.setAttribute("aria-pressed",String(e)),o.modeTramBtn.classList.toggle("is-active",e)}if(o.modeMetroBtn){let e=n.mode===d;o.modeMetroBtn.setAttribute("aria-pressed",String(e)),o.modeMetroBtn.classList.toggle("is-active",e)}if(o.modeBusBtn){let e=n.mode===f;o.modeBusBtn.setAttribute("aria-pressed",String(e)),o.modeBusBtn.classList.toggle("is-active",e)}}function v(){let e=L()?S().title:"Rail",t=L()?`Next ${S().title}`:"Next Train";o.modeEyebrowEl&&(o.modeEyebrowEl.textContent=`Helsinki Moves \u2022 ${e}`),o.nextLabelEl&&(o.nextLabelEl.textContent=t)}function O(){if(!o.resultsLimitSelectEl)return;let e=Array.isArray(y.RESULT_LIMIT_OPTIONS)?y.RESULT_LIMIT_OPTIONS:[],t=i.getActiveResultsLimit();o.resultsLimitSelectEl.innerHTML="";for(let s of e){let a=document.createElement("option");a.value=String(s),a.textContent=`${s}`,o.resultsLimitSelectEl.appendChild(a)}o.resultsLimitSelectEl.value=String(t)}function K(){if(o.helsinkiOnlyBtn){if(n.mode!==T){o.helsinkiOnlyBtn.setAttribute("aria-pressed","false"),o.helsinkiOnlyBtn.classList.remove("is-active"),o.helsinkiOnlyBtn.disabled=!0,o.helsinkiOnlyBtn.textContent="Helsinki Only (Rail)";return}o.helsinkiOnlyBtn.disabled=!1,o.helsinkiOnlyBtn.setAttribute("aria-pressed",String(n.helsinkiOnly)),o.helsinkiOnlyBtn.classList.toggle("is-active",n.helsinkiOnly),o.helsinkiOnlyBtn.textContent=n.helsinkiOnly?"Helsinki Only: On":"Helsinki Only: Off"}}function j(e){o.busControlsEl&&o.busControlsEl.classList.toggle("hidden",!e)}function x(e){return n.busStops.find(t=>t.id===e)||null}function V(e){let t=i.uniqueNonEmptyStrings([...Array.isArray(e?.stopCodes)?e.stopCodes:[],e?.code]);return t.length===0&&e?.id&&t.push(String(e.id)),t}function B(e,t=null){let s=x(n.busStopId),a=String(t?.stopName||e?.stopName||s?.name||"").trim(),c=i.uniqueNonEmptyStrings([t?.stopCode,...Array.isArray(e?.stopCodes)?e.stopCodes:[],e?.stopCode,...V(s)])[0]||"";return a&&c?`${a} ${c}`:a||c||"\u2014"}function C(e,t=null){if(L())return B(e,t);let s=String(t?.stopName||e?.stopName||"").trim(),a=String(t?.stopCode||e?.stopCode||"").trim();return s&&a?`${s} ${a}`:s||a||"\u2014"}function H(e){if(!o.dataScopeEl)return;if(!L()){o.dataScopeEl.classList.add("hidden"),o.dataScopeEl.textContent="";return}let t=String(e?.station?.stopName||x(n.busStopId)?.name||"").trim(),a=i.uniqueNonEmptyStrings([...Array.isArray(e?.station?.stopCodes)?e.station.stopCodes:[],e?.station?.stopCode,...V(x(n.busStopId))]).join(", "),u=n.busLineFilters.length===0?"all lines":`${n.busLineFilters.length} line${n.busLineFilters.length===1?"":"s"} selected`,c=n.busDestinationFilters.length===0?"all destinations":`${n.busDestinationFilters.length} destination${n.busDestinationFilters.length===1?"":"s"} selected`,p=`${i.getActiveResultsLimit()} results`;t?o.dataScopeEl.textContent=`Selected stop ${t} (${a||"\u2014"}) - ${u}, ${c}, ${p}`:o.dataScopeEl.textContent=`Selecting stop... (${u}, ${c}, ${p})`,o.dataScopeEl.classList.remove("hidden")}function M(e,t,s,a){if(!e)return;if(e.innerHTML="",!Array.isArray(t)||t.length===0){let c=document.createElement("span");c.className="chip-empty",c.textContent="No options",e.appendChild(c);return}let u=new Set(s);for(let c of t){let p=document.createElement("button");p.type="button",p.className="chip-toggle",u.has(c.value)?(p.classList.add("is-active"),p.setAttribute("aria-pressed","true")):p.setAttribute("aria-pressed","false"),p.textContent=`${c.value} (${c.count})`,p.addEventListener("click",()=>a(c.value)),e.appendChild(p)}}function G(){let e=L();if(j(e),!!e){if(o.busStopSelectEl){if(n.suppressBusStopChange=!0,o.busStopSelectEl.innerHTML="",n.busStops.length===0){let t=document.createElement("option");t.value="",t.textContent=`No nearby ${S().singular} stops`,o.busStopSelectEl.appendChild(t),o.busStopSelectEl.disabled=!0}else{o.busStopSelectEl.disabled=!1;for(let t of n.busStops){let s=document.createElement("option");s.value=t.id,s.textContent=`${t.name} (${t.distanceMeters}m)`,o.busStopSelectEl.appendChild(s)}n.busStopId&&n.busStops.some(t=>t.id===n.busStopId)?o.busStopSelectEl.value=n.busStopId:o.busStopSelectEl.value=n.busStops[0].id}n.suppressBusStopChange=!1}M(o.busLineFiltersEl,n.busFilterOptions.lines,n.busLineFilters,t=>{n.busLineFilters.includes(t)?n.busLineFilters=n.busLineFilters.filter(s=>s!==t):n.busLineFilters=[...n.busLineFilters,t],i.persistUiState(),n.latestResponse&&(i.render(n.latestResponse),i.setStatus(i.buildStatusFromResponse(n.latestResponse)))}),M(o.busDestinationFiltersEl,n.busFilterOptions.destinations,n.busDestinationFilters,t=>{n.busDestinationFilters.includes(t)?n.busDestinationFilters=n.busDestinationFilters.filter(s=>s!==t):n.busDestinationFilters=[...n.busDestinationFilters,t],i.persistUiState(),n.latestResponse&&(i.render(n.latestResponse),i.setStatus(i.buildStatusFromResponse(n.latestResponse)))})}}function D(e,t=null){if(!o.nextSummaryEl||!o.nextMinsEl||!o.nextLineEl||!o.nextTrackEl||!o.nextDestinationEl)return;if(!e){o.nextSummaryEl.classList.add("hidden"),o.nextSummaryEl.classList.remove("next-summary-now","next-summary-soon","next-summary-later");return}let s=I(e.departureIso);o.nextMinsEl.textContent=R(e.departureIso),o.nextLineEl.textContent=e.line||"\u2014",o.nextLineEl.classList.toggle("next-letter-now",s<5),o.nextTrackEl.textContent=L()?`Stop ${C(t,e)}`:e.track?`Track ${e.track}`:"Track \u2014",o.nextDestinationEl.textContent=e.destination||"\u2014",o.nextSummaryEl.classList.remove("next-summary-now","next-summary-soon","next-summary-later"),s<5?o.nextSummaryEl.classList.add("next-summary-now"):s<=15?o.nextSummaryEl.classList.add("next-summary-soon"):o.nextSummaryEl.classList.add("next-summary-later"),o.nextSummaryEl.classList.remove("hidden")}function Q(e){if(!e||!e.station)return L()?e?.message||`No nearby ${S().singular} stops found.`:e?.message||"No nearby train stations found.";let s=N(e.station.departures)[0];if(!s){if(L()){let p=S().plural;return n.busLineFilters.length>0||n.busDestinationFilters.length>0?`No upcoming ${p} match selected filters.`:`No upcoming ${p} right now.`}return n.helsinkiOnly?"No Helsinki-bound trains in upcoming departures.":"No upcoming commuter trains right now."}let a=s.destination?` \u2022 ${s.destination}`:"",u=n.mode===T?s.track?` \u2022 Track ${s.track}`:"":e.station.stopName||e.station.stopCode?` \u2022 ${C(e.station,s)}`:"",c=L()?S().singular:"train";return`Next ${s.line||c} in ${R(s.departureIso)}${a}${u}`}function z(e){if(!(e instanceof Error))return"Could not refresh departures. Please try again.";if(e.name==="AbortError")return"Request timed out. Please try again.";let t=(e.message||"").trim();return t==="Temporary server error. Please try again."?t:t==="Invalid lat/lon"?"Location coordinates were invalid. Please refresh your location.":t==="Invalid mode"?"Unsupported transport mode.":"Could not refresh departures. Please try again."}function q(e){return e?.code===1?"Location permission denied.":e?.code===2?"Location unavailable. Please try again.":e?.code===3?"Location request timed out. Please try again.":"Unable to get your location."}function J(e){let t=String(e?.code||"").trim();return t==="voice_unsupported"?"Voice location is not supported in this browser.":t==="voice_permission_denied"?"Microphone permission denied.":t==="voice_no_microphone"?"No microphone was found for voice location.":t==="voice_no_speech"?"No speech detected. Please try again.":t==="voice_recognition_timeout"?"Voice listening timed out. Please try again.":t==="voice_language_not_supported"?"Voice language was not supported on this device.":t==="voice_query_too_short"?"Please describe your location with a few words.":t==="voice_location_not_found"?"Could not match that place. Try a nearby landmark or street.":t==="voice_location_selection_cancelled"?"Location selection was cancelled.":t==="voice_location_selection_invalid"?"Please choose one of the suggested locations.":t==="voice_recognition_network"?"Voice recognition failed due to a network error. On iPhone, try enabling Siri & Dictation.":"Could not use voice location. Please try again."}function r(){let e=[...document.querySelectorAll(".departure-row .train-top")];if(e.length===0)return;let t=e.map(c=>c.querySelector(".destination")).filter(Boolean);for(let c of t)c.style.width="auto";let s=0;for(let c of t)s=Math.max(s,Math.ceil(c.scrollWidth));let a=Number.POSITIVE_INFINITY;for(let c of e){let p=c.querySelector(".time");if(!p)continue;let _=getComputedStyle(c),A=parseFloat(_.columnGap||_.gap||"0")||0,w=c.clientWidth-p.offsetWidth-A;w>0&&(a=Math.min(a,w))}let u=Math.max(0,Math.min(s,a));for(let c of t)c.style.width=`${u}px`}function m(e){if(G(),H(e),!e||!e.station){o.resultEl.classList.add("hidden"),D(null);return}let t=e.station;o.resultEl.classList.remove("hidden"),o.stationTitleEl.textContent=t.stopName,o.stationMetaEl.textContent=`${t.distanceMeters}m away`,o.departuresEl.innerHTML="";let s=N(t.departures);if(s.length===0){D(null);let u=document.createElement("li");if(u.className="empty-row",L()){let c=S().plural;u.textContent=n.busLineFilters.length>0||n.busDestinationFilters.length>0?`No upcoming ${c} match selected filters.`:`No upcoming ${c} right now.`}else u.textContent=n.helsinkiOnly?"No Helsinki-bound trains in upcoming departures.":"No upcoming commuter trains right now.";o.departuresEl.appendChild(u);return}D(s[0],t);let a=s.slice(1);if(a.length===0){let u=document.createElement("li");u.className="empty-row",u.textContent=L()?`No additional upcoming ${S().plural} right now.`:"No additional upcoming commuter trains right now.",o.departuresEl.appendChild(u);return}for(let u=0;u<a.length;u++){let c=a[u],p=document.createElement("li");p.className=`departure-row ${U(c.departureIso)}`,p.style.setProperty("--i",u);let _=document.createElement("div");_.className="letter-badge",_.textContent=c.line||"?";let A=document.createElement("div");A.className="train";let w=document.createElement("div");w.className="train-top";let W=document.createElement("div");W.className="destination",W.textContent=c.destination||"\u2014",w.appendChild(W);let Y=document.createElement("div");Y.className="time";let Z=document.createElement("span");Z.className="remaining",Z.textContent=R(c.departureIso);let F=document.createElement("span");F.className="clock-time",F.textContent=new Date(c.departureIso).toLocaleTimeString([],{hour:"2-digit",minute:"2-digit",hour12:!1}),Y.appendChild(Z),Y.appendChild(F),w.appendChild(Y),A.appendChild(w);let X=document.createElement("span");X.className="track",L()?X.textContent=`Stop ${C(t,c)}`:X.textContent=c.track?`Track ${c.track}`:"Track \u2014",A.appendChild(X),p.appendChild(_),p.appendChild(A),o.departuresEl.appendChild(p)}requestAnimationFrame(r)}function l(){o.nowClockEl&&(o.nowClockEl.textContent=new Date().toLocaleTimeString([],{hour:"2-digit",minute:"2-digit",second:"2-digit",hour12:!1}))}Object.assign(i,{formatMinutes:R,minutesUntil:I,departureRowClass:U,isHelsinkiBound:g,sanitizeStopSelections:P,getVisibleDepartures:N,updateModeButtons:h,updateModeLabels:v,renderResultsLimitControl:O,updateHelsinkiFilterButton:K,setStopControlsVisibility:j,getStopMeta:x,getStopCodes:V,buildStopDisplay:B,buildModeStopDisplay:C,updateDataScope:H,renderFilterButtons:M,renderStopControls:G,updateNextSummary:D,buildStatusFromResponse:Q,getLoadErrorStatus:z,getGeolocationErrorStatus:q,getVoiceLocationErrorStatus:J,alignDepartureColumns:r,render:m,updateClock:l})})();(()=>{let b=window.HMApp,{api:i,dom:o,state:n,constants:y}=b,{MODE_TRAM:T,MODE_METRO:E,MODE_BUS:d}=y;function f(l){return l===d||l===T||l===E}function L(l){return new Promise(e=>setTimeout(e,l))}async function S(l,e={},t=y.FETCH_TIMEOUT_MS){let s=new AbortController,a=setTimeout(()=>s.abort(),t);try{return await fetch(l,{...e,signal:s.signal})}finally{clearTimeout(a)}}async function R(l,e={}){let t;try{t=await S(l,e)}catch{return await L(350),S(l,e)}return t.status>=500?(await L(350),S(l,e)):t}function I(l){let e=new Map,t=new Map;for(let a of l||[]){let u=String(a?.line||"").trim();u&&e.set(u,(e.get(u)||0)+1);let c=String(a?.destination||"").trim();c&&t.set(c,(t.get(c)||0)+1)}let s=a=>[...a.entries()].sort((u,c)=>c[1]-u[1]||u[0].localeCompare(c[0])).map(([u,c])=>({value:u,count:c}));return{lines:s(e),destinations:s(t)}}function U(l){let e=Array.isArray(l?.stops)?l.stops.filter(u=>u&&u.id&&u.name).map(u=>({id:u.id,name:u.name,code:String(u.code||"").trim()||null,stopCodes:i.uniqueNonEmptyStrings([...Array.isArray(u.stopCodes)?u.stopCodes:[],u.code]),distanceMeters:Number(u.distanceMeters)||0})):[];n.busStops=e;let t=String(l?.selectedStopId||"").trim()||null,s=u=>e.some(c=>c.id===u);t&&s(t)?n.busStopId=t:(!n.busStopId||!s(n.busStopId))&&(n.busStopId=e[0]?.id||null);let a=Array.isArray(l?.station?.departures)?l.station.departures:[];n.busFilterOptions=I(a),i.sanitizeStopSelections()}function g(l,e){let t=new Error(e);return t.code=l,t}function P(l){return String(l?.code||"").trim().toLowerCase()}function N(){return i.uniqueNonEmptyStrings(["fi-FI","en-US",...Array.isArray(navigator.languages)?navigator.languages:[],navigator.language])}function h(){return typeof window.SpeechRecognition=="function"?window.SpeechRecognition:typeof window.webkitSpeechRecognition=="function"?window.webkitSpeechRecognition:null}function v(){return!!h()}function O(l){return l==="not-allowed"||l==="service-not-allowed"?g("voice_permission_denied","Microphone permission denied."):l==="audio-capture"?g("voice_no_microphone","No microphone available."):l==="language-not-supported"?g("voice_language_not_supported","Speech language is not supported."):l==="network"?g("voice_recognition_network","Voice recognition network error."):l==="no-speech"?g("voice_no_speech","No speech detected."):g("voice_not_understood","Voice recognition failed.")}function K(l){let e=h();return e?new Promise((t,s)=>{let a=new e,u=String(l||navigator.language||"fi-FI").trim();a.lang=u||"fi-FI",a.continuous=!1,a.interimResults=!0,a.maxAlternatives=1;let c=!1,p="",_=null,A=!1,w=()=>{clearTimeout(_),_=null},W=()=>{if(!(A||c)){A=!0;try{a.stop()}catch{}}},Y=()=>{w(),_=setTimeout(W,y.VOICE_SILENCE_STOP_MS)},Z=()=>{clearTimeout(X),w(),a.onresult=null,a.onerror=null,a.onend=null,a.onspeechend=null,a.onsoundend=null,a.onaudioend=null,a.onnomatch=null},F=(k,$)=>{c||(c=!0,Z(),k($))},X=setTimeout(()=>{try{a.abort()}catch{}F(s,g("voice_recognition_timeout","Voice recognition timed out."))},y.VOICE_RECOGNITION_TIMEOUT_MS);a.onresult=k=>{for(let $=k?.resultIndex||0;$<(k?.results?.length||0);$+=1){let ee=k.results[$],te=String(ee?.[0]?.transcript||"").trim();if(te&&(p=te,Y(),ee?.isFinal)){W();return}}},a.onerror=k=>{let $=String(k?.error||"").trim().toLowerCase();F(s,O($))},a.onend=()=>{if(c)return;let k=String(p||"").trim();if(!k){F(s,g("voice_no_speech","No speech detected."));return}F(t,k)},a.onspeechend=()=>{W()},a.onsoundend=()=>{Y()},a.onaudioend=()=>{Y()},a.onnomatch=()=>{F(s,g("voice_not_understood","Could not understand speech."))};try{a.start()}catch(k){let $=String(k?.name||"").trim().toLowerCase();if($==="notallowederror"||$==="securityerror"){F(s,g("voice_permission_denied","Microphone permission denied."));return}F(s,g("voice_not_understood","Unable to start voice recognition."))}}):Promise.reject(g("voice_unsupported","Voice recognition not supported."))}function j(l){return l==="voice_no_speech"||l==="voice_not_understood"||l==="voice_recognition_timeout"||l==="voice_language_not_supported"}async function x(){let l=N(),e=null;for(let t of l)try{return await K(t)}catch(s){if(e=s,!j(P(s)))break}throw e||g("voice_not_understood","Voice recognition failed.")}function V(l){return Array.isArray(l)?l.map(e=>{let t=Number(e?.lat),s=Number(e?.lon);return!Number.isFinite(t)||!Number.isFinite(s)?null:{lat:t,lon:s,label:String(e?.label||"").trim()}}).filter(Boolean):[]}function B(){o.voiceLocationChoicesEl&&o.voiceLocationChoicesEl.classList.add("hidden"),o.voiceLocationChoicesTitleEl&&(o.voiceLocationChoicesTitleEl.textContent=""),o.voiceLocationChoicesOptionsEl&&(o.voiceLocationChoicesOptionsEl.innerHTML=""),o.voiceLocationChoicesCancelEl&&(o.voiceLocationChoicesCancelEl.onclick=null)}function C(l,e){if(typeof window.prompt!="function")throw g("voice_location_selection_cancelled","Location selection was cancelled.");let t=e.map((u,c)=>`${c+1}. ${u.label||`${u.lat}, ${u.lon}`}`).join(`
`),s=window.prompt(`Multiple matches found for "${i.safeString(l,80)}". Select number:
${t}`,"1");if(s==null)throw g("voice_location_selection_cancelled","Location selection was cancelled.");let a=Number.parseInt(String(s).trim(),10);if(!Number.isInteger(a)||a<1||a>e.length)throw g("voice_location_selection_invalid","Invalid location selection.");return e[a-1]}async function H(l,e){if(!Array.isArray(e)||e.length===0)throw g("voice_location_not_found","No matching location found.");return!o.voiceLocationChoicesEl||!o.voiceLocationChoicesTitleEl||!o.voiceLocationChoicesOptionsEl||!o.voiceLocationChoicesCancelEl?C(l,e):new Promise((t,s)=>{let a=!1,u=(c,p)=>{a||(a=!0,B(),c(p))};o.voiceLocationChoicesTitleEl.textContent=`Multiple matches for "${i.safeString(l,80)}". Choose one:`,i.setStatus("Multiple matches found. Choose one below."),o.voiceLocationChoicesOptionsEl.innerHTML="";for(let c of e){let p=document.createElement("button");p.type="button",p.className="voice-location-choice-option",p.textContent=c.label||`${c.lat.toFixed(5)}, ${c.lon.toFixed(5)}`,p.addEventListener("click",()=>u(t,c),{once:!0}),o.voiceLocationChoicesOptionsEl.appendChild(p)}o.voiceLocationChoicesCancelEl.onclick=()=>u(s,g("voice_location_selection_cancelled","Location selection was cancelled.")),o.voiceLocationChoicesEl.classList.remove("hidden")})}async function M(l){let e=String(l||"").trim();if(e.length<y.VOICE_QUERY_MIN_LENGTH)throw g("voice_query_too_short","Voice query too short.");let t=new URLSearchParams({text:e});n.currentCoords&&(t.set("lat",String(n.currentCoords.lat)),t.set("lon",String(n.currentCoords.lon)));let s=Array.isArray(navigator.languages)&&navigator.languages[0]||navigator.language||"";s&&t.set("lang",String(s));let a;try{a=await R(`/api/v1/geocode?${t.toString()}`)}catch{throw g("voice_geocode_failed","Location lookup failed.")}if(!(a.headers.get("content-type")||"").includes("application/json"))throw g("voice_geocode_failed","Unexpected location lookup response.");let c=await a.json();if(!a.ok)throw g("voice_geocode_failed",String(c?.error||"Location lookup failed.").trim());let p=V(c?.choices);if(c?.ambiguous&&p.length>1){let w=await H(e,p);return{lat:w.lat,lon:w.lon,label:w.label,query:e}}let _=Number(c?.location?.lat),A=Number(c?.location?.lon);if(!Number.isFinite(_)||!Number.isFinite(A))throw g("voice_location_not_found","No matching location found.");return{lat:_,lon:A,label:String(c?.location?.label||"").trim(),query:e}}function G(l){return l==="voice_unsupported"||l==="voice_no_speech"||l==="voice_recognition_timeout"||l==="voice_recognition_network"||l==="voice_not_understood"}function D(l){if(!G(l)||typeof window.prompt!="function")return null;let e=l==="voice_unsupported"?"Voice input is limited in this browser. Type your location instead:":"Could not capture your voice on this device. Type your location:",t=window.prompt(`${e}
Example: Kamppi Helsinki`,"");return String(t||"").trim()||null}async function Q(l){let e=String(l||"").trim();B(),i.setStatus(`Looking up "${i.safeString(e,80)}"...`);let t=await M(e);return i.setResolvedLocationHint({query:e,label:t.label,lat:t.lat,lon:t.lon}),n.currentCoords={lat:t.lat,lon:t.lon},i.setPermissionRequired(!1),await q(t.lat,t.lon),!0}async function z(){if(n.isLoading||n.isVoiceListening)return!1;B(),i.setVoiceListening(!0),i.setStatus("Listening... speak now, then pause.");try{if(!v()){let e=g("voice_unsupported","Voice recognition not supported."),t=D(P(e));return t?Q(t):(i.setStatus(i.getVoiceLocationErrorStatus(e)),!1)}let l=await x();return Q(l)}catch(l){let e=P(l),t=D(e);if(t)try{return await Q(t)}catch(s){return console.error("voice fallback location error:",s),i.reportClientError("voice-location-fallback",s,{mode:n.mode,sourceCode:e||"unknown"}),i.setStatus(i.getVoiceLocationErrorStatus(s)),!1}return(!e||e==="unknown")&&console.error("voice location error:",l),i.reportClientError("voice-location",l,{mode:n.mode,code:e||"unknown"}),i.setStatus(i.getVoiceLocationErrorStatus(l)),!1}finally{i.setVoiceListening(!1)}}async function q(l,e){let t=++n.latestLoadToken,s=n.mode,a=n.busStopId;i.setLoading(!0),i.setStatus("Loading departures...");try{let u=new URLSearchParams({lat:String(l),lon:String(e),mode:s.toUpperCase(),results:String(i.getActiveResultsLimit(s))});f(s)&&a&&u.set("stopId",a);let c=await R(`/api/v1/departures?${u.toString()}`);if(!(c.headers.get("content-type")||"").includes("application/json"))throw c.ok?new Error("Unexpected server response."):new Error("Request failed");let _=await c.json();if(!c.ok)throw new Error(_.error||"Request failed");if(t!==n.latestLoadToken)return;f(s)&&(U(_),i.persistUiState()),n.latestResponse=_,i.render(_),i.setPermissionRequired(!1),i.setLastUpdated(new Date),i.setStatus(i.buildStatusFromResponse(_))}catch(u){if(t!==n.latestLoadToken)return;n.latestResponse=null,console.error("load departures error:",u),i.reportClientError("load",u,{mode:s}),i.setStatus(i.getLoadErrorStatus(u)),o.resultEl.classList.add("hidden"),i.updateNextSummary(null)}finally{t===n.latestLoadToken&&i.setLoading(!1)}}function J(){return B(),i.setResolvedLocationHint(null),navigator.geolocation?n.isLoading||n.isVoiceListening?!1:(i.setStatus("Getting your location..."),i.setLoading(!0),navigator.geolocation.getCurrentPosition(l=>{n.currentCoords={lat:l.coords.latitude,lon:l.coords.longitude},i.setPermissionRequired(!1),i.setLoading(!1),q(n.currentCoords.lat,n.currentCoords.lon)},l=>{if(i.setLoading(!1),l.code===1){i.setPermissionRequired(!0),i.setStatus(i.getGeolocationErrorStatus(l)),n.latestResponse=null,o.resultEl.classList.add("hidden"),i.updateNextSummary(null);return}i.setPermissionRequired(!1),i.setStatus(i.getGeolocationErrorStatus(l)),n.latestResponse=null,o.resultEl.classList.add("hidden"),i.updateNextSummary(null)},{enableHighAccuracy:!1,timeout:1e4,maximumAge:0}),!0):(i.setStatus("Geolocation not supported in this browser."),i.setPermissionRequired(!0),!1)}function r(){if(!n.isVoiceListening){if(n.currentCoords){q(n.currentCoords.lat,n.currentCoords.lon);return}J()}}function m(){i.updateModeButtons(),i.updateModeLabels(),i.renderResultsLimitControl(),i.updateHelsinkiFilterButton(),i.renderStopControls(),i.updateDataScope(n.latestResponse)}Object.assign(i,{delay:L,fetchWithTimeout:S,fetchWithRetryOnce:R,updateStopModeStateFromResponse:U,buildFilterOptionsFromDepartures:I,load:q,requestLocationAndLoad:J,requestVoiceLocationAndLoad:z,supportsVoiceLocation:v,captureVoiceQuery:K,captureVoiceQueryWithRetry:x,getVoiceRecognitionLanguages:N,shouldRetryVoiceRecognition:j,resolveVoiceLocationQuery:M,refreshDeparturesOnly:r,applyModeUiState:m})})();(()=>{let b=window.HMApp,{api:i,dom:o,state:n,constants:y}=b,{MODE_RAIL:T,MODE_TRAM:E,MODE_METRO:d,MODE_BUS:f}=y;function L(){if(n.currentCoords){i.load(n.currentCoords.lat,n.currentCoords.lon);return}i.requestLocationAndLoad()}o.locateBtn?.addEventListener("click",()=>{i.requestLocationAndLoad()}),o.voiceLocateBtn?.addEventListener("click",()=>{i.requestVoiceLocationAndLoad()}),o.modeRailBtn?.addEventListener("click",()=>{n.mode!==T&&(n.mode=T,i.applyModeUiState(),i.persistUiState(),L())}),o.modeTramBtn?.addEventListener("click",()=>{n.mode!==E&&(n.mode=E,n.helsinkiOnly=!1,i.applyModeUiState(),i.persistUiState(),L())}),o.modeMetroBtn?.addEventListener("click",()=>{n.mode!==d&&(n.mode=d,n.helsinkiOnly=!1,i.applyModeUiState(),i.persistUiState(),L())}),o.modeBusBtn?.addEventListener("click",()=>{n.mode!==f&&(n.mode=f,n.helsinkiOnly=!1,i.applyModeUiState(),i.persistUiState(),L())}),o.resultsLimitSelectEl?.addEventListener("change",()=>{let S=i.parseResultLimit(o.resultsLimitSelectEl.value);if(S==null){i.renderResultsLimitControl();return}i.getActiveResultsLimit()!==S&&(n.resultsLimitByMode[n.mode]=S,i.persistUiState(),L())}),o.busStopSelectEl?.addEventListener("change",()=>{if(n.suppressBusStopChange||n.mode!==f&&n.mode!==E&&n.mode!==d)return;let S=String(o.busStopSelectEl.value||"").trim();!S||S===n.busStopId||(n.busStopId=S,i.persistUiState(),n.currentCoords&&i.load(n.currentCoords.lat,n.currentCoords.lon))}),o.helsinkiOnlyBtn?.addEventListener("click",()=>{n.mode===T&&(n.helsinkiOnly=!n.helsinkiOnly,i.persistUiState(),i.updateHelsinkiFilterButton(),n.latestResponse&&(i.render(n.latestResponse),i.setStatus(i.buildStatusFromResponse(n.latestResponse))))}),i.hydrateInitialState(),i.persistUiState(),i.applyModeUiState(),i.updateClock(),setInterval(i.updateClock,1e3),i.requestLocationAndLoad(),setInterval(i.refreshDeparturesOnly,3e4),window.addEventListener("resize",()=>{requestAnimationFrame(i.alignDepartureColumns)}),window.addEventListener("error",S=>{i.reportClientError("error",S.error||S.message||"Unknown error",{source:S.filename||"",line:S.lineno||null,column:S.colno||null})}),window.addEventListener("unhandledrejection",S=>{i.reportClientError("unhandledrejection",S.reason||"Unhandled promise rejection")}),(()=>{let S=document.getElementById("themeToggle");if(!S)return;let R=document.documentElement,I=window.matchMedia("(prefers-color-scheme: dark)"),U=()=>{let h=i.getStorageItem("theme");return h==="dark"||h==="light"?h:null},g=h=>{R.setAttribute("data-theme",h==="light"?"light":"dark")},P=()=>{let h=U();if(h){g(h);return}g(I.matches?"dark":"light")},N=h=>{U()||g(h.matches?"dark":"light")};P(),typeof I.addEventListener=="function"?I.addEventListener("change",N):typeof I.addListener=="function"&&I.addListener(N),S.addEventListener("click",()=>{let h=R.getAttribute("data-theme")==="dark"?"light":"dark";g(h),i.setStorageItem("theme",h)})})()})();})();
