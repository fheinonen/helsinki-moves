(()=>{(()=>{let D=window.HMApp||(window.HMApp={}),r=D.api||={};D.dom={locateBtn:document.getElementById("locateBtn"),voiceLocateBtn:document.getElementById("voiceLocateBtn"),voiceLocateBtnLabel:document.getElementById("voiceLocateBtnLabel"),skeletonEl:document.getElementById("skeleton"),segmentControlEl:document.querySelector(".segment-control"),modeRailBtn:document.getElementById("modeRailBtn"),modeTramBtn:document.getElementById("modeTramBtn"),modeMetroBtn:document.getElementById("modeMetroBtn"),modeBusBtn:document.getElementById("modeBusBtn"),busControlsEl:document.getElementById("busControls"),busStopSelectEl:document.getElementById("busStopSelect"),busStopSelectLabelEl:document.getElementById("busStopSelectLabel"),busStopSelectListEl:document.getElementById("busStopSelectList"),busStopSelectWrapEl:document.getElementById("busStopSelectWrap"),busStopFiltersEl:document.getElementById("busStopFilters"),busLineFiltersEl:document.getElementById("busLineFilters"),busDestinationFiltersEl:document.getElementById("busDestinationFilters"),stopFiltersToggleBtnEl:document.getElementById("stopFiltersToggleBtn"),stopFiltersPanelEl:document.getElementById("stopFiltersPanel"),stopFilterSummaryEl:document.getElementById("stopFilterSummary"),resultsLimitSelectEl:document.getElementById("resultsLimitSelect"),resultsLimitSelectLabelEl:document.getElementById("resultsLimitSelectLabel"),resultsLimitSelectListEl:document.getElementById("resultsLimitSelectList"),resultsLimitSelectWrapEl:document.getElementById("resultsLimitSelectWrap"),modeEyebrowEl:document.getElementById("modeEyebrow"),statusEl:document.getElementById("status"),resolvedLocationEl:document.getElementById("resolvedLocation"),voiceLocationChoicesEl:document.getElementById("voiceLocationChoices"),voiceLocationChoicesTitleEl:document.getElementById("voiceLocationChoicesTitle"),voiceLocationChoicesOptionsEl:document.getElementById("voiceLocationChoicesOptions"),voiceLocationChoicesCancelEl:document.getElementById("voiceLocationChoicesCancel"),dataScopeEl:document.getElementById("dataScope"),resultEl:document.getElementById("result"),locationPromptCardEl:document.getElementById("locationPromptCard"),locationPromptAllowEl:document.getElementById("locationPromptAllow"),permissionCardEl:document.getElementById("permissionCard"),permissionRetryBtnEl:document.getElementById("permissionRetryBtn"),stationTitleEl:document.getElementById("stationTitle"),stationMetaEl:document.getElementById("stationMeta"),departuresEl:document.getElementById("departures"),nextSummaryEl:document.getElementById("nextSummary"),nextLabelEl:document.getElementById("nextLabel"),nextMinsEl:document.getElementById("nextMins"),nextLineEl:document.getElementById("nextLine"),nextTrackEl:document.getElementById("nextTrack"),nextDestinationEl:document.getElementById("nextDestination"),nowClockEl:document.getElementById("nowClock"),lastUpdatedEl:document.getElementById("lastUpdated")},D.constants={MODE_RAIL:"rail",MODE_TRAM:"tram",MODE_METRO:"metro",MODE_BUS:"bus",STORAGE_MODE_KEY:"prefs:mode",STORAGE_BUS_STOP_KEY:"prefs:busStopId",STORAGE_BUS_LINES_KEY:"prefs:busLines",STORAGE_BUS_DESTINATIONS_KEY:"prefs:busDestinations",STORAGE_RESULTS_LIMIT_RAIL_KEY:"prefs:resultsLimitRail",STORAGE_RESULTS_LIMIT_TRAM_KEY:"prefs:resultsLimitTram",STORAGE_RESULTS_LIMIT_METRO_KEY:"prefs:resultsLimitMetro",STORAGE_RESULTS_LIMIT_BUS_KEY:"prefs:resultsLimitBus",DEFAULT_RESULTS_LIMIT_RAIL:8,DEFAULT_RESULTS_LIMIT_TRAM:8,DEFAULT_RESULTS_LIMIT_METRO:8,DEFAULT_RESULTS_LIMIT_BUS:24,RESULT_LIMIT_OPTIONS:[8,12,16,20,24,30],VOICE_RECOGNITION_TIMEOUT_MS:8e3,VOICE_SILENCE_STOP_MS:1200,VOICE_QUERY_MIN_LENGTH:3,FETCH_TIMEOUT_MS:8e3,ERROR_REPORT_LIMIT:5,METRIC_REPORT_LIMIT:10,METRIC_SAMPLE_RATE:1};let{MODE_RAIL:n,MODE_TRAM:e,MODE_METRO:N,MODE_BUS:$}=D.constants;D.state={locationGranted:!1,isLoading:!1,isVoiceListening:!1,currentCoords:null,latestResponse:null,mode:n,busStopId:null,busStopMemberFilterId:null,busLineFilters:[],busDestinationFilters:[],stopFilterPinned:!1,stopFiltersPanelOpen:!1,stopFiltersPanelLockUntilMs:0,deferInitialStopContext:!1,deferredBusStopId:null,deferredBusLineFilters:[],deferredBusDestinationFilters:[],resultsLimitByMode:{[n]:D.constants.DEFAULT_RESULTS_LIMIT_RAIL,[e]:D.constants.DEFAULT_RESULTS_LIMIT_TRAM,[N]:D.constants.DEFAULT_RESULTS_LIMIT_METRO,[$]:D.constants.DEFAULT_RESULTS_LIMIT_BUS},busStops:[],busFilterOptions:{lines:[],destinations:[]},resolvedLocationHint:null,suppressBusStopChange:!1,hasCompletedInitialStopModeLoad:!1,errorReportCount:0,metricReportCount:0,isMetricSessionSampled:Math.random()<D.constants.METRIC_SAMPLE_RATE,sessionStartedAtMs:Date.now(),hasReportedFirstSuccessfulRenderMetric:!1,hasReportedFirstManualInteractionMetric:!1,hasReportedFirstManualStopContextMetric:!1,hasReportedInitialNearestStopResolvedMetric:!1,latestLoadToken:0};let{dom:C,state:u,constants:M}=D;function G(){let o=u.isLoading||u.isVoiceListening,c=u.isLoading;C.locateBtn&&(C.locateBtn.disabled=o),C.voiceLocateBtn&&(C.voiceLocateBtn.disabled=c,C.voiceLocateBtn.classList.toggle("is-listening",u.isVoiceListening),C.voiceLocateBtn.setAttribute("aria-pressed",String(u.isVoiceListening))),C.voiceLocateBtnLabel&&(C.voiceLocateBtnLabel.textContent=u.isVoiceListening?"Listening...":"Voice Search")}function ut(o){u.isLoading=o,G(),C.skeletonEl&&C.skeletonEl.classList.toggle("hidden",!o)}function st(o){u.isVoiceListening=!!o,G()}function Q(o){if(!C.statusEl)return;let c=String(o||"").trim();C.statusEl.textContent=c,C.statusEl.classList?.toggle?.("hidden",c.length===0)}function J(o){let c=Number(o);return Number.isFinite(c)?c.toFixed(5):null}function m(o){let c=o&&typeof o=="object";if(u.resolvedLocationHint=c?{query:T(o.query,120).trim(),label:T(o.label,180).trim(),lat:Number(o.lat),lon:Number(o.lon)}:null,!C.resolvedLocationEl)return;if(!u.resolvedLocationHint){C.resolvedLocationEl.classList.add("hidden"),C.resolvedLocationEl.textContent="";return}let h=u.resolvedLocationHint.label||"Unknown place",I=u.resolvedLocationHint.query,F=J(u.resolvedLocationHint.lat),V=J(u.resolvedLocationHint.lon),X=I?` (from "${I}")`:"",it=F&&V?` - ${F}, ${V}`:"";C.resolvedLocationEl.textContent=`Resolved location: ${h}${X}${it}`,C.resolvedLocationEl.classList.remove("hidden")}function p(){C.locationPromptCardEl&&C.locationPromptCardEl.classList.remove("hidden"),C.permissionCardEl&&C.permissionCardEl.classList.add("hidden")}function k(){C.locationPromptCardEl&&C.locationPromptCardEl.classList.add("hidden")}function _(o){k(),C.permissionCardEl&&C.permissionCardEl.classList.toggle("hidden",!o)}function A(o){!C.lastUpdatedEl||!(o instanceof Date)||(C.lastUpdatedEl.textContent=`Last updated: ${o.toLocaleTimeString([],{hour:"2-digit",minute:"2-digit",second:"2-digit",hour12:!1})}`)}function R(o){try{return window.localStorage.getItem(o)}catch{return null}}function w(o,c){try{window.localStorage.setItem(o,c)}catch{}}function T(o,c){let h=String(o||"");return h.length<=c?h:h.slice(0,c)}function K(o){if(o instanceof Error)return o;try{let c=typeof o=="string"?o:JSON.stringify(o);return new Error(c||"Unknown error")}catch{return new Error(String(o||"Unknown error"))}}function ot(o){let c=JSON.stringify(o);if(navigator.sendBeacon){let h=new Blob([c],{type:"application/json"});navigator.sendBeacon("/api/v1/client-error",h);return}fetch("/api/v1/client-error",{method:"POST",headers:{"content-type":"application/json"},body:c,keepalive:!0}).catch(()=>{})}function x(o,c,h=null){if(u.errorReportCount>=M.ERROR_REPORT_LIMIT)return;u.errorReportCount+=1;let I=K(c),F={type:T(o,40),message:T(I.message,400),stack:T(I.stack||"",1200),url:T(window.location.href,500),userAgent:T(navigator.userAgent||"",300),timestamp:new Date().toISOString(),context:h&&typeof h=="object"?h:null};ot(F)}function B(){return Math.max(0,Date.now()-u.sessionStartedAtMs)}function Z(o,c=null){if(!u.isMetricSessionSampled||u.metricReportCount>=M.METRIC_REPORT_LIMIT)return!1;u.metricReportCount+=1;let h={type:"metric",message:T(o,400),stack:"",url:T(window.location.href,500),userAgent:T(navigator.userAgent||"",300),timestamp:new Date().toISOString(),context:{metricName:T(o,80),sessionElapsedMs:B(),mode:u.mode,...c&&typeof c=="object"?c:{}}};return ot(h),!0}function U(o,c){if(u.hasReportedFirstSuccessfulRenderMetric)return;u.hasReportedFirstSuccessfulRenderMetric=!0;let h=Array.isArray(o?.station?.departures)?o.station.departures:[];Z("first_successful_render",{requestMode:String(c||"").trim(),hasStation:!!o?.station,departureCount:h.length})}function lt(o,c=null){u.hasReportedFirstManualInteractionMetric||(u.hasReportedFirstManualInteractionMetric=!0,Z("first_manual_interaction",{interactionType:T(o,80),...c&&typeof c=="object"?c:{}}))}function g(o,c=null){u.hasReportedFirstManualStopContextMetric||(u.hasReportedFirstManualStopContextMetric=!0,Z("first_manual_stop_context_change",{changeType:T(o,80),lineFilterCount:u.busLineFilters.length,destinationFilterCount:u.busDestinationFilters.length,...c&&typeof c=="object"?c:{}}))}function tt(o,c){if(u.hasReportedInitialNearestStopResolvedMetric)return;let h=String(o?.selectedStopId||"").trim();if(!h)return;u.hasReportedInitialNearestStopResolvedMetric=!0;let F=(Array.isArray(o?.stops)?o.stops:[]).find(X=>X?.id===h)||null,V=Array.isArray(o?.station?.departures)?o.station.departures:[];Z("initial_nearest_stop_resolved",{requestMode:String(c||"").trim(),selectedStopId:h,distanceMeters:Number(F?.distanceMeters)||null,departureCount:V.length})}function j(o){if(!o)return null;let c=String(o).trim().toLowerCase();return c===n||c===e||c===N||c===$?c:null}function at(o){if(o==null)return null;let c=String(o).trim().toLowerCase();return["1","true","yes","on"].includes(c)?!0:["0","false","no","off"].includes(c)?!1:null}function W(o){return Array.isArray(o)?[...new Set(o.map(c=>String(c||"").trim()).filter(Boolean))]:[]}function H(o){if(o==null||o==="")return null;let c=Number(o);return!Number.isInteger(c)||!M.RESULT_LIMIT_OPTIONS.includes(c)?null:c}function P(o=u.mode){return o===$?M.DEFAULT_RESULTS_LIMIT_BUS:o===N?M.DEFAULT_RESULTS_LIMIT_METRO:o===e?M.DEFAULT_RESULTS_LIMIT_TRAM:M.DEFAULT_RESULTS_LIMIT_RAIL}function v(o=u.mode){let c=H(u.resultsLimitByMode?.[o]);return c??P(o)}function l(o){let c=R(o);if(!c)return[];try{let h=JSON.parse(c);return W(h)}catch{return[]}}function d(){let o=new URLSearchParams(window.location.search);return{mode:j(o.get("mode")),stopProvided:o.has("stop"),busStopId:o.get("stop")?o.get("stop").trim():null,linesProvided:o.has("line"),busLines:W(o.getAll("line")),destinationsProvided:o.has("dest"),busDestinations:W(o.getAll("dest")),resultsProvided:o.has("results"),resultsLimit:H(o.get("results"))}}function f(){let o=d(),c=j(R(M.STORAGE_MODE_KEY));u.mode=o.mode||c||n;let h=String(R(M.STORAGE_BUS_STOP_KEY)||"").trim()||null,I=o.stopProvided?o.busStopId:h,F=l(M.STORAGE_BUS_LINES_KEY),V=l(M.STORAGE_BUS_DESTINATIONS_KEY),X=o.linesProvided?o.busLines:F,it=o.destinationsProvided?o.busDestinations:V,et=!!I||X.length>0||it.length>0;u.deferInitialStopContext=et,et?(u.deferredBusStopId=I,u.deferredBusLineFilters=[...X],u.deferredBusDestinationFilters=[...it],u.busStopId=null,u.busLineFilters=[],u.busDestinationFilters=[]):(u.deferredBusStopId=null,u.deferredBusLineFilters=[],u.deferredBusDestinationFilters=[],u.busStopId=I,u.busLineFilters=X,u.busDestinationFilters=it);let mt=H(R(M.STORAGE_RESULTS_LIMIT_RAIL_KEY)),q=H(R(M.STORAGE_RESULTS_LIMIT_TRAM_KEY)),Y=H(R(M.STORAGE_RESULTS_LIMIT_METRO_KEY)),pt=H(R(M.STORAGE_RESULTS_LIMIT_BUS_KEY));u.resultsLimitByMode[n]=mt??M.DEFAULT_RESULTS_LIMIT_RAIL,u.resultsLimitByMode[e]=q??M.DEFAULT_RESULTS_LIMIT_TRAM,u.resultsLimitByMode[N]=Y??M.DEFAULT_RESULTS_LIMIT_METRO,u.resultsLimitByMode[$]=pt??M.DEFAULT_RESULTS_LIMIT_BUS,o.resultsProvided&&o.resultsLimit!=null&&(u.resultsLimitByMode[u.mode]=o.resultsLimit)}function E(){w(M.STORAGE_MODE_KEY,u.mode),w(M.STORAGE_BUS_STOP_KEY,u.busStopId||""),w(M.STORAGE_BUS_LINES_KEY,JSON.stringify(u.busLineFilters)),w(M.STORAGE_BUS_DESTINATIONS_KEY,JSON.stringify(u.busDestinationFilters)),w(M.STORAGE_RESULTS_LIMIT_RAIL_KEY,String(v(n))),w(M.STORAGE_RESULTS_LIMIT_TRAM_KEY,String(v(e))),w(M.STORAGE_RESULTS_LIMIT_METRO_KEY,String(v(N))),w(M.STORAGE_RESULTS_LIMIT_BUS_KEY,String(v($)))}function L(){let o=new URLSearchParams(window.location.search);u.mode===n?o.delete("mode"):o.set("mode",u.mode);let c=v(),h=P();if(c===h?o.delete("results"):o.set("results",String(c)),o.delete("stop"),o.delete("line"),o.delete("dest"),u.mode===$||u.mode===e||u.mode===N||u.mode===n){u.busStopId&&o.set("stop",u.busStopId);for(let V of u.busLineFilters)o.append("line",V);for(let V of u.busDestinationFilters)o.append("dest",V)}let I=o.toString(),F=`${window.location.pathname}${I?`?${I}`:""}${window.location.hash}`;window.history.replaceState(null,"",F)}function y(){E(),L()}G(),Object.assign(r,{updateLocationActionButtons:G,setLoading:ut,setVoiceListening:st,setStatus:Q,setResolvedLocationHint:m,showLocationPrompt:p,hideLocationPrompt:k,setPermissionRequired:_,setLastUpdated:A,getStorageItem:R,setStorageItem:w,safeString:T,toError:K,sendClientReport:ot,reportClientError:x,reportClientMetric:Z,getSessionElapsedMs:B,trackFirstSuccessfulRender:U,trackFirstManualInteraction:lt,trackFirstManualStopContextChange:g,trackInitialNearestStopResolved:tt,normalizeMode:j,parseBoolean:at,uniqueNonEmptyStrings:W,parseResultLimit:H,getDefaultResultsLimit:P,getActiveResultsLimit:v,parseStoredArray:l,readStateFromUrl:d,hydrateInitialState:f,syncStateToStorage:E,syncStateToUrl:L,persistUiState:y})})();(()=>{let D=window.HMApp,{api:r,dom:n,state:e,constants:N}=D,{MODE_RAIL:$,MODE_TRAM:C,MODE_METRO:u,MODE_BUS:M}=N,G=1500,ut=G+200,st=14,Q=1300,J=null,m=null;function p(t=e.mode){return t===M||t===C||t===u||t===$}function k(t=e.mode){return t===$}function _(t=e.mode){return t===$?{singular:"train",plural:"trains",title:"Rail"}:t===C?{singular:"tram",plural:"trams",title:"Tram"}:t===u?{singular:"metro",plural:"metros",title:"Metro"}:{singular:"bus",plural:"buses",title:"Bus"}}function A(t){let i=R(t);return i<=0?"Now":`${i}m`}function R(t){let i=new Date(t);return Math.floor((i.getTime()-Date.now())/6e4)}function w(t){let i=R(t);return i<=0||i<3?"departure-now":i<=10?"departure-soon":"departure-later"}function T(){let t=new Set((e.busFilterOptions.lines||[]).map(s=>s.value)),i=new Set((e.busFilterOptions.destinations||[]).map(s=>s.value));e.busLineFilters=e.busLineFilters.filter(s=>t.has(s)),e.busDestinationFilters=e.busDestinationFilters.filter(s=>i.has(s))}function K(t){if(!Array.isArray(t))return[];if(!p())return t;let i=new Set(e.busLineFilters),s=new Set(e.busDestinationFilters),a=String(e.busStopMemberFilterId||"").trim();return t.filter(S=>{if(i.size===0)return!0;let b=String(S?.line||"").trim();return i.has(b)}).filter(S=>{if(s.size===0)return!0;let b=String(S?.destination||"").trim();return s.has(b)}).filter(S=>a?String(S?.stopId||"").trim()===a:!0)}function ot(){let t=[{el:n.modeRailBtn,mode:$,index:0},{el:n.modeTramBtn,mode:C,index:1},{el:n.modeMetroBtn,mode:u,index:2},{el:n.modeBusBtn,mode:M,index:3}];for(let{el:i,mode:s,index:a}of t){if(!i)continue;let S=e.mode===s;if(i.setAttribute("aria-checked",String(S)),i.classList.toggle("is-active",S),S){let b=i.closest(".segment-control");b&&b.style.setProperty("--active-index",a)}}}function x(){n.modeEyebrowEl&&(n.modeEyebrowEl.textContent="Helsinki Moves"),n.nextLabelEl&&(n.nextLabelEl.textContent="")}function B(t){if(!n.resultsLimitSelectEl||!n.resultsLimitSelectListEl)return;let i=n.resultsLimitSelectEl.getAttribute("aria-expanded")==="true",s=typeof t=="boolean"?t:!i;n.resultsLimitSelectEl.setAttribute("aria-expanded",String(s)),n.resultsLimitSelectListEl.classList.toggle("hidden",!s)}function Z(t){let i=r.parseResultLimit(t);i==null||(B(!1),r.getActiveResultsLimit()===i)||(r.trackFirstManualInteraction("results_limit_change",{nextLimit:i,currentMode:e.mode}),e.resultsLimitByMode[e.mode]=i,r.persistUiState(),n.resultsLimitSelectLabelEl&&(n.resultsLimitSelectLabelEl.textContent=String(i)),e.currentCoords?r.load(e.currentCoords.lat,e.currentCoords.lon):r.requestLocationAndLoad())}function U(){if(!n.resultsLimitSelectListEl)return;let t=Array.isArray(N.RESULT_LIMIT_OPTIONS)?N.RESULT_LIMIT_OPTIONS:[],i=r.getActiveResultsLimit();n.resultsLimitSelectListEl.innerHTML="";for(let s of t){let a=document.createElement("li");a.setAttribute("role","option"),a.dataset.value=String(s),a.textContent=String(s),s===i&&a.setAttribute("aria-selected","true"),a.addEventListener("click",()=>Z(String(s))),n.resultsLimitSelectListEl.appendChild(a)}n.resultsLimitSelectLabelEl&&(n.resultsLimitSelectLabelEl.textContent=String(i))}function lt(){let t=tt()?1:0;return Math.max(0,e.busLineFilters.length)+Math.max(0,e.busDestinationFilters.length)+t}function g(t=e.busLineFilters.length,i=e.busDestinationFilters.length,s=tt()){let a=Math.max(0,Number(t)||0)+Math.max(0,Number(i)||0)+(s?1:0);return a===0?"No filters":a===1?"1 filter":`${a} filters`}function tt(){return p()?!!(e.stopFilterPinned||String(e.busStopMemberFilterId||"").trim()):!1}function j(){n.stopFilterSummaryEl?.classList?.remove?.("is-attention"),n.stopFiltersToggleBtnEl?.classList?.remove?.("is-attention")}function at(){m&&(clearTimeout(m),m=null)}function W(){if(typeof window?.matchMedia=="function")try{if(window.matchMedia("(max-width: 679px)").matches)return!0}catch{}let t=Number(window?.innerWidth);return Number.isFinite(t)?t<=679:!1}function H(){if(W())return!1;let t=Array.isArray(e.busFilterOptions?.lines)?e.busFilterOptions.lines.length:0,i=Array.isArray(e.busFilterOptions?.destinations)?e.busFilterOptions.destinations.length:0;return t+i<=st}function P(){if(!p())return;!e.stopFiltersPanelOpen&&H()?(e.stopFiltersPanelLockUntilMs=Date.now()+G,d(!0),at(),m=setTimeout(()=>{e.stopFiltersPanelLockUntilMs=0,d(!1),m=null},ut)):e.stopFiltersPanelLockUntilMs=0,j(),n.stopFilterSummaryEl?.classList?.add?.("is-attention"),n.stopFiltersToggleBtnEl?.classList?.add?.("is-attention"),J&&(clearTimeout(J),J=null),J=setTimeout(()=>{j(),J=null},Q)}function v(){return Number(e.stopFiltersPanelLockUntilMs||0)>Date.now()}function l(){n.stopFilterSummaryEl&&(n.stopFilterSummaryEl.textContent=g()),n.busStopSelectEl&&n.busStopSelectEl.classList.toggle("is-active-filter",tt()),!(!n.stopFiltersToggleBtnEl||!n.stopFiltersPanelEl)&&(n.stopFiltersToggleBtnEl.setAttribute("aria-expanded",String(!!e.stopFiltersPanelOpen)),n.stopFiltersPanelEl.classList.toggle("hidden",!e.stopFiltersPanelOpen))}function d(t){e.stopFiltersPanelOpen=!!t,l()}function f(t){if(at(),(t===!1||t==null&&e.stopFiltersPanelOpen)&&v())return;let i=typeof t=="boolean"?t:!e.stopFiltersPanelOpen;d(i)}function E(t){n.busControlsEl&&(n.busControlsEl.classList.toggle("hidden",!t),n.busStopSelectWrapEl?.classList?.toggle?.("hidden",!t),n.stationTitleEl?.classList?.toggle?.("hidden",t),t||(at(),e.stopFiltersPanelOpen=!1,e.stopFiltersPanelLockUntilMs=0,j(),n.busStopSelectEl?.classList?.remove?.("is-active-filter"),yt(!1)),l())}function L(){e.latestResponse&&(r.render(e.latestResponse),r.setStatus(""))}function y({interactionType:t,changeType:i,showAttention:s=!1,requireLoad:a=!1,extraContext:S=null}){if(r.trackFirstManualInteraction(t,{currentMode:e.mode,...S&&typeof S=="object"?S:{}}),r.trackFirstManualStopContextChange(i,S),r.persistUiState(),l(),s&&P(),a){e.currentCoords?r.load(e.currentCoords.lat,e.currentCoords.lon):r.requestLocationAndLoad();return}L()}function o(t,i){let s=String(i||"").trim();return s?t.includes(s)?t.filter(a=>a!==s):[...t,s]:t}function c(t,{interactionType:i="line_filter_toggle",changeType:s="line_filter_toggle",showAttention:a=!1}={}){if(!p())return!1;let S=o(e.busLineFilters,t);return S.length===e.busLineFilters.length?!1:(e.busLineFilters=S,y({interactionType:i,changeType:s,showAttention:a}),!0)}function h(t,{interactionType:i="destination_filter_toggle",changeType:s="destination_filter_toggle",showAttention:a=!1}={}){if(!p())return!1;let S=o(e.busDestinationFilters,t);return S.length===e.busDestinationFilters.length?!1:(e.busDestinationFilters=S,y({interactionType:i,changeType:s,showAttention:a}),!0)}function I(t){return e.busStops.find(i=>i.id===t)||null}function F(t){let i=r.uniqueNonEmptyStrings([...Array.isArray(t?.stopCodes)?t.stopCodes:[],t?.code]);return i.length===0&&t?.id&&i.push(String(t.id)),i}function V(t){return r.uniqueNonEmptyStrings([...Array.isArray(t?.memberStopIds)?t.memberStopIds:[],t?.id])}function X(t,i=null){let s=I(e.busStopId),a=String(i?.stopName||t?.stopName||s?.name||"").trim(),b=r.uniqueNonEmptyStrings([i?.stopCode,...Array.isArray(t?.stopCodes)?t.stopCodes:[],t?.stopCode,...F(s)])[0]||"";return a&&b?`${a} ${b}`:a||b||"\u2014"}function it(t,i=null){if(p())return X(t,i);let s=String(i?.stopName||t?.stopName||"").trim(),a=String(i?.stopCode||t?.stopCode||"").trim();return s&&a?`${s} ${a}`:s||a||"\u2014"}function et(){if(n.dataScopeEl){if(typeof n.dataScopeEl.replaceChildren=="function"){n.dataScopeEl.replaceChildren();return}Array.isArray(n.dataScopeEl.children)&&(n.dataScopeEl.children.length=0),n.dataScopeEl.innerHTML=""}}function mt(t,i="default"){let s=document.createElement("span");return s.className="data-scope-chip",i&&s.classList.add(`data-scope-chip--${i}`),s.textContent=t,s}function q(t){let i=String(e.busStopMemberFilterId||"").trim();if(i){let b=(Array.isArray(t?.station?.departures)?t.station.departures:[]).find(z=>String(z?.stopId||"").trim()===i),O=String(b?.stopCode||"").trim();return O||i}if(!e.stopFilterPinned)return"";let s=I(e.busStopId),a=String(F(s)[0]||"").trim();return a||String(s?.name||e.busStopId||"").trim()}function Y(t){if(!n.dataScopeEl)return;if(et(),n.dataScopeEl.textContent="",!p()){n.dataScopeEl.classList.add("hidden");return}let i=[],s=q(t);s&&i.push(mt(s,"stop"));for(let a of e.busLineFilters)i.push(mt(a,"line"));for(let a of e.busDestinationFilters)i.push(mt(a,"destination"));if(i.length===0){n.dataScopeEl.classList.add("hidden");return}for(let a of i)n.dataScopeEl.appendChild(a);n.dataScopeEl.classList.remove("hidden")}function pt(t,i,s,a){if(!t)return;if(t.innerHTML="",!Array.isArray(i)||i.length===0){let b=document.createElement("span");b.className="chip-empty",b.textContent="No options",t.appendChild(b);return}let S=new Set(s);for(let b of i){let O=document.createElement("button");O.type="button",O.className="chip-toggle",S.has(b.value)?(O.classList.add("is-active"),O.setAttribute("aria-pressed","true")):O.setAttribute("aria-pressed","false"),O.textContent=`${b.value} (${b.count})`,O.addEventListener("click",()=>a(b.value)),t.appendChild(O)}}function bt(){let t=Array.isArray(e.latestResponse?.station?.departures)?e.latestResponse.station.departures:[],i=new Map;for(let s of t){let a=String(s?.stopId||"").trim();if(!a)continue;let S=i.get(a);S?(S.count+=1,S.stopCode||(S.stopCode=String(s?.stopCode||"").trim()),S.stopName||(S.stopName=String(s?.stopName||"").trim())):i.set(a,{id:a,count:1,stopCode:String(s?.stopCode||"").trim(),stopName:String(s?.stopName||"").trim()})}return[...i.values()].sort((s,a)=>a.count-s.count||s.id.localeCompare(a.id)).map(s=>{let a=gt({stopId:s.id,stopCode:s.stopCode||"",stopName:s.stopName||""},e.latestResponse?.station||null);return{...s,selectableStopId:a.selectableStopId}})}function Bt(){if(!n.busStopFiltersEl)return;n.busStopFiltersEl.innerHTML="";let t=bt();if(t.length===0){let s=document.createElement("span");s.className="chip-empty",s.textContent="No stops",n.busStopFiltersEl.appendChild(s);return}let i=String(e.busStopMemberFilterId||"").trim();for(let s of t){let a=document.createElement("button");a.type="button",a.className="chip-toggle",a.dataset.value=s.id,!!(i&&s.id===i)?(a.classList.add("is-active"),a.setAttribute("aria-pressed","true")):a.setAttribute("aria-pressed","false");let b=s.stopCode||s.id;a.textContent=b,a.addEventListener("click",()=>vt(s.selectableStopId,s.id)),n.busStopFiltersEl.appendChild(a)}}function yt(t){if(!n.busStopSelectEl||!n.busStopSelectListEl)return;let i=n.busStopSelectEl.getAttribute("aria-expanded")==="true",s=typeof t=="boolean"?t:!i;n.busStopSelectEl.setAttribute("aria-expanded",String(s)),n.busStopSelectListEl.classList.toggle("hidden",!s)}function Tt(t){if(!e.suppressBusStopChange){if(!t||t===e.busStopId){yt(!1);return}if(e.busStopId=t,e.stopFilterPinned=!0,e.busStopMemberFilterId=null,yt(!1),n.busStopSelectLabelEl){let i=e.busStops.find(s=>s.id===t);n.busStopSelectLabelEl.textContent=i?i.name:t}y({interactionType:"stop_select",changeType:"stop_select",requireLoad:!0,extraContext:{selectedStopId:t}})}}function Ct(){return e.busStops[0]?.id||null}function _t(t,i=null){let s=String(t||"").trim();if(!s||!e.stopFilterPinned||String(e.busStopId||"").trim()!==s)return!1;let S=String(e.busStopMemberFilterId||"").trim(),b=String(i||"").trim();return b?S===b:!S}function vt(t,i=null){if(!p())return!1;let s=String(t||"").trim()||null,a=String(i||"").trim()||null,S=String(e.busStopId||"").trim()||null,b=String(e.busStopMemberFilterId||"").trim()||null,O=Ct(),z=s||S||O;if(!z)return!1;let ft=!!e.stopFilterPinned,St=_t(z,a),nt=S,dt=ft,ct=b;St?(dt=!1,ct=null,nt=O||z):(nt=z,dt=!0,ct=a);let Et=nt!==S;if(nt===S&&dt===ft&&ct===b)return!1;if(e.busStopId=nt,e.stopFilterPinned=dt,e.busStopMemberFilterId=ct,n.busStopSelectLabelEl){let Lt=I(e.busStopId);n.busStopSelectLabelEl.textContent=Lt?Lt.name:"Nearest stop"}return y({interactionType:"result_card_stop_toggle",changeType:"result_card_stop_toggle",showAttention:!0,requireLoad:Et,extraContext:{selectedStopId:e.busStopId||"",selectedMemberStopId:e.busStopMemberFilterId||""}}),!0}function gt(t,i=null){let s=String(t?.stopId||"").trim();if(s){let S=e.busStops.find(b=>V(b).includes(s));if(S?.id)return{selectableStopId:S.id,memberStopId:s}}let a=r.uniqueNonEmptyStrings([t?.stopCode,...Array.isArray(i?.stopCodes)?i.stopCodes:[],i?.stopCode]);for(let S of a){let b=e.busStops.find(O=>F(O).includes(S));if(b?.id)return{selectableStopId:b.id,memberStopId:s||null}}return{selectableStopId:e.busStopId||Ct(),memberStopId:s||null}}function xt(t,i=null){return gt(t,i).selectableStopId}function rt(t){t&&(t.classList?.remove?.("result-filter-trigger","is-active"),t.removeAttribute?.("role"),t.removeAttribute?.("tabindex"),t.removeAttribute?.("aria-pressed"),t.removeAttribute?.("aria-label"),t.onclick=null,t.onkeydown=null)}function It(t,{active:i=!1,onActivate:s,ariaLabel:a}){if(!t||typeof s!="function"){rt(t);return}t.classList?.add?.("result-filter-trigger"),t.classList?.toggle?.("is-active",!!i),t.setAttribute?.("role","button"),t.setAttribute?.("tabindex","0"),t.setAttribute?.("aria-pressed",String(!!i)),t.setAttribute?.("aria-label",String(a||"Toggle filter"));let S=()=>s();t.onclick=()=>S(),t.onkeydown=b=>{let O=b?.key;O!=="Enter"&&O!==" "&&O!=="Spacebar"||(b?.preventDefault?.(),S())}}function Mt(t,i){let s=String(i||"").trim();if(!p()||!s){rt(t);return}It(t,{active:e.busLineFilters.includes(s),onActivate:()=>wt(s),ariaLabel:`Toggle line filter ${s}`})}function Rt(t,i){let s=String(i||"").trim();if(!p()||!s){rt(t);return}It(t,{active:e.busDestinationFilters.includes(s),onActivate:()=>At(s),ariaLabel:`Toggle destination filter ${s}`})}function Ft(t,i,s){if(!p()){rt(t);return}It(t,{active:_t(i,s),onActivate:()=>vt(i,s),ariaLabel:"Toggle stop filter"})}function wt(t){return c(t,{interactionType:"result_card_line_toggle",changeType:"result_card_line_toggle",showAttention:!0})}function At(t){return h(t,{interactionType:"result_card_destination_toggle",changeType:"result_card_destination_toggle",showAttention:!0})}function Ot(){let t=p();if(E(t),!!t){if(l(),n.busStopSelectListEl){if(e.suppressBusStopChange=!0,n.busStopSelectListEl.innerHTML="",e.busStops.length===0)n.busStopSelectLabelEl&&(n.busStopSelectLabelEl.textContent=`No nearby ${_().singular} stops`),n.busStopSelectEl&&(n.busStopSelectEl.disabled=!0);else{n.busStopSelectEl&&(n.busStopSelectEl.disabled=!1);let i=e.busStopId;(!i||!e.busStops.some(s=>s.id===i))&&(i=e.busStops[0].id);for(let s of e.busStops){let a=document.createElement("li");a.setAttribute("role","option"),a.dataset.value=s.id,a.textContent=`${s.name} (${s.distanceMeters}m)`,s.id===i&&a.setAttribute("aria-selected","true"),a.addEventListener("click",()=>Tt(s.id)),n.busStopSelectListEl.appendChild(a)}if(n.busStopSelectLabelEl){let s=e.busStops.find(a=>a.id===i);n.busStopSelectLabelEl.textContent=s?s.name:"Select stop"}}e.suppressBusStopChange=!1}Bt(),pt(n.busLineFiltersEl,e.busFilterOptions.lines,e.busLineFilters,i=>c(i)),pt(n.busDestinationFiltersEl,e.busFilterOptions.destinations,e.busDestinationFilters,i=>h(i))}}function ht(t,i=null){if(!n.nextSummaryEl||!n.nextMinsEl||!n.nextLineEl||!n.nextTrackEl||!n.nextDestinationEl)return;if(!t){n.nextSummaryEl.classList.add("hidden"),n.nextSummaryEl.classList.remove("next-summary-now","next-summary-soon","next-summary-later"),rt(n.nextLineEl),rt(n.nextDestinationEl),rt(n.nextTrackEl);return}let s=R(t.departureIso);if(n.nextMinsEl.textContent=A(t.departureIso),n.nextLineEl.textContent=t.line||"\u2014",n.nextLineEl.classList.toggle("next-letter-now",s<3),n.nextTrackEl.textContent=k()?t.track?`Track ${t.track}`:"Track \u2014":p()?it(i,t):t.track?`Track ${t.track}`:"Track \u2014",n.nextDestinationEl.textContent=t.destination||"\u2014",p()){let a=gt(t,i);Mt(n.nextLineEl,t.line),Rt(n.nextDestinationEl,t.destination),Ft(n.nextTrackEl,a.selectableStopId,a.memberStopId)}else rt(n.nextLineEl),rt(n.nextDestinationEl),rt(n.nextTrackEl);n.nextSummaryEl.classList.remove("next-summary-now","next-summary-soon","next-summary-later"),s<3?n.nextSummaryEl.classList.add("next-summary-now"):s<=10?n.nextSummaryEl.classList.add("next-summary-soon"):n.nextSummaryEl.classList.add("next-summary-later"),n.nextSummaryEl.classList.remove("hidden")}function Nt(t){if(!t||!t.station)return p()?t?.message||`No nearby ${_().singular} stops found.`:t?.message||"No nearby train stations found.";let s=K(t.station.departures)[0];if(!s)return p()?e.busLineFilters.length>0||e.busDestinationFilters.length>0||tt()?`No upcoming ${_().plural} match selected filters.`:"No upcoming departures from this stop.":"No upcoming commuter trains right now.";let a=_().singular;return`${a.charAt(0).toUpperCase()+a.slice(1)} in ${A(s.departureIso)}`}function Ut(t){if(!(t instanceof Error))return"Could not refresh departures. Please try again.";if(t.name==="AbortError")return"Request timed out. Please try again.";let i=(t.message||"").trim();return i==="Temporary server error. Please try again."?i:i==="Invalid lat/lon"?"Location coordinates were invalid. Please refresh your location.":i==="Invalid mode"?"Unsupported transport mode.":"Could not refresh departures. Please try again."}function Pt(t){return t?.code===1?"Location permission denied.":t?.code===2?"Location unavailable. Please try again.":t?.code===3?"Location request timed out. Please try again.":"Unable to get your location."}function Dt(t){let i=String(t?.code||"").trim();return i==="voice_unsupported"?"Voice location is not supported in this browser.":i==="voice_permission_denied"?"Microphone permission denied.":i==="voice_no_microphone"?"No microphone was found for voice location.":i==="voice_no_speech"?"No speech detected. Please try again.":i==="voice_recognition_timeout"?"Voice listening timed out. Please try again.":i==="voice_language_not_supported"?"Voice language was not supported on this device.":i==="voice_query_too_short"?"Please describe your location with a few words.":i==="voice_location_not_found"?"Could not match that place. Try a nearby landmark or street.":i==="voice_location_selection_cancelled"?"Location selection was cancelled.":i==="voice_location_selection_invalid"?"Please choose one of the suggested locations.":i==="voice_recognition_network"?"Voice recognition failed due to a network error. On iPhone, try enabling Siri & Dictation.":"Could not use voice location. Please try again."}function Vt(){n.skeletonEl&&n.skeletonEl.classList.remove("hidden")}function kt(){n.skeletonEl&&n.skeletonEl.classList.add("hidden")}function qt(t){return String(t||"").trim()==="200"}function $t(t){if(kt(),Ot(),Y(t),!t||!t.station){n.resultEl.classList.add("hidden"),ht(null);return}let i=t.station;n.resultEl.classList.remove("hidden"),n.stationTitleEl.textContent=i.stopName,n.stationMetaEl.textContent=`${i.distanceMeters}m away`,n.departuresEl.innerHTML="";let s=K(i.departures);if(s.length===0){ht(null);let S=document.createElement("li");S.className="empty-row",p()?S.textContent=e.busLineFilters.length>0||e.busDestinationFilters.length>0||tt()?`No upcoming ${_().plural} match selected filters.`:"No upcoming departures from this stop.":S.textContent="No upcoming commuter trains right now.",n.departuresEl.appendChild(S);return}ht(null);let a=s;for(let S=0;S<a.length;S++){let b=a[S],O=document.createElement("li");O.className=`departure-row ${w(b.departureIso)}`,O.style.setProperty("--i",S);let z=document.createElement("div");z.className="letter-badge route-badge",z.textContent=b.line||"?",qt(b.line)&&z.classList.add("route-badge-cool"),p()&&Mt(z,b.line);let ft=document.createElement("div");ft.className="train departure-main";let St=document.createElement("div");St.className="destination",St.textContent=b.destination||"\u2014",p()&&Rt(St,b.destination),ft.appendChild(St);let nt=document.createElement("span");if(nt.className="track",k())nt.textContent=b.track?`Track ${b.track}`:"Track \u2014";else if(p()){nt.textContent=it(i,b);let Lt=gt(b,i);Ft(nt,Lt.selectableStopId,Lt.memberStopId)}else nt.textContent=b.track?`Track ${b.track}`:"Track \u2014";ft.appendChild(nt);let dt=document.createElement("div");dt.className="time departure-timing";let ct=document.createElement("span");ct.className="remaining",ct.textContent=A(b.departureIso),ct.classList.toggle("time-now",ct.textContent==="Now");let Et=document.createElement("span");Et.className="clock-time",Et.textContent=new Date(b.departureIso).toLocaleTimeString([],{hour:"2-digit",minute:"2-digit",hour12:!1}),dt.appendChild(ct),dt.appendChild(Et),O.appendChild(z),O.appendChild(ft),O.appendChild(dt),n.departuresEl.appendChild(O)}}function Yt(){n.nowClockEl&&(n.nowClockEl.textContent=new Date().toLocaleTimeString([],{hour:"2-digit",minute:"2-digit",second:"2-digit",hour12:!1}))}Object.assign(r,{formatMinutes:A,minutesUntil:R,departureRowClass:w,sanitizeStopSelections:T,getVisibleDepartures:K,updateModeButtons:ot,updateModeLabels:x,toggleResultsLimitDropdown:B,selectResultsLimit:Z,renderResultsLimitControl:U,countActiveStopFilters:lt,buildStopFilterSummary:g,syncStopFiltersPanelUi:l,setStopFiltersPanelOpen:d,toggleStopFiltersPanel:f,setStopControlsVisibility:E,getStopMeta:I,getStopCodes:F,buildStopDisplay:X,buildModeStopDisplay:it,updateDataScope:Y,renderFilterButtons:pt,toggleStopDropdown:yt,selectStop:Tt,toggleLineFilter:c,toggleDestinationFilter:h,toggleLineFilterFromResultCard:wt,toggleDestinationFilterFromResultCard:At,toggleStopFromResultCard:vt,isStopTargetActive:_t,resolveStopTargetFromDeparture:gt,resolveStopIdFromDeparture:xt,setResultFilterTrigger:It,clearResultFilterTrigger:rt,triggerStopFilterAttention:P,renderStopControls:Ot,updateNextSummary:ht,buildStatusFromResponse:Nt,getLoadErrorStatus:Ut,getGeolocationErrorStatus:Pt,getVoiceLocationErrorStatus:Dt,showSkeleton:Vt,hideSkeleton:kt,render:$t,updateClock:Yt})})();(()=>{let D=window.HMApp,{api:r,dom:n,state:e,constants:N}=D,{MODE_RAIL:$,MODE_TRAM:C,MODE_METRO:u,MODE_BUS:M}=N;function G(l){return l===M||l===C||l===u||l===$}function ut(l){return new Promise(d=>setTimeout(d,l))}async function st(l,d={},f=N.FETCH_TIMEOUT_MS){let E=new AbortController,L=setTimeout(()=>E.abort(),f);try{return await fetch(l,{...d,signal:E.signal})}finally{clearTimeout(L)}}async function Q(l,d={}){let f;try{f=await st(l,d)}catch{return await ut(350),st(l,d)}return f.status>=500?(await ut(350),st(l,d)):f}function J(l){let d=new Map,f=new Map;for(let L of l||[]){let y=String(L?.line||"").trim();y&&d.set(y,(d.get(y)||0)+1);let o=String(L?.destination||"").trim();o&&f.set(o,(f.get(o)||0)+1)}let E=L=>[...L.entries()].sort((y,o)=>o[1]-y[1]||y[0].localeCompare(o[0])).map(([y,o])=>({value:y,count:o}));return{lines:E(d),destinations:E(f)}}function m(l){let d=Array.isArray(l?.stops)?l.stops.filter(I=>I&&I.id&&I.name).map(I=>({id:I.id,name:I.name,code:String(I.code||"").trim()||null,memberStopIds:r.uniqueNonEmptyStrings([...Array.isArray(I.memberStopIds)?I.memberStopIds:[],I.id]),stopCodes:r.uniqueNonEmptyStrings([...Array.isArray(I.stopCodes)?I.stopCodes:[],I.code]),distanceMeters:Number(I.distanceMeters)||0})):[];e.busStops=d;let f=String(l?.selectedStopId||"").trim()||null,E=I=>d.some(F=>F.id===I),L=String(e.busStopId||"").trim()||null,y=!!(L&&!E(L)&&!(f&&E(f)));f&&E(f)?e.busStopId=f:(!e.busStopId||!E(e.busStopId))&&(e.busStopId=d[0]?.id||null);let o=d[0]?.id||null;e.busStopId?o&&e.busStopId!==o?e.stopFilterPinned=!0:y&&(e.stopFilterPinned=!1):e.stopFilterPinned=!1,e.deferInitialStopContext&&(e.deferInitialStopContext=!1,e.deferredBusStopId=null,e.deferredBusLineFilters=[],e.deferredBusDestinationFilters=[],e.busLineFilters=[],e.busDestinationFilters=[],e.stopFilterPinned=!1,e.busStopMemberFilterId=null),e.hasCompletedInitialStopModeLoad=!0;let c=Array.isArray(l?.station?.departures)?l.station.departures:[],h=new Set(c.map(I=>String(I?.stopId||"").trim()).filter(Boolean));e.stopFilterPinned?e.busStopMemberFilterId&&!h.has(String(e.busStopMemberFilterId).trim())&&(e.busStopMemberFilterId=null):e.busStopMemberFilterId=null,e.busFilterOptions=J(c),r.sanitizeStopSelections()}function p(l,d){let f=new Error(d);return f.code=l,f}function k(l){return String(l?.code||"").trim().toLowerCase()}function _(){return r.uniqueNonEmptyStrings(["fi-FI","en-US",...Array.isArray(navigator.languages)?navigator.languages:[],navigator.language])}function A(){return typeof window.SpeechRecognition=="function"?window.SpeechRecognition:typeof window.webkitSpeechRecognition=="function"?window.webkitSpeechRecognition:null}function R(){return!!A()}function w(l){return l==="not-allowed"||l==="service-not-allowed"?p("voice_permission_denied","Microphone permission denied."):l==="audio-capture"?p("voice_no_microphone","No microphone available."):l==="language-not-supported"?p("voice_language_not_supported","Speech language is not supported."):l==="network"?p("voice_recognition_network","Voice recognition network error."):l==="no-speech"?p("voice_no_speech","No speech detected."):p("voice_not_understood","Voice recognition failed.")}function T(l){let d=A();return d?new Promise((f,E)=>{let L=new d,y=String(l||navigator.language||"fi-FI").trim();L.lang=y||"fi-FI",L.continuous=!1,L.interimResults=!0,L.maxAlternatives=1;let o=!1,c="",h=null,I=!1,F=()=>{clearTimeout(h),h=null},V=()=>{if(!(I||o)){I=!0;try{L.stop()}catch{}}},X=()=>{F(),h=setTimeout(V,N.VOICE_SILENCE_STOP_MS)},it=()=>{clearTimeout(mt),F(),L.onresult=null,L.onerror=null,L.onend=null,L.onspeechend=null,L.onsoundend=null,L.onaudioend=null,L.onnomatch=null},et=(q,Y)=>{o||(o=!0,it(),q(Y))},mt=setTimeout(()=>{try{L.abort()}catch{}et(E,p("voice_recognition_timeout","Voice recognition timed out."))},N.VOICE_RECOGNITION_TIMEOUT_MS);L.onresult=q=>{for(let Y=q?.resultIndex||0;Y<(q?.results?.length||0);Y+=1){let pt=q.results[Y],bt=String(pt?.[0]?.transcript||"").trim();if(bt&&(c=bt,X(),pt?.isFinal)){V();return}}},L.onerror=q=>{let Y=String(q?.error||"").trim().toLowerCase();et(E,w(Y))},L.onend=()=>{if(o)return;let q=String(c||"").trim();if(!q){et(E,p("voice_no_speech","No speech detected."));return}et(f,q)},L.onspeechend=()=>{V()},L.onsoundend=()=>{X()},L.onaudioend=()=>{X()},L.onnomatch=()=>{et(E,p("voice_not_understood","Could not understand speech."))};try{L.start()}catch(q){let Y=String(q?.name||"").trim().toLowerCase();if(Y==="notallowederror"||Y==="securityerror"){et(E,p("voice_permission_denied","Microphone permission denied."));return}et(E,p("voice_not_understood","Unable to start voice recognition."))}}):Promise.reject(p("voice_unsupported","Voice recognition not supported."))}function K(l){return l==="voice_no_speech"||l==="voice_not_understood"||l==="voice_recognition_timeout"||l==="voice_language_not_supported"}async function ot(){let l=_(),d=null;for(let f of l)try{return await T(f)}catch(E){if(d=E,!K(k(E)))break}throw d||p("voice_not_understood","Voice recognition failed.")}function x(l){return Array.isArray(l)?l.map(d=>{let f=Number(d?.lat),E=Number(d?.lon);return!Number.isFinite(f)||!Number.isFinite(E)?null:{lat:f,lon:E,label:String(d?.label||"").trim()}}).filter(Boolean):[]}function B(){n.voiceLocationChoicesEl&&n.voiceLocationChoicesEl.classList.add("hidden"),n.voiceLocationChoicesTitleEl&&(n.voiceLocationChoicesTitleEl.textContent=""),n.voiceLocationChoicesOptionsEl&&(n.voiceLocationChoicesOptionsEl.innerHTML=""),n.voiceLocationChoicesCancelEl&&(n.voiceLocationChoicesCancelEl.onclick=null)}function Z(l,d){if(typeof window.prompt!="function")throw p("voice_location_selection_cancelled","Location selection was cancelled.");let f=d.map((y,o)=>`${o+1}. ${y.label||`${y.lat}, ${y.lon}`}`).join(`
`),E=window.prompt(`Multiple matches found for "${r.safeString(l,80)}". Select number:
${f}`,"1");if(E==null)throw p("voice_location_selection_cancelled","Location selection was cancelled.");let L=Number.parseInt(String(E).trim(),10);if(!Number.isInteger(L)||L<1||L>d.length)throw p("voice_location_selection_invalid","Invalid location selection.");return d[L-1]}async function U(l,d){if(!Array.isArray(d)||d.length===0)throw p("voice_location_not_found","No matching location found.");return!n.voiceLocationChoicesEl||!n.voiceLocationChoicesTitleEl||!n.voiceLocationChoicesOptionsEl||!n.voiceLocationChoicesCancelEl?Z(l,d):new Promise((f,E)=>{let L=!1,y=(o,c)=>{L||(L=!0,B(),o(c))};n.voiceLocationChoicesTitleEl.textContent=`Multiple matches for "${r.safeString(l,80)}". Choose one:`,r.setStatus("Multiple matches found. Choose one below."),n.voiceLocationChoicesOptionsEl.innerHTML="";for(let o of d){let c=document.createElement("button");c.type="button",c.className="voice-location-choice-option",c.textContent=o.label||`${o.lat.toFixed(5)}, ${o.lon.toFixed(5)}`,c.addEventListener("click",()=>y(f,o),{once:!0}),n.voiceLocationChoicesOptionsEl.appendChild(c)}n.voiceLocationChoicesCancelEl.onclick=()=>y(E,p("voice_location_selection_cancelled","Location selection was cancelled.")),n.voiceLocationChoicesEl.classList.remove("hidden")})}async function lt(l){let d=String(l||"").trim();if(d.length<N.VOICE_QUERY_MIN_LENGTH)throw p("voice_query_too_short","Voice query too short.");let f=new URLSearchParams({text:d});e.currentCoords&&(f.set("lat",String(e.currentCoords.lat)),f.set("lon",String(e.currentCoords.lon)));let E=Array.isArray(navigator.languages)&&navigator.languages[0]||navigator.language||"";E&&f.set("lang",String(E));let L;try{L=await Q(`/api/v1/geocode?${f.toString()}`)}catch{throw p("voice_geocode_failed","Location lookup failed.")}if(!(L.headers.get("content-type")||"").includes("application/json"))throw p("voice_geocode_failed","Unexpected location lookup response.");let o=await L.json();if(!L.ok)throw p("voice_geocode_failed",String(o?.error||"Location lookup failed.").trim());let c=x(o?.choices);if(o?.ambiguous&&c.length>1){let F=await U(d,c);return{lat:F.lat,lon:F.lon,label:F.label,query:d}}let h=Number(o?.location?.lat),I=Number(o?.location?.lon);if(!Number.isFinite(h)||!Number.isFinite(I))throw p("voice_location_not_found","No matching location found.");return{lat:h,lon:I,label:String(o?.location?.label||"").trim(),query:d}}function g(l){return l==="voice_unsupported"||l==="voice_no_speech"||l==="voice_recognition_timeout"||l==="voice_recognition_network"||l==="voice_not_understood"}function tt(l){if(!g(l)||typeof window.prompt!="function")return null;let d=l==="voice_unsupported"?"Voice input is limited in this browser. Type your location instead:":"Could not capture your voice on this device. Type your location:",f=window.prompt(`${d}
Example: Kamppi Helsinki`,"");return String(f||"").trim()||null}async function j(l){let d=String(l||"").trim();B(),r.setStatus(`Looking up "${r.safeString(d,80)}"...`);let f=await lt(d);return r.setResolvedLocationHint({query:d,label:f.label,lat:f.lat,lon:f.lon}),e.currentCoords={lat:f.lat,lon:f.lon},r.setPermissionRequired(!1),await W(f.lat,f.lon),!0}async function at(){if(e.isLoading||e.isVoiceListening)return!1;B(),r.setVoiceListening(!0),r.setStatus("Listening... speak now, then pause.");try{if(!R()){let d=p("voice_unsupported","Voice recognition not supported."),f=tt(k(d));return f?j(f):(r.setStatus(r.getVoiceLocationErrorStatus(d)),!1)}let l=await ot();return j(l)}catch(l){let d=k(l),f=tt(d);if(f)try{return await j(f)}catch(E){return console.error("voice fallback location error:",E),r.reportClientError("voice-location-fallback",E,{mode:e.mode,sourceCode:d||"unknown"}),r.setStatus(r.getVoiceLocationErrorStatus(E)),!1}return(!d||d==="unknown")&&console.error("voice location error:",l),r.reportClientError("voice-location",l,{mode:e.mode,code:d||"unknown"}),r.setStatus(r.getVoiceLocationErrorStatus(l)),!1}finally{r.setVoiceListening(!1)}}async function W(l,d){let f=++e.latestLoadToken,E=e.mode,L=e.busStopId,y=G(E)&&!e.hasCompletedInitialStopModeLoad;r.setLoading(!0),r.setStatus("Loading departures...");try{let o=new URLSearchParams({lat:String(l),lon:String(d),mode:E.toUpperCase(),results:String(r.getActiveResultsLimit(E))}),c=G(E)&&(e.deferInitialStopContext||!e.hasCompletedInitialStopModeLoad);G(E)&&L&&!c&&o.set("stopId",L);let h=await Q(`/api/v1/departures?${o.toString()}`);if(!(h.headers.get("content-type")||"").includes("application/json"))throw h.ok?new Error("Unexpected server response."):new Error("Request failed");let F=await h.json();if(!h.ok)throw new Error(F.error||"Request failed");if(f!==e.latestLoadToken)return;G(E)&&(m(F),r.persistUiState(),y&&r.trackInitialNearestStopResolved(F,E)),e.latestResponse=F,r.render(F),r.setPermissionRequired(!1),r.setLastUpdated(new Date),r.setStatus(""),r.trackFirstSuccessfulRender(F,E)}catch(o){if(f!==e.latestLoadToken)return;e.latestResponse=null,console.error("load departures error:",o),r.reportClientError("load",o,{mode:E}),r.setStatus(r.getLoadErrorStatus(o)),n.resultEl.classList.add("hidden"),r.updateNextSummary(null)}finally{f===e.latestLoadToken&&r.setLoading(!1)}}function H(){if(B(),r.setResolvedLocationHint(null),!navigator.geolocation)return r.setStatus("Geolocation not supported in this browser."),r.setPermissionRequired(!0),!1;if(e.isLoading||e.isVoiceListening)return!1;r.setStatus("Getting your location..."),r.setLoading(!0);let l=y=>({enableHighAccuracy:y,timeout:y?15e3:1e4,maximumAge:0}),d=(y,o)=>o?!1:y?.code===2||y?.code===3,f=y=>{e.currentCoords={lat:y.coords.latitude,lon:y.coords.longitude},e.locationGranted=!0,r.setStorageItem("location:granted","1"),r.setPermissionRequired(!1),r.setLoading(!1),W(e.currentCoords.lat,e.currentCoords.lon)},E=y=>{y.code===1?r.setPermissionRequired(!0):r.setPermissionRequired(!1),r.setStatus(r.getGeolocationErrorStatus(y)),e.latestResponse=null,n.resultEl.classList.add("hidden"),r.updateNextSummary(null),r.setLoading(!1)},L=y=>{navigator.geolocation.getCurrentPosition(f,o=>{if(d(o,y)){L(!0);return}E(o)},l(y))};return L(!1),!0}function P(){if(!e.isVoiceListening){if(e.currentCoords){W(e.currentCoords.lat,e.currentCoords.lon);return}H()}}function v(l={}){let d=!!l.modeOnly;r.updateModeButtons(),r.updateModeLabels(),!d&&(r.renderResultsLimitControl(),r.renderStopControls(),r.updateDataScope(e.latestResponse))}Object.assign(r,{delay:ut,fetchWithTimeout:st,fetchWithRetryOnce:Q,updateStopModeStateFromResponse:m,buildFilterOptionsFromDepartures:J,load:W,requestLocationAndLoad:H,requestVoiceLocationAndLoad:at,supportsVoiceLocation:R,captureVoiceQuery:T,captureVoiceQueryWithRetry:ot,getVoiceRecognitionLanguages:_,shouldRetryVoiceRecognition:K,resolveVoiceLocationQuery:lt,refreshDeparturesOnly:P,applyModeUiState:v})})();(()=>{let D=window.HMApp,{api:r,dom:n,state:e,constants:N}=D,{MODE_RAIL:$,MODE_TRAM:C,MODE_METRO:u,MODE_BUS:M}=N,G=window.location.search;function ut(){if(e.currentCoords){r.load(e.currentCoords.lat,e.currentCoords.lon);return}r.requestLocationAndLoad()}function st(m){if(typeof window.requestAnimationFrame=="function"){window.requestAnimationFrame(m);return}setTimeout(m,0)}function Q(m){e.mode!==m&&(r.trackFirstManualInteraction("mode_change",{toMode:m}),e.mode=m,r.applyModeUiState({modeOnly:!0}),st(()=>{r.applyModeUiState(),r.persistUiState(),ut()}))}n.locateBtn?.addEventListener("click",()=>{r.trackFirstManualInteraction("refresh_location_click"),r.requestLocationAndLoad()}),n.voiceLocateBtn?.addEventListener("click",()=>{r.trackFirstManualInteraction("voice_location_click"),r.requestVoiceLocationAndLoad()}),n.modeRailBtn?.addEventListener("click",()=>{Q($)}),n.modeTramBtn?.addEventListener("click",()=>{Q(C)}),n.modeMetroBtn?.addEventListener("click",()=>{Q(u)}),n.modeBusBtn?.addEventListener("click",()=>{Q(M)}),n.resultsLimitSelectEl?.addEventListener("click",m=>{m.stopPropagation(),r.toggleResultsLimitDropdown()}),document.addEventListener("click",m=>{n.resultsLimitSelectWrapEl&&(n.resultsLimitSelectWrapEl.contains(m.target)||r.toggleResultsLimitDropdown(!1))}),n.resultsLimitSelectEl?.addEventListener("keydown",m=>{let p=n.resultsLimitSelectListEl;if(!p)return;let k=n.resultsLimitSelectEl.getAttribute("aria-expanded")==="true";if(m.key==="Escape"){r.toggleResultsLimitDropdown(!1),n.resultsLimitSelectEl.focus(),m.preventDefault();return}if(m.key==="Enter"||m.key===" "){if(!k){r.toggleResultsLimitDropdown(!0),m.preventDefault();return}let _=p.querySelector(".is-focused");_?.dataset?.value&&r.selectResultsLimit(_.dataset.value),m.preventDefault();return}if(m.key==="ArrowDown"||m.key==="ArrowUp"){if(m.preventDefault(),!k){r.toggleResultsLimitDropdown(!0);return}let _=[...p.querySelectorAll("li[role='option']")];if(_.length===0)return;let A=_.findIndex(w=>w.classList.contains("is-focused")),R;m.key==="ArrowDown"?R=A<_.length-1?A+1:0:R=A>0?A-1:_.length-1;for(let w of _)w.classList.remove("is-focused");_[R].classList.add("is-focused"),_[R].scrollIntoView({block:"nearest"})}}),n.busStopSelectEl?.addEventListener("click",m=>{m.stopPropagation(),r.toggleStopDropdown()}),document.addEventListener("click",m=>{n.busStopSelectWrapEl&&(n.busStopSelectWrapEl.contains(m.target)||r.toggleStopDropdown(!1))}),n.busStopSelectEl?.addEventListener("keydown",m=>{let p=n.busStopSelectListEl;if(!p)return;let k=n.busStopSelectEl.getAttribute("aria-expanded")==="true";if(m.key==="Escape"){r.toggleStopDropdown(!1),n.busStopSelectEl.focus(),m.preventDefault();return}if(m.key==="Enter"||m.key===" "){if(!k){r.toggleStopDropdown(!0),m.preventDefault();return}let _=p.querySelector(".is-focused");_?.dataset?.value&&r.selectStop(_.dataset.value),m.preventDefault();return}if(m.key==="ArrowDown"||m.key==="ArrowUp"){if(m.preventDefault(),!k){r.toggleStopDropdown(!0);return}let _=[...p.querySelectorAll("li[role='option']")];if(_.length===0)return;let A=_.findIndex(w=>w.classList.contains("is-focused")),R;m.key==="ArrowDown"?R=A<_.length-1?A+1:0:R=A>0?A-1:_.length-1;for(let w of _)w.classList.remove("is-focused");_[R].classList.add("is-focused"),_[R].scrollIntoView({block:"nearest"})}}),n.stopFiltersToggleBtnEl?.addEventListener("click",()=>{r.trackFirstManualInteraction("stop_filters_panel_toggle",{currentMode:e.mode}),r.toggleStopFiltersPanel()}),n.locationPromptAllowEl?.addEventListener("click",()=>{r.hideLocationPrompt(),r.requestLocationAndLoad()}),n.permissionRetryBtnEl?.addEventListener("click",()=>{r.trackFirstManualInteraction("permission_retry_click"),r.requestLocationAndLoad()}),r.hydrateInitialState(),r.applyModeUiState(),r.updateClock(),setInterval(r.updateClock,1e3),r.getStorageItem("location:granted")==="1"?r.requestLocationAndLoad():(r.showLocationPrompt(),r.setStatus("Tap Allow Location to get started.")),setInterval(r.refreshDeparturesOnly,3e4),window.addEventListener("error",m=>{r.reportClientError("error",m.error||m.message||"Unknown error",{source:m.filename||"",line:m.lineno||null,column:m.colno||null})}),window.addEventListener("unhandledrejection",m=>{r.reportClientError("unhandledrejection",m.reason||"Unhandled promise rejection")}),(()=>{let m=document.getElementById("themeToggle");if(!m)return;let p=document.documentElement,k=window.matchMedia("(prefers-color-scheme: dark)"),_=()=>{let T=r.getStorageItem("theme");return T==="dark"||T==="light"?T:null},A=T=>{p.setAttribute("data-theme",T==="light"?"light":"dark")},R=()=>{let T=_();if(T){A(T);return}A(k.matches?"dark":"light")},w=T=>{_()||A(T.matches?"dark":"light")};R(),typeof k.addEventListener=="function"?k.addEventListener("change",w):typeof k.addListener=="function"&&k.addListener(w),m.addEventListener("click",()=>{let T=p.getAttribute("data-theme")==="dark"?"light":"dark";A(T),r.setStorageItem("theme",T)})})(),(()=>{let m=document.getElementById("mockOverlayLayer"),p=document.getElementById("mockOverlayImage"),k=document.getElementById("mockOverlayControls"),_=document.getElementById("mockOverlayUrlInput"),A=document.getElementById("mockOverlayOpacityInput"),R=document.getElementById("mockOverlayOffsetXInput"),w=document.getElementById("mockOverlayOffsetYInput"),T=document.getElementById("mockOverlayScaleInput"),K=document.getElementById("mockOverlayToggleBtn"),ot=document.getElementById("mockOverlayResetBtn");if(!m||!p||!k||!_||!A||!R||!w||!T||!K||!ot)return;let x={url:"dev:overlay:url",opacity:"dev:overlay:opacity",offsetX:"dev:overlay:offsetX",offsetY:"dev:overlay:offsetY",scale:"dev:overlay:scale",visible:"dev:overlay:visible",panelVisible:"dev:overlay:panelVisible"},B=new URLSearchParams(G),Z=B.get("overlay")==="1",U=(v,{min:l,max:d,fallback:f})=>{let E=Number(v);return Number.isFinite(E)?Math.min(d,Math.max(l,E)):f},lt=(v,l=!1)=>v==="1"||v==="true"?!0:v==="0"||v==="false"?!1:l,g={url:"",opacity:45,offsetX:0,offsetY:0,scale:100,visible:!1,panelVisible:!1},tt=()=>{_.value=g.url,A.value=String(g.opacity),R.value=String(g.offsetX),w.value=String(g.offsetY),T.value=String(g.scale)},j=()=>{r.setStorageItem(x.url,g.url),r.setStorageItem(x.opacity,String(g.opacity)),r.setStorageItem(x.offsetX,String(g.offsetX)),r.setStorageItem(x.offsetY,String(g.offsetY)),r.setStorageItem(x.scale,String(g.scale)),r.setStorageItem(x.visible,g.visible?"1":"0"),r.setStorageItem(x.panelVisible,g.panelVisible?"1":"0")},at=()=>{let v=g.url.length>0,l=v&&g.visible;k.classList.toggle("hidden",!g.panelVisible),m.classList.toggle("hidden",!l),m.setAttribute("aria-hidden",String(!l)),K.textContent=l?"Overlay: On":"Overlay: Off",K.setAttribute("aria-pressed",String(l)),v?p.getAttribute("src")!==g.url&&p.setAttribute("src",g.url):p.removeAttribute("src"),p.style.opacity=String(g.opacity/100),p.style.transform=`translate(${g.offsetX}px, ${g.offsetY}px) scale(${g.scale/100})`,tt()},W=v=>{let l=v instanceof Element?v:null;return l?l.tagName==="INPUT"||l.tagName==="TEXTAREA"||l.tagName==="SELECT"?!0:!!l.closest("[contenteditable='true']"):!1},H=()=>{g.url=String(r.getStorageItem(x.url)||"").trim(),g.opacity=U(r.getStorageItem(x.opacity),{min:0,max:100,fallback:45}),g.offsetX=U(r.getStorageItem(x.offsetX),{min:-2e3,max:2e3,fallback:0}),g.offsetY=U(r.getStorageItem(x.offsetY),{min:-2e3,max:2e3,fallback:0}),g.scale=U(r.getStorageItem(x.scale),{min:50,max:200,fallback:100}),g.visible=lt(r.getStorageItem(x.visible),!1),g.panelVisible=lt(r.getStorageItem(x.panelVisible),!1);let v=String(B.get("overlayUrl")||"").trim();v&&(g.url=v),B.has("overlayOpacity")&&(g.opacity=U(B.get("overlayOpacity"),{min:0,max:100,fallback:g.opacity})),B.has("overlayOffsetX")&&(g.offsetX=U(B.get("overlayOffsetX"),{min:-2e3,max:2e3,fallback:g.offsetX})),B.has("overlayOffsetY")&&(g.offsetY=U(B.get("overlayOffsetY"),{min:-2e3,max:2e3,fallback:g.offsetY})),B.has("overlayScale")&&(g.scale=U(B.get("overlayScale"),{min:50,max:200,fallback:g.scale})),B.has("overlayVisible")&&(g.visible=lt(B.get("overlayVisible"),g.visible)),Z&&(g.panelVisible=!0,B.has("overlayVisible")||(g.visible=!0))},P=v=>{Object.assign(g,v),j(),at()};H(),at(),_.addEventListener("input",()=>{let v=String(_.value||"").trim();P({url:v,visible:v.length>0?!0:g.visible})}),A.addEventListener("input",()=>{P({opacity:U(A.value,{min:0,max:100,fallback:g.opacity})})}),R.addEventListener("input",()=>{P({offsetX:U(R.value,{min:-2e3,max:2e3,fallback:g.offsetX})})}),w.addEventListener("input",()=>{P({offsetY:U(w.value,{min:-2e3,max:2e3,fallback:g.offsetY})})}),T.addEventListener("input",()=>{P({scale:U(T.value,{min:50,max:200,fallback:g.scale})})}),K.addEventListener("click",()=>{P({visible:!g.visible})}),ot.addEventListener("click",()=>{P({opacity:45,offsetX:0,offsetY:0,scale:100})}),document.addEventListener("keydown",v=>{if(!W(v.target)&&v.key.toLowerCase()==="o"&&!(v.metaKey||v.ctrlKey||v.altKey)){if(v.preventDefault(),v.shiftKey){P({panelVisible:!g.panelVisible});return}P({visible:!g.visible})}})})()})();})();
