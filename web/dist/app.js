(()=>{(()=>{let R=window.HMApp||(window.HMApp={}),i=R.api||={};R.dom={locateBtn:document.getElementById("locateBtn"),modeRailBtn:document.getElementById("modeRailBtn"),modeBusBtn:document.getElementById("modeBusBtn"),helsinkiOnlyBtn:document.getElementById("helsinkiOnlyBtn"),busControlsEl:document.getElementById("busControls"),busStopSelectEl:document.getElementById("busStopSelect"),busLineFiltersEl:document.getElementById("busLineFilters"),busDestinationFiltersEl:document.getElementById("busDestinationFilters"),resultsLimitSelectEl:document.getElementById("resultsLimitSelect"),modeEyebrowEl:document.getElementById("modeEyebrow"),statusEl:document.getElementById("status"),dataScopeEl:document.getElementById("dataScope"),resultEl:document.getElementById("result"),permissionCardEl:document.getElementById("permissionCard"),stationTitleEl:document.getElementById("stationTitle"),stationMetaEl:document.getElementById("stationMeta"),departuresEl:document.getElementById("departures"),nextSummaryEl:document.getElementById("nextSummary"),nextLabelEl:document.getElementById("nextLabel"),nextMinsEl:document.getElementById("nextMins"),nextLineEl:document.getElementById("nextLine"),nextTrackEl:document.getElementById("nextTrack"),nextDestinationEl:document.getElementById("nextDestination"),nowClockEl:document.getElementById("nowClock"),lastUpdatedEl:document.getElementById("lastUpdated")},R.constants={MODE_RAIL:"rail",MODE_BUS:"bus",STORAGE_MODE_KEY:"prefs:mode",STORAGE_HELSINKI_ONLY_KEY:"prefs:helsinkiOnly",STORAGE_BUS_STOP_KEY:"prefs:busStopId",STORAGE_BUS_LINES_KEY:"prefs:busLines",STORAGE_BUS_DESTINATIONS_KEY:"prefs:busDestinations",STORAGE_RESULTS_LIMIT_RAIL_KEY:"prefs:resultsLimitRail",STORAGE_RESULTS_LIMIT_BUS_KEY:"prefs:resultsLimitBus",DEFAULT_RESULTS_LIMIT_RAIL:8,DEFAULT_RESULTS_LIMIT_BUS:24,RESULT_LIMIT_OPTIONS:[8,12,16,20,24,30],FETCH_TIMEOUT_MS:8e3,ERROR_REPORT_LIMIT:5};let{MODE_RAIL:n,MODE_BUS:t}=R.constants;R.state={isLoading:!1,currentCoords:null,latestResponse:null,mode:n,helsinkiOnly:!1,busStopId:null,busLineFilters:[],busDestinationFilters:[],resultsLimitByMode:{[n]:R.constants.DEFAULT_RESULTS_LIMIT_RAIL,[t]:R.constants.DEFAULT_RESULTS_LIMIT_BUS},busStops:[],busFilterOptions:{lines:[],destinations:[]},suppressBusStopChange:!1,errorReportCount:0,latestLoadToken:0};let{dom:I,state:l,constants:a}=R;function C(s){l.isLoading=s,I.locateBtn&&(I.locateBtn.disabled=s)}function S(s){I.statusEl&&(I.statusEl.textContent=s)}function U(s){I.permissionCardEl&&I.permissionCardEl.classList.toggle("hidden",!s)}function _(s){!I.lastUpdatedEl||!(s instanceof Date)||(I.lastUpdatedEl.textContent=`Last updated: ${s.toLocaleTimeString([],{hour:"2-digit",minute:"2-digit",second:"2-digit",hour12:!1})}`)}function B(s){try{return window.localStorage.getItem(s)}catch{return null}}function L(s,c){try{window.localStorage.setItem(s,c)}catch{}}function A(s,c){let O=String(s||"");return O.length<=c?O:O.slice(0,c)}function m(s){if(s instanceof Error)return s;try{let c=typeof s=="string"?s:JSON.stringify(s);return new Error(c||"Unknown error")}catch{return new Error(String(s||"Unknown error"))}}function p(s,c,O=null){if(l.errorReportCount>=a.ERROR_REPORT_LIMIT)return;l.errorReportCount+=1;let e=m(c),o={type:A(s,40),message:A(e.message,400),stack:A(e.stack||"",1200),url:A(window.location.href,500),userAgent:A(navigator.userAgent||"",300),timestamp:new Date().toISOString(),context:O&&typeof O=="object"?O:null},r=JSON.stringify(o);if(navigator.sendBeacon){let f=new Blob([r],{type:"application/json"});navigator.sendBeacon("/api/v1/client-error",f);return}fetch("/api/v1/client-error",{method:"POST",headers:{"content-type":"application/json"},body:r,keepalive:!0}).catch(()=>{})}function y(s){if(!s)return null;let c=String(s).trim().toLowerCase();return c===n||c===t?c:null}function h(s){if(s==null)return null;let c=String(s).trim().toLowerCase();return["1","true","yes","on"].includes(c)?!0:["0","false","no","off"].includes(c)?!1:null}function T(s){return Array.isArray(s)?[...new Set(s.map(c=>String(c||"").trim()).filter(Boolean))]:[]}function w(s){if(s==null||s==="")return null;let c=Number(s);return!Number.isInteger(c)||!a.RESULT_LIMIT_OPTIONS.includes(c)?null:c}function d(s=l.mode){return s===t?a.DEFAULT_RESULTS_LIMIT_BUS:a.DEFAULT_RESULTS_LIMIT_RAIL}function b(s=l.mode){let c=w(l.resultsLimitByMode?.[s]);return c??d(s)}function k(s){let c=B(s);if(!c)return[];try{let O=JSON.parse(c);return T(O)}catch{return[]}}function N(){let s=new URLSearchParams(window.location.search);return{mode:y(s.get("mode")),helsinkiOnly:h(s.get("helsinkiOnly")),stopProvided:s.has("stop"),busStopId:s.get("stop")?s.get("stop").trim():null,linesProvided:s.has("line"),busLines:T(s.getAll("line")),destinationsProvided:s.has("dest"),busDestinations:T(s.getAll("dest")),resultsProvided:s.has("results"),resultsLimit:w(s.get("results"))}}function M(){let s=N(),c=y(B(a.STORAGE_MODE_KEY)),O=h(B(a.STORAGE_HELSINKI_ONLY_KEY));l.mode=s.mode||c||n,l.helsinkiOnly=s.helsinkiOnly??O??!1,l.mode!==n&&(l.helsinkiOnly=!1);let e=String(B(a.STORAGE_BUS_STOP_KEY)||"").trim()||null;l.busStopId=s.stopProvided?s.busStopId:e;let o=k(a.STORAGE_BUS_LINES_KEY),r=k(a.STORAGE_BUS_DESTINATIONS_KEY);l.busLineFilters=s.linesProvided?s.busLines:o,l.busDestinationFilters=s.destinationsProvided?s.busDestinations:r;let f=w(B(a.STORAGE_RESULTS_LIMIT_RAIL_KEY)),E=w(B(a.STORAGE_RESULTS_LIMIT_BUS_KEY));l.resultsLimitByMode[n]=f??a.DEFAULT_RESULTS_LIMIT_RAIL,l.resultsLimitByMode[t]=E??a.DEFAULT_RESULTS_LIMIT_BUS,s.resultsProvided&&s.resultsLimit!=null&&(l.resultsLimitByMode[l.mode]=s.resultsLimit)}function x(){L(a.STORAGE_MODE_KEY,l.mode),L(a.STORAGE_HELSINKI_ONLY_KEY,l.helsinkiOnly?"1":"0"),L(a.STORAGE_BUS_STOP_KEY,l.busStopId||""),L(a.STORAGE_BUS_LINES_KEY,JSON.stringify(l.busLineFilters)),L(a.STORAGE_BUS_DESTINATIONS_KEY,JSON.stringify(l.busDestinationFilters)),L(a.STORAGE_RESULTS_LIMIT_RAIL_KEY,String(b(n))),L(a.STORAGE_RESULTS_LIMIT_BUS_KEY,String(b(t)))}function $(){let s=new URLSearchParams(window.location.search);l.mode===n?s.delete("mode"):s.set("mode",l.mode),l.mode===n&&l.helsinkiOnly?s.set("helsinkiOnly","1"):s.delete("helsinkiOnly");let c=b(),O=d();if(c===O?s.delete("results"):s.set("results",String(c)),s.delete("stop"),s.delete("line"),s.delete("dest"),l.mode===t){l.busStopId&&s.set("stop",l.busStopId);for(let r of l.busLineFilters)s.append("line",r);for(let r of l.busDestinationFilters)s.append("dest",r)}let e=s.toString(),o=`${window.location.pathname}${e?`?${e}`:""}${window.location.hash}`;window.history.replaceState(null,"",o)}function G(){x(),$()}Object.assign(i,{setLoading:C,setStatus:S,setPermissionRequired:U,setLastUpdated:_,getStorageItem:B,setStorageItem:L,safeString:A,toError:m,reportClientError:p,normalizeMode:y,parseBoolean:h,uniqueNonEmptyStrings:T,parseResultLimit:w,getDefaultResultsLimit:d,getActiveResultsLimit:b,parseStoredArray:k,readStateFromUrl:N,hydrateInitialState:M,syncStateToStorage:x,syncStateToUrl:$,persistUiState:G})})();(()=>{let R=window.HMApp,{api:i,dom:n,state:t,constants:I}=R,{MODE_RAIL:l,MODE_BUS:a}=I;function C(e){let o=S(e);return o<=0?"Now":`${o}m`}function S(e){let o=new Date(e);return Math.floor((o.getTime()-Date.now())/6e4)}function U(e){let o=S(e);return o<=0||o<5?"departure-now":o<=15?"departure-soon":"departure-later"}function _(e){let o=e?.destination||"";return/\bhelsinki\b/i.test(o)}function B(){let e=new Set((t.busFilterOptions.lines||[]).map(r=>r.value)),o=new Set((t.busFilterOptions.destinations||[]).map(r=>r.value));t.busLineFilters=t.busLineFilters.filter(r=>e.has(r)),t.busDestinationFilters=t.busDestinationFilters.filter(r=>o.has(r))}function L(e){return Array.isArray(e)?t.mode===l&&t.helsinkiOnly?e.filter(_):e:[]}function A(){if(n.modeRailBtn){let e=t.mode===l;n.modeRailBtn.setAttribute("aria-pressed",String(e)),n.modeRailBtn.classList.toggle("is-active",e)}if(n.modeBusBtn){let e=t.mode===a;n.modeBusBtn.setAttribute("aria-pressed",String(e)),n.modeBusBtn.classList.toggle("is-active",e)}}function m(){n.modeEyebrowEl&&(n.modeEyebrowEl.textContent=t.mode===a?"Helsinki Moves \u2022 Bus":"Helsinki Moves \u2022 Rail"),n.nextLabelEl&&(n.nextLabelEl.textContent=t.mode===a?"Next Bus":"Next Train")}function p(){if(!n.resultsLimitSelectEl)return;let e=Array.isArray(I.RESULT_LIMIT_OPTIONS)?I.RESULT_LIMIT_OPTIONS:[],o=i.getActiveResultsLimit();n.resultsLimitSelectEl.innerHTML="";for(let r of e){let f=document.createElement("option");f.value=String(r),f.textContent=`${r}`,n.resultsLimitSelectEl.appendChild(f)}n.resultsLimitSelectEl.value=String(o)}function y(){if(n.helsinkiOnlyBtn){if(t.mode!==l){n.helsinkiOnlyBtn.setAttribute("aria-pressed","false"),n.helsinkiOnlyBtn.classList.remove("is-active"),n.helsinkiOnlyBtn.disabled=!0,n.helsinkiOnlyBtn.textContent="Helsinki Only (Rail)";return}n.helsinkiOnlyBtn.disabled=!1,n.helsinkiOnlyBtn.setAttribute("aria-pressed",String(t.helsinkiOnly)),n.helsinkiOnlyBtn.classList.toggle("is-active",t.helsinkiOnly),n.helsinkiOnlyBtn.textContent=t.helsinkiOnly?"Helsinki Only: On":"Helsinki Only: Off"}}function h(e){n.busControlsEl&&n.busControlsEl.classList.toggle("hidden",!e)}function T(e){return t.busStops.find(o=>o.id===e)||null}function w(e){let o=i.uniqueNonEmptyStrings([...Array.isArray(e?.stopCodes)?e.stopCodes:[],e?.code]);return o.length===0&&e?.id&&o.push(String(e.id)),o}function d(e,o=null){let r=T(t.busStopId),f=String(o?.stopName||e?.stopName||r?.name||"").trim(),u=i.uniqueNonEmptyStrings([o?.stopCode,...Array.isArray(e?.stopCodes)?e.stopCodes:[],e?.stopCode,...w(r)])[0]||"";return f&&u?`${f} ${u}`:f||u||"\u2014"}function b(e){if(!n.dataScopeEl)return;if(t.mode!==a){n.dataScopeEl.classList.add("hidden"),n.dataScopeEl.textContent="";return}let o=String(e?.station?.stopName||T(t.busStopId)?.name||"").trim(),f=i.uniqueNonEmptyStrings([...Array.isArray(e?.station?.stopCodes)?e.station.stopCodes:[],e?.station?.stopCode,...w(T(t.busStopId))]).join(", "),E=t.busLineFilters.length===0?"all lines":`${t.busLineFilters.length} line${t.busLineFilters.length===1?"":"s"} selected`,u=t.busDestinationFilters.length===0?"all destinations":`${t.busDestinationFilters.length} destination${t.busDestinationFilters.length===1?"":"s"} selected`,g=`${i.getActiveResultsLimit()} results`;o?n.dataScopeEl.textContent=`Selected stop ${o} (${f||"\u2014"}) - ${E}, ${u}, ${g}`:n.dataScopeEl.textContent=`Selecting stop... (${E}, ${u}, ${g})`,n.dataScopeEl.classList.remove("hidden")}function k(e,o,r,f){if(!e)return;if(e.innerHTML="",!Array.isArray(o)||o.length===0){let u=document.createElement("span");u.className="chip-empty",u.textContent="No options",e.appendChild(u);return}let E=new Set(r);for(let u of o){let g=document.createElement("button");g.type="button",g.className="chip-toggle",E.has(u.value)?(g.classList.add("is-active"),g.setAttribute("aria-pressed","true")):g.setAttribute("aria-pressed","false"),g.textContent=`${u.value} (${u.count})`,g.addEventListener("click",()=>f(u.value)),e.appendChild(g)}}function N(){let e=t.mode===a;if(h(e),!!e){if(n.busStopSelectEl){if(t.suppressBusStopChange=!0,n.busStopSelectEl.innerHTML="",t.busStops.length===0){let o=document.createElement("option");o.value="",o.textContent="No nearby bus stops",n.busStopSelectEl.appendChild(o),n.busStopSelectEl.disabled=!0}else{n.busStopSelectEl.disabled=!1;for(let o of t.busStops){let r=document.createElement("option");r.value=o.id,r.textContent=`${o.name} (${o.distanceMeters}m)`,n.busStopSelectEl.appendChild(r)}t.busStopId&&t.busStops.some(o=>o.id===t.busStopId)?n.busStopSelectEl.value=t.busStopId:n.busStopSelectEl.value=t.busStops[0].id}t.suppressBusStopChange=!1}k(n.busLineFiltersEl,t.busFilterOptions.lines,t.busLineFilters,o=>{t.busLineFilters.includes(o)?t.busLineFilters=t.busLineFilters.filter(r=>r!==o):t.busLineFilters=[...t.busLineFilters,o],i.persistUiState(),i.refreshDeparturesOnly?.()}),k(n.busDestinationFiltersEl,t.busFilterOptions.destinations,t.busDestinationFilters,o=>{t.busDestinationFilters.includes(o)?t.busDestinationFilters=t.busDestinationFilters.filter(r=>r!==o):t.busDestinationFilters=[...t.busDestinationFilters,o],i.persistUiState(),i.refreshDeparturesOnly?.()})}}function M(e,o=null){if(!n.nextSummaryEl||!n.nextMinsEl||!n.nextLineEl||!n.nextTrackEl||!n.nextDestinationEl)return;if(!e){n.nextSummaryEl.classList.add("hidden"),n.nextSummaryEl.classList.remove("next-summary-now","next-summary-soon","next-summary-later");return}let r=S(e.departureIso);n.nextMinsEl.textContent=C(e.departureIso),n.nextLineEl.textContent=e.line||"\u2014",n.nextLineEl.classList.toggle("next-letter-now",r<5),n.nextTrackEl.textContent=t.mode===a?`Stop ${d(o,e)}`:e.track?`Track ${e.track}`:"Track \u2014",n.nextDestinationEl.textContent=e.destination||"\u2014",n.nextSummaryEl.classList.remove("next-summary-now","next-summary-soon","next-summary-later"),r<5?n.nextSummaryEl.classList.add("next-summary-now"):r<=15?n.nextSummaryEl.classList.add("next-summary-soon"):n.nextSummaryEl.classList.add("next-summary-later"),n.nextSummaryEl.classList.remove("hidden")}function x(e){if(!e||!e.station)return t.mode===a?e?.message||"No nearby bus stops found.":e?.message||"No nearby train stations found.";let r=L(e.station.departures)[0];if(!r)return t.mode===a?t.busLineFilters.length>0||t.busDestinationFilters.length>0?"No upcoming buses match selected filters.":"No upcoming buses right now.":t.helsinkiOnly?"No Helsinki-bound trains in upcoming departures.":"No upcoming commuter trains right now.";let f=r.destination?` \u2022 ${r.destination}`:"",E=t.mode===l?r.track?` \u2022 Track ${r.track}`:"":e.station.stopName||e.station.stopCode?` \u2022 ${d(e.station)}`:"",u=t.mode===a?"bus":"train";return`Next ${r.line||u} in ${C(r.departureIso)}${f}${E}`}function $(e){if(!(e instanceof Error))return"Could not refresh departures. Please try again.";if(e.name==="AbortError")return"Request timed out. Please try again.";let o=(e.message||"").trim();return o==="Temporary server error. Please try again."?o:o==="Invalid lat/lon"?"Location coordinates were invalid. Please refresh your location.":o==="Invalid mode"?"Unsupported transport mode.":"Could not refresh departures. Please try again."}function G(e){return e?.code===1?"Location permission denied.":e?.code===2?"Location unavailable. Please try again.":e?.code===3?"Location request timed out. Please try again.":"Unable to get your location."}function s(){let e=[...document.querySelectorAll(".departure-row .train-top")];if(e.length===0)return;let o=e.map(u=>u.querySelector(".destination")).filter(Boolean);for(let u of o)u.style.width="auto";let r=0;for(let u of o)r=Math.max(r,Math.ceil(u.scrollWidth));let f=Number.POSITIVE_INFINITY;for(let u of e){let g=u.querySelector(".time");if(!g)continue;let F=getComputedStyle(u),D=parseFloat(F.columnGap||F.gap||"0")||0,v=u.clientWidth-g.offsetWidth-D;v>0&&(f=Math.min(f,v))}let E=Math.max(0,Math.min(r,f));for(let u of o)u.style.width=`${E}px`}function c(e){if(N(),b(e),!e||!e.station){n.resultEl.classList.add("hidden"),M(null);return}let o=e.station;n.resultEl.classList.remove("hidden"),n.stationTitleEl.textContent=o.stopName,n.stationMetaEl.textContent=`${o.distanceMeters}m away`,n.departuresEl.innerHTML="";let r=L(o.departures);if(r.length===0){M(null);let E=document.createElement("li");E.className="empty-row",t.mode===a?E.textContent=t.busLineFilters.length>0||t.busDestinationFilters.length>0?"No upcoming buses match selected filters.":"No upcoming buses right now.":E.textContent=t.helsinkiOnly?"No Helsinki-bound trains in upcoming departures.":"No upcoming commuter trains right now.",n.departuresEl.appendChild(E);return}M(r[0],o);let f=r.slice(1);if(f.length===0){let E=document.createElement("li");E.className="empty-row",E.textContent=t.mode===a?"No additional upcoming buses right now.":"No additional upcoming commuter trains right now.",n.departuresEl.appendChild(E);return}for(let E=0;E<f.length;E++){let u=f[E],g=document.createElement("li");g.className=`departure-row ${U(u.departureIso)}`,g.style.setProperty("--i",E);let F=document.createElement("div");F.className="letter-badge",F.textContent=u.line||"?";let D=document.createElement("div");D.className="train";let v=document.createElement("div");v.className="train-top";let H=document.createElement("div");H.className="destination",H.textContent=u.destination||"\u2014",v.appendChild(H);let P=document.createElement("div");P.className="time";let Y=document.createElement("span");Y.className="remaining",Y.textContent=C(u.departureIso);let K=document.createElement("span");K.className="clock-time",K.textContent=new Date(u.departureIso).toLocaleTimeString([],{hour:"2-digit",minute:"2-digit",hour12:!1}),P.appendChild(Y),P.appendChild(K),v.appendChild(P),D.appendChild(v);let q=document.createElement("span");q.className="track",t.mode===a?q.textContent=`Stop ${d(o,u)}`:q.textContent=u.track?`Track ${u.track}`:"Track \u2014",D.appendChild(q),g.appendChild(F),g.appendChild(D),n.departuresEl.appendChild(g)}requestAnimationFrame(s)}function O(){n.nowClockEl&&(n.nowClockEl.textContent=new Date().toLocaleTimeString([],{hour:"2-digit",minute:"2-digit",second:"2-digit",hour12:!1}))}Object.assign(i,{formatMinutes:C,minutesUntil:S,departureRowClass:U,isHelsinkiBound:_,sanitizeBusSelections:B,getVisibleDepartures:L,updateModeButtons:A,updateModeLabels:m,renderResultsLimitControl:p,updateHelsinkiFilterButton:y,setBusControlsVisibility:h,getBusStopMeta:T,getBusStopCodes:w,buildBusStopDisplay:d,updateDataScope:b,renderFilterButtons:k,renderBusControls:N,updateNextSummary:M,buildStatusFromResponse:x,getLoadErrorStatus:$,getGeolocationErrorStatus:G,alignDepartureColumns:s,render:c,updateClock:O})})();(()=>{let R=window.HMApp,{api:i,dom:n,state:t,constants:I}=R,{MODE_BUS:l}=I;function a(m){return new Promise(p=>setTimeout(p,m))}async function C(m,p={},y=I.FETCH_TIMEOUT_MS){let h=new AbortController,T=setTimeout(()=>h.abort(),y);try{return await fetch(m,{...p,signal:h.signal})}finally{clearTimeout(T)}}async function S(m,p={}){let y;try{y=await C(m,p)}catch{return await a(350),C(m,p)}return y.status>=500?(await a(350),C(m,p)):y}function U(m){let p=Array.isArray(m?.stops)?m.stops.filter(d=>d&&d.id&&d.name).map(d=>({id:d.id,name:d.name,code:String(d.code||"").trim()||null,stopCodes:i.uniqueNonEmptyStrings([...Array.isArray(d.stopCodes)?d.stopCodes:[],d.code]),distanceMeters:Number(d.distanceMeters)||0})):[];t.busStops=p;let y=String(m?.selectedStopId||"").trim()||null,h=d=>p.some(b=>b.id===d);y&&h(y)?t.busStopId=y:(!t.busStopId||!h(t.busStopId))&&(t.busStopId=p[0]?.id||null);let T=Array.isArray(m?.filterOptions?.lines)?m.filterOptions.lines.filter(d=>d&&d.value).map(d=>({value:String(d.value),count:Number(d.count)||0})):[],w=Array.isArray(m?.filterOptions?.destinations)?m.filterOptions.destinations.filter(d=>d&&d.value).map(d=>({value:String(d.value),count:Number(d.count)||0})):[];t.busFilterOptions={lines:T,destinations:w},i.sanitizeBusSelections()}async function _(m,p){let y=++t.latestLoadToken,h=t.mode,T=t.busStopId,w=[...t.busLineFilters],d=[...t.busDestinationFilters];i.setLoading(!0),i.setStatus("Loading departures...");try{let b=new URLSearchParams({lat:String(m),lon:String(p),mode:h.toUpperCase(),results:String(i.getActiveResultsLimit(h))});if(h===l&&T){b.set("stopId",T);for(let x of w)b.append("line",x);for(let x of d)b.append("dest",x)}let k=await S(`/api/v1/departures?${b.toString()}`);if(!(k.headers.get("content-type")||"").includes("application/json"))throw k.ok?new Error("Unexpected server response."):new Error("Request failed");let M=await k.json();if(!k.ok)throw new Error(M.error||"Request failed");if(y!==t.latestLoadToken)return;h===l&&(U(M),i.persistUiState()),t.latestResponse=M,i.render(M),i.setPermissionRequired(!1),i.setLastUpdated(new Date),i.setStatus(i.buildStatusFromResponse(M))}catch(b){if(y!==t.latestLoadToken)return;t.latestResponse=null,console.error("load departures error:",b),i.reportClientError("load",b,{mode:h}),i.setStatus(i.getLoadErrorStatus(b)),n.resultEl.classList.add("hidden"),i.updateNextSummary(null)}finally{y===t.latestLoadToken&&i.setLoading(!1)}}function B(){return navigator.geolocation?t.isLoading?!1:(i.setStatus("Getting your location..."),i.setLoading(!0),navigator.geolocation.getCurrentPosition(m=>{t.currentCoords={lat:m.coords.latitude,lon:m.coords.longitude},i.setPermissionRequired(!1),i.setLoading(!1),_(t.currentCoords.lat,t.currentCoords.lon)},m=>{if(i.setLoading(!1),m.code===1){i.setPermissionRequired(!0),i.setStatus(i.getGeolocationErrorStatus(m)),t.latestResponse=null,n.resultEl.classList.add("hidden"),i.updateNextSummary(null);return}i.setPermissionRequired(!1),i.setStatus(i.getGeolocationErrorStatus(m)),t.latestResponse=null,n.resultEl.classList.add("hidden"),i.updateNextSummary(null)},{enableHighAccuracy:!1,timeout:1e4,maximumAge:0}),!0):(i.setStatus("Geolocation not supported in this browser."),i.setPermissionRequired(!0),!1)}function L(){if(t.currentCoords){_(t.currentCoords.lat,t.currentCoords.lon);return}B()}function A(){i.updateModeButtons(),i.updateModeLabels(),i.renderResultsLimitControl(),i.updateHelsinkiFilterButton(),i.renderBusControls(),i.updateDataScope(t.latestResponse)}Object.assign(i,{delay:a,fetchWithTimeout:C,fetchWithRetryOnce:S,updateBusStateFromResponse:U,load:_,requestLocationAndLoad:B,refreshDeparturesOnly:L,applyModeUiState:A})})();(()=>{let R=window.HMApp,{api:i,dom:n,state:t,constants:I}=R,{MODE_RAIL:l,MODE_BUS:a}=I;function C(){if(t.currentCoords){i.load(t.currentCoords.lat,t.currentCoords.lon);return}i.requestLocationAndLoad()}n.locateBtn?.addEventListener("click",()=>{i.requestLocationAndLoad()}),n.modeRailBtn?.addEventListener("click",()=>{t.mode!==l&&(t.mode=l,i.applyModeUiState(),i.persistUiState(),C())}),n.modeBusBtn?.addEventListener("click",()=>{t.mode!==a&&(t.mode=a,t.helsinkiOnly=!1,i.applyModeUiState(),i.persistUiState(),C())}),n.resultsLimitSelectEl?.addEventListener("change",()=>{let S=i.parseResultLimit(n.resultsLimitSelectEl.value);if(S==null){i.renderResultsLimitControl();return}i.getActiveResultsLimit()!==S&&(t.resultsLimitByMode[t.mode]=S,i.persistUiState(),C())}),n.busStopSelectEl?.addEventListener("change",()=>{if(t.suppressBusStopChange||t.mode!==a)return;let S=String(n.busStopSelectEl.value||"").trim();!S||S===t.busStopId||(t.busStopId=S,i.persistUiState(),t.currentCoords&&i.load(t.currentCoords.lat,t.currentCoords.lon))}),n.helsinkiOnlyBtn?.addEventListener("click",()=>{t.mode===l&&(t.helsinkiOnly=!t.helsinkiOnly,i.persistUiState(),i.updateHelsinkiFilterButton(),t.latestResponse&&(i.render(t.latestResponse),i.setStatus(i.buildStatusFromResponse(t.latestResponse))))}),i.hydrateInitialState(),i.persistUiState(),i.applyModeUiState(),i.updateClock(),setInterval(i.updateClock,1e3),i.requestLocationAndLoad(),setInterval(i.refreshDeparturesOnly,3e4),window.addEventListener("resize",()=>{requestAnimationFrame(i.alignDepartureColumns)}),window.addEventListener("error",S=>{i.reportClientError("error",S.error||S.message||"Unknown error",{source:S.filename||"",line:S.lineno||null,column:S.colno||null})}),window.addEventListener("unhandledrejection",S=>{i.reportClientError("unhandledrejection",S.reason||"Unhandled promise rejection")}),(()=>{let S=document.getElementById("themeToggle");if(!S)return;let U=document.documentElement,_=window.matchMedia("(prefers-color-scheme: dark)"),B=()=>{let p=i.getStorageItem("theme");return p==="dark"||p==="light"?p:null},L=p=>{U.setAttribute("data-theme",p==="light"?"light":"dark")},A=()=>{let p=B();if(p){L(p);return}L(_.matches?"dark":"light")},m=p=>{B()||L(p.matches?"dark":"light")};A(),typeof _.addEventListener=="function"?_.addEventListener("change",m):typeof _.addListener=="function"&&_.addListener(m),S.addEventListener("click",()=>{let p=U.getAttribute("data-theme")==="dark"?"light":"dark";L(p),i.setStorageItem("theme",p)})})()})();})();
