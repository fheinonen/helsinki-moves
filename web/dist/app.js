(()=>{(()=>{let N=window.HMApp||(window.HMApp={}),s=N.api||={};N.dom={locateBtn:document.getElementById("locateBtn"),voiceLocateBtn:document.getElementById("voiceLocateBtn"),voiceLocateBtnLabel:document.getElementById("voiceLocateBtnLabel"),skeletonEl:document.getElementById("skeleton"),segmentControlEl:document.querySelector(".segment-control"),modeRailBtn:document.getElementById("modeRailBtn"),modeTramBtn:document.getElementById("modeTramBtn"),modeMetroBtn:document.getElementById("modeMetroBtn"),modeBusBtn:document.getElementById("modeBusBtn"),helsinkiOnlyBtn:document.getElementById("helsinkiOnlyBtn"),busControlsEl:document.getElementById("busControls"),busStopSelectEl:document.getElementById("busStopSelect"),busStopSelectLabelEl:document.getElementById("busStopSelectLabel"),busStopSelectListEl:document.getElementById("busStopSelectList"),busStopSelectWrapEl:document.getElementById("busStopSelectWrap"),busStopFiltersEl:document.getElementById("busStopFilters"),busLineFiltersEl:document.getElementById("busLineFilters"),busDestinationFiltersEl:document.getElementById("busDestinationFilters"),stopFiltersToggleBtnEl:document.getElementById("stopFiltersToggleBtn"),stopFiltersPanelEl:document.getElementById("stopFiltersPanel"),stopFilterSummaryEl:document.getElementById("stopFilterSummary"),resultsLimitSelectEl:document.getElementById("resultsLimitSelect"),resultsLimitSelectLabelEl:document.getElementById("resultsLimitSelectLabel"),resultsLimitSelectListEl:document.getElementById("resultsLimitSelectList"),resultsLimitSelectWrapEl:document.getElementById("resultsLimitSelectWrap"),modeEyebrowEl:document.getElementById("modeEyebrow"),statusEl:document.getElementById("status"),resolvedLocationEl:document.getElementById("resolvedLocation"),voiceLocationChoicesEl:document.getElementById("voiceLocationChoices"),voiceLocationChoicesTitleEl:document.getElementById("voiceLocationChoicesTitle"),voiceLocationChoicesOptionsEl:document.getElementById("voiceLocationChoicesOptions"),voiceLocationChoicesCancelEl:document.getElementById("voiceLocationChoicesCancel"),dataScopeEl:document.getElementById("dataScope"),resultEl:document.getElementById("result"),locationPromptCardEl:document.getElementById("locationPromptCard"),locationPromptAllowEl:document.getElementById("locationPromptAllow"),permissionCardEl:document.getElementById("permissionCard"),permissionRetryBtnEl:document.getElementById("permissionRetryBtn"),stationTitleEl:document.getElementById("stationTitle"),stationMetaEl:document.getElementById("stationMeta"),departuresEl:document.getElementById("departures"),nextSummaryEl:document.getElementById("nextSummary"),nextLabelEl:document.getElementById("nextLabel"),nextMinsEl:document.getElementById("nextMins"),nextLineEl:document.getElementById("nextLine"),nextTrackEl:document.getElementById("nextTrack"),nextDestinationEl:document.getElementById("nextDestination"),nowClockEl:document.getElementById("nowClock"),lastUpdatedEl:document.getElementById("lastUpdated")},N.constants={MODE_RAIL:"rail",MODE_TRAM:"tram",MODE_METRO:"metro",MODE_BUS:"bus",STORAGE_MODE_KEY:"prefs:mode",STORAGE_HELSINKI_ONLY_KEY:"prefs:helsinkiOnly",STORAGE_BUS_STOP_KEY:"prefs:busStopId",STORAGE_BUS_LINES_KEY:"prefs:busLines",STORAGE_BUS_DESTINATIONS_KEY:"prefs:busDestinations",STORAGE_RESULTS_LIMIT_RAIL_KEY:"prefs:resultsLimitRail",STORAGE_RESULTS_LIMIT_TRAM_KEY:"prefs:resultsLimitTram",STORAGE_RESULTS_LIMIT_METRO_KEY:"prefs:resultsLimitMetro",STORAGE_RESULTS_LIMIT_BUS_KEY:"prefs:resultsLimitBus",DEFAULT_RESULTS_LIMIT_RAIL:8,DEFAULT_RESULTS_LIMIT_TRAM:8,DEFAULT_RESULTS_LIMIT_METRO:8,DEFAULT_RESULTS_LIMIT_BUS:24,RESULT_LIMIT_OPTIONS:[8,12,16,20,24,30],VOICE_RECOGNITION_TIMEOUT_MS:8e3,VOICE_SILENCE_STOP_MS:1200,VOICE_QUERY_MIN_LENGTH:3,FETCH_TIMEOUT_MS:8e3,ERROR_REPORT_LIMIT:5,METRIC_REPORT_LIMIT:10,METRIC_SAMPLE_RATE:1};let{MODE_RAIL:n,MODE_TRAM:t,MODE_METRO:x,MODE_BUS:D}=N.constants;N.state={locationGranted:!1,isLoading:!1,isVoiceListening:!1,currentCoords:null,latestResponse:null,mode:n,helsinkiOnly:!1,busStopId:null,busStopMemberFilterId:null,busLineFilters:[],busDestinationFilters:[],stopFilterPinned:!1,stopFiltersPanelOpen:!1,stopFiltersPanelLockUntilMs:0,deferInitialStopContext:!1,deferredBusStopId:null,deferredBusLineFilters:[],deferredBusDestinationFilters:[],resultsLimitByMode:{[n]:N.constants.DEFAULT_RESULTS_LIMIT_RAIL,[t]:N.constants.DEFAULT_RESULTS_LIMIT_TRAM,[x]:N.constants.DEFAULT_RESULTS_LIMIT_METRO,[D]:N.constants.DEFAULT_RESULTS_LIMIT_BUS},busStops:[],busFilterOptions:{lines:[],destinations:[]},resolvedLocationHint:null,suppressBusStopChange:!1,hasCompletedInitialStopModeLoad:!1,errorReportCount:0,metricReportCount:0,isMetricSessionSampled:Math.random()<N.constants.METRIC_SAMPLE_RATE,sessionStartedAtMs:Date.now(),hasReportedFirstSuccessfulRenderMetric:!1,hasReportedFirstManualInteractionMetric:!1,hasReportedFirstManualStopContextMetric:!1,hasReportedInitialNearestStopResolvedMetric:!1,latestLoadToken:0};let{dom:v,state:c,constants:I}=N;function V(){let i=c.isLoading||c.isVoiceListening,u=c.isLoading;v.locateBtn&&(v.locateBtn.disabled=i),v.voiceLocateBtn&&(v.voiceLocateBtn.disabled=u,v.voiceLocateBtn.classList.toggle("is-listening",c.isVoiceListening),v.voiceLocateBtn.setAttribute("aria-pressed",String(c.isVoiceListening))),v.voiceLocateBtnLabel&&(v.voiceLocateBtnLabel.textContent=c.isVoiceListening?"Listening...":"Describe Location")}function Q(i){c.isLoading=i,V(),v.skeletonEl&&v.skeletonEl.classList.toggle("hidden",!i)}function $(i){c.isVoiceListening=!!i,V()}function rt(i){v.statusEl&&(v.statusEl.textContent=i)}function f(i){let u=Number(i);return Number.isFinite(u)?u.toFixed(5):null}function h(i){let u=i&&typeof i=="object";if(c.resolvedLocationHint=u?{query:k(i.query,120).trim(),label:k(i.label,180).trim(),lat:Number(i.lat),lon:Number(i.lon)}:null,!v.resolvedLocationEl)return;if(!c.resolvedLocationHint){v.resolvedLocationEl.classList.add("hidden"),v.resolvedLocationEl.textContent="";return}let E=c.resolvedLocationHint.label||"Unknown place",C=c.resolvedLocationHint.query,O=f(c.resolvedLocationHint.lat),B=f(c.resolvedLocationHint.lon),Z=C?` (from "${C}")`:"",P=O&&B?` - ${O}, ${B}`:"";v.resolvedLocationEl.textContent=`Resolved location: ${E}${Z}${P}`,v.resolvedLocationEl.classList.remove("hidden")}function _(){v.locationPromptCardEl&&v.locationPromptCardEl.classList.remove("hidden"),v.permissionCardEl&&v.permissionCardEl.classList.add("hidden")}function T(){v.locationPromptCardEl&&v.locationPromptCardEl.classList.add("hidden")}function w(i){T(),v.permissionCardEl&&v.permissionCardEl.classList.toggle("hidden",!i)}function A(i){!v.lastUpdatedEl||!(i instanceof Date)||(v.lastUpdatedEl.textContent=`Last updated: ${i.toLocaleTimeString([],{hour:"2-digit",minute:"2-digit",second:"2-digit",hour12:!1})}`)}function F(i){try{return window.localStorage.getItem(i)}catch{return null}}function M(i,u){try{window.localStorage.setItem(i,u)}catch{}}function k(i,u){let E=String(i||"");return E.length<=u?E:E.slice(0,u)}function X(i){if(i instanceof Error)return i;try{let u=typeof i=="string"?i:JSON.stringify(i);return new Error(u||"Unknown error")}catch{return new Error(String(i||"Unknown error"))}}function st(i){let u=JSON.stringify(i);if(navigator.sendBeacon){let E=new Blob([u],{type:"application/json"});navigator.sendBeacon("/api/v1/client-error",E);return}fetch("/api/v1/client-error",{method:"POST",headers:{"content-type":"application/json"},body:u,keepalive:!0}).catch(()=>{})}function nt(i,u,E=null){if(c.errorReportCount>=I.ERROR_REPORT_LIMIT)return;c.errorReportCount+=1;let C=X(u),O={type:k(i,40),message:k(C.message,400),stack:k(C.stack||"",1200),url:k(window.location.href,500),userAgent:k(navigator.userAgent||"",300),timestamp:new Date().toISOString(),context:E&&typeof E=="object"?E:null};st(O)}function lt(){return Math.max(0,Date.now()-c.sessionStartedAtMs)}function J(i,u=null){if(!c.isMetricSessionSampled||c.metricReportCount>=I.METRIC_REPORT_LIMIT)return!1;c.metricReportCount+=1;let E={type:"metric",message:k(i,400),stack:"",url:k(window.location.href,500),userAgent:k(navigator.userAgent||"",300),timestamp:new Date().toISOString(),context:{metricName:k(i,80),sessionElapsedMs:lt(),mode:c.mode,...u&&typeof u=="object"?u:{}}};return st(E),!0}function dt(i,u){if(c.hasReportedFirstSuccessfulRenderMetric)return;c.hasReportedFirstSuccessfulRenderMetric=!0;let E=Array.isArray(i?.station?.departures)?i.station.departures:[];J("first_successful_render",{requestMode:String(u||"").trim(),hasStation:!!i?.station,departureCount:E.length})}function gt(i,u=null){c.hasReportedFirstManualInteractionMetric||(c.hasReportedFirstManualInteractionMetric=!0,J("first_manual_interaction",{interactionType:k(i,80),...u&&typeof u=="object"?u:{}}))}function pt(i,u=null){c.hasReportedFirstManualStopContextMetric||(c.hasReportedFirstManualStopContextMetric=!0,J("first_manual_stop_context_change",{changeType:k(i,80),lineFilterCount:c.busLineFilters.length,destinationFilterCount:c.busDestinationFilters.length,...u&&typeof u=="object"?u:{}}))}function ot(i,u){if(c.hasReportedInitialNearestStopResolvedMetric)return;let E=String(i?.selectedStopId||"").trim();if(!E)return;c.hasReportedInitialNearestStopResolvedMetric=!0;let O=(Array.isArray(i?.stops)?i.stops:[]).find(Z=>Z?.id===E)||null,B=Array.isArray(i?.station?.departures)?i.station.departures:[];J("initial_nearest_stop_resolved",{requestMode:String(u||"").trim(),selectedStopId:E,distanceMeters:Number(O?.distanceMeters)||null,departureCount:B.length})}function K(i){if(!i)return null;let u=String(i).trim().toLowerCase();return u===n||u===t||u===x||u===D?u:null}function H(i){if(i==null)return null;let u=String(i).trim().toLowerCase();return["1","true","yes","on"].includes(u)?!0:["0","false","no","off"].includes(u)?!1:null}function Y(i){return Array.isArray(i)?[...new Set(i.map(u=>String(u||"").trim()).filter(Boolean))]:[]}function j(i){if(i==null||i==="")return null;let u=Number(i);return!Number.isInteger(u)||!I.RESULT_LIMIT_OPTIONS.includes(u)?null:u}function at(i=c.mode){return i===D?I.DEFAULT_RESULTS_LIMIT_BUS:i===x?I.DEFAULT_RESULTS_LIMIT_METRO:i===t?I.DEFAULT_RESULTS_LIMIT_TRAM:I.DEFAULT_RESULTS_LIMIT_RAIL}function a(i=c.mode){let u=j(c.resultsLimitByMode?.[i]);return u??at(i)}function d(i){let u=F(i);if(!u)return[];try{let E=JSON.parse(u);return Y(E)}catch{return[]}}function p(){let i=new URLSearchParams(window.location.search);return{mode:K(i.get("mode")),helsinkiOnly:H(i.get("helsinkiOnly")),stopProvided:i.has("stop"),busStopId:i.get("stop")?i.get("stop").trim():null,linesProvided:i.has("line"),busLines:Y(i.getAll("line")),destinationsProvided:i.has("dest"),busDestinations:Y(i.getAll("dest")),resultsProvided:i.has("results"),resultsLimit:j(i.get("results"))}}function S(){let i=p(),u=K(F(I.STORAGE_MODE_KEY)),E=H(F(I.STORAGE_HELSINKI_ONLY_KEY));c.mode=i.mode||u||n,c.helsinkiOnly=i.helsinkiOnly??E??!1,c.mode!==n&&(c.helsinkiOnly=!1);let C=String(F(I.STORAGE_BUS_STOP_KEY)||"").trim()||null,O=i.stopProvided?i.busStopId:C,B=d(I.STORAGE_BUS_LINES_KEY),Z=d(I.STORAGE_BUS_DESTINATIONS_KEY),P=i.linesProvided?i.busLines:B,tt=i.destinationsProvided?i.busDestinations:Z,U=!!O||P.length>0||tt.length>0;c.deferInitialStopContext=U,U?(c.deferredBusStopId=O,c.deferredBusLineFilters=[...P],c.deferredBusDestinationFilters=[...tt],c.busStopId=null,c.busLineFilters=[],c.busDestinationFilters=[]):(c.deferredBusStopId=null,c.deferredBusLineFilters=[],c.deferredBusDestinationFilters=[],c.busStopId=O,c.busLineFilters=P,c.busDestinationFilters=tt);let q=j(F(I.STORAGE_RESULTS_LIMIT_RAIL_KEY)),mt=j(F(I.STORAGE_RESULTS_LIMIT_TRAM_KEY)),ct=j(F(I.STORAGE_RESULTS_LIMIT_METRO_KEY)),Et=j(F(I.STORAGE_RESULTS_LIMIT_BUS_KEY));c.resultsLimitByMode[n]=q??I.DEFAULT_RESULTS_LIMIT_RAIL,c.resultsLimitByMode[t]=mt??I.DEFAULT_RESULTS_LIMIT_TRAM,c.resultsLimitByMode[x]=ct??I.DEFAULT_RESULTS_LIMIT_METRO,c.resultsLimitByMode[D]=Et??I.DEFAULT_RESULTS_LIMIT_BUS,i.resultsProvided&&i.resultsLimit!=null&&(c.resultsLimitByMode[c.mode]=i.resultsLimit)}function g(){M(I.STORAGE_MODE_KEY,c.mode),M(I.STORAGE_HELSINKI_ONLY_KEY,c.helsinkiOnly?"1":"0"),M(I.STORAGE_BUS_STOP_KEY,c.busStopId||""),M(I.STORAGE_BUS_LINES_KEY,JSON.stringify(c.busLineFilters)),M(I.STORAGE_BUS_DESTINATIONS_KEY,JSON.stringify(c.busDestinationFilters)),M(I.STORAGE_RESULTS_LIMIT_RAIL_KEY,String(a(n))),M(I.STORAGE_RESULTS_LIMIT_TRAM_KEY,String(a(t))),M(I.STORAGE_RESULTS_LIMIT_METRO_KEY,String(a(x))),M(I.STORAGE_RESULTS_LIMIT_BUS_KEY,String(a(D)))}function y(){let i=new URLSearchParams(window.location.search);c.mode===n?i.delete("mode"):i.set("mode",c.mode),c.mode===n&&c.helsinkiOnly?i.set("helsinkiOnly","1"):i.delete("helsinkiOnly");let u=a(),E=at();if(u===E?i.delete("results"):i.set("results",String(u)),i.delete("stop"),i.delete("line"),i.delete("dest"),c.mode===D||c.mode===t||c.mode===x){c.busStopId&&i.set("stop",c.busStopId);for(let B of c.busLineFilters)i.append("line",B);for(let B of c.busDestinationFilters)i.append("dest",B)}let C=i.toString(),O=`${window.location.pathname}${C?`?${C}`:""}${window.location.hash}`;window.history.replaceState(null,"",O)}function b(){g(),y()}V(),Object.assign(s,{updateLocationActionButtons:V,setLoading:Q,setVoiceListening:$,setStatus:rt,setResolvedLocationHint:h,showLocationPrompt:_,hideLocationPrompt:T,setPermissionRequired:w,setLastUpdated:A,getStorageItem:F,setStorageItem:M,safeString:k,toError:X,sendClientReport:st,reportClientError:nt,reportClientMetric:J,getSessionElapsedMs:lt,trackFirstSuccessfulRender:dt,trackFirstManualInteraction:gt,trackFirstManualStopContextChange:pt,trackInitialNearestStopResolved:ot,normalizeMode:K,parseBoolean:H,uniqueNonEmptyStrings:Y,parseResultLimit:j,getDefaultResultsLimit:at,getActiveResultsLimit:a,parseStoredArray:d,readStateFromUrl:p,hydrateInitialState:S,syncStateToStorage:g,syncStateToUrl:y,persistUiState:b})})();(()=>{let N=window.HMApp,{api:s,dom:n,state:t,constants:x}=N,{MODE_RAIL:D,MODE_TRAM:v,MODE_METRO:c,MODE_BUS:I}=x,V=1500,Q=V+200,$=14,rt=1300,f=null,h=null;function _(e=t.mode){return e===I||e===v||e===c}function T(e=t.mode){return e===v?{singular:"tram",plural:"trams",title:"Tram"}:e===c?{singular:"metro",plural:"metros",title:"Metro"}:{singular:"bus",plural:"buses",title:"Bus"}}function w(e){let o=A(e);return o<=0?"Now":`${o}m`}function A(e){let o=new Date(e);return Math.floor((o.getTime()-Date.now())/6e4)}function F(e){let o=A(e);return o<=0||o<3?"departure-now":o<=10?"departure-soon":"departure-later"}function M(e){let o=e?.destination||"";return/\bhelsinki\b/i.test(o)}function k(){let e=new Set((t.busFilterOptions.lines||[]).map(r=>r.value)),o=new Set((t.busFilterOptions.destinations||[]).map(r=>r.value));t.busLineFilters=t.busLineFilters.filter(r=>e.has(r)),t.busDestinationFilters=t.busDestinationFilters.filter(r=>o.has(r))}function X(e){if(!Array.isArray(e))return[];if(t.mode===D)return t.helsinkiOnly?e.filter(M):e;if(!_())return e;let o=new Set(t.busLineFilters),r=new Set(t.busDestinationFilters),l=String(t.busStopMemberFilterId||"").trim();return e.filter(m=>{if(o.size===0)return!0;let L=String(m?.line||"").trim();return o.has(L)}).filter(m=>{if(r.size===0)return!0;let L=String(m?.destination||"").trim();return r.has(L)}).filter(m=>l?String(m?.stopId||"").trim()===l:!0)}function st(){let e=[{el:n.modeRailBtn,mode:D,index:0},{el:n.modeTramBtn,mode:v,index:1},{el:n.modeMetroBtn,mode:c,index:2},{el:n.modeBusBtn,mode:I,index:3}];for(let{el:o,mode:r,index:l}of e){if(!o)continue;let m=t.mode===r;if(o.setAttribute("aria-checked",String(m)),o.classList.toggle("is-active",m),m){let L=o.closest(".segment-control");L&&L.style.setProperty("--active-index",l)}}}function nt(){let e=_()?T().title:"Rail",o="";n.modeEyebrowEl&&(n.modeEyebrowEl.textContent=`Helsinki Moves \u2022 ${e}`),n.nextLabelEl&&(n.nextLabelEl.textContent=o)}function lt(e){if(!n.resultsLimitSelectEl||!n.resultsLimitSelectListEl)return;let o=n.resultsLimitSelectEl.getAttribute("aria-expanded")==="true",r=typeof e=="boolean"?e:!o;n.resultsLimitSelectEl.setAttribute("aria-expanded",String(r)),n.resultsLimitSelectListEl.classList.toggle("hidden",!r)}function J(e){let o=s.parseResultLimit(e);o==null||(lt(!1),s.getActiveResultsLimit()===o)||(s.trackFirstManualInteraction("results_limit_change",{nextLimit:o,currentMode:t.mode}),t.resultsLimitByMode[t.mode]=o,s.persistUiState(),n.resultsLimitSelectLabelEl&&(n.resultsLimitSelectLabelEl.textContent=String(o)),t.currentCoords?s.load(t.currentCoords.lat,t.currentCoords.lon):s.requestLocationAndLoad())}function dt(){if(!n.resultsLimitSelectListEl)return;let e=Array.isArray(x.RESULT_LIMIT_OPTIONS)?x.RESULT_LIMIT_OPTIONS:[],o=s.getActiveResultsLimit();n.resultsLimitSelectListEl.innerHTML="";for(let r of e){let l=document.createElement("li");l.setAttribute("role","option"),l.dataset.value=String(r),l.textContent=String(r),r===o&&l.setAttribute("aria-selected","true"),l.addEventListener("click",()=>J(String(r))),n.resultsLimitSelectListEl.appendChild(l)}n.resultsLimitSelectLabelEl&&(n.resultsLimitSelectLabelEl.textContent=String(o))}function gt(){if(n.helsinkiOnlyBtn){if(t.mode!==D){n.helsinkiOnlyBtn.setAttribute("aria-pressed","false"),n.helsinkiOnlyBtn.classList.remove("is-active"),n.helsinkiOnlyBtn.disabled=!0,n.helsinkiOnlyBtn.textContent="Helsinki Only (Rail)";return}n.helsinkiOnlyBtn.disabled=!1,n.helsinkiOnlyBtn.setAttribute("aria-pressed",String(t.helsinkiOnly)),n.helsinkiOnlyBtn.classList.toggle("is-active",t.helsinkiOnly),n.helsinkiOnlyBtn.textContent=t.helsinkiOnly?"Helsinki Only: On":"Helsinki Only: Off"}}function pt(){let e=K()?1:0;return Math.max(0,t.busLineFilters.length)+Math.max(0,t.busDestinationFilters.length)+e}function ot(e=t.busLineFilters.length,o=t.busDestinationFilters.length,r=K()){let l=Math.max(0,Number(e)||0)+Math.max(0,Number(o)||0)+(r?1:0);return l===0?"No filters":l===1?"1 filter":`${l} filters`}function K(){return _()?!!(t.stopFilterPinned||String(t.busStopMemberFilterId||"").trim()):!1}function H(){n.stopFilterSummaryEl?.classList?.remove?.("is-attention"),n.stopFiltersToggleBtnEl?.classList?.remove?.("is-attention")}function Y(){h&&(clearTimeout(h),h=null)}function j(){if(typeof window?.matchMedia=="function")try{if(window.matchMedia("(max-width: 679px)").matches)return!0}catch{}let e=Number(window?.innerWidth);return Number.isFinite(e)?e<=679:!1}function at(){if(j())return!1;let e=Array.isArray(t.busFilterOptions?.lines)?t.busFilterOptions.lines.length:0,o=Array.isArray(t.busFilterOptions?.destinations)?t.busFilterOptions.destinations.length:0;return e+o<=$}function a(){if(!_())return;!t.stopFiltersPanelOpen&&at()?(t.stopFiltersPanelLockUntilMs=Date.now()+V,S(!0),Y(),h=setTimeout(()=>{t.stopFiltersPanelLockUntilMs=0,S(!1),h=null},Q)):t.stopFiltersPanelLockUntilMs=0,H(),n.stopFilterSummaryEl?.classList?.add?.("is-attention"),n.stopFiltersToggleBtnEl?.classList?.add?.("is-attention"),f&&(clearTimeout(f),f=null),f=setTimeout(()=>{H(),f=null},rt)}function d(){return Number(t.stopFiltersPanelLockUntilMs||0)>Date.now()}function p(){n.stopFilterSummaryEl&&(n.stopFilterSummaryEl.textContent=ot()),n.busStopSelectEl&&n.busStopSelectEl.classList.toggle("is-active-filter",K()),!(!n.stopFiltersToggleBtnEl||!n.stopFiltersPanelEl)&&(n.stopFiltersToggleBtnEl.setAttribute("aria-expanded",String(!!t.stopFiltersPanelOpen)),n.stopFiltersPanelEl.classList.toggle("hidden",!t.stopFiltersPanelOpen))}function S(e){t.stopFiltersPanelOpen=!!e,p()}function g(e){if(Y(),(e===!1||e==null&&t.stopFiltersPanelOpen)&&d())return;let o=typeof e=="boolean"?e:!t.stopFiltersPanelOpen;S(o)}function y(e){n.busControlsEl&&(n.busControlsEl.classList.toggle("hidden",!e),e||(Y(),t.stopFiltersPanelOpen=!1,t.stopFiltersPanelLockUntilMs=0,H(),n.busStopSelectEl?.classList?.remove?.("is-active-filter")),p())}function b(){t.latestResponse&&(s.render(t.latestResponse),s.setStatus(s.buildStatusFromResponse(t.latestResponse)))}function i({interactionType:e,changeType:o,showAttention:r=!1,requireLoad:l=!1,extraContext:m=null}){if(s.trackFirstManualInteraction(e,{currentMode:t.mode,...m&&typeof m=="object"?m:{}}),s.trackFirstManualStopContextChange(o,m),s.persistUiState(),p(),r&&a(),l){t.currentCoords?s.load(t.currentCoords.lat,t.currentCoords.lon):s.requestLocationAndLoad();return}b()}function u(e,o){let r=String(o||"").trim();return r?e.includes(r)?e.filter(l=>l!==r):[...e,r]:e}function E(e,{interactionType:o="line_filter_toggle",changeType:r="line_filter_toggle",showAttention:l=!1}={}){if(!_())return!1;let m=u(t.busLineFilters,e);return m.length===t.busLineFilters.length?!1:(t.busLineFilters=m,i({interactionType:o,changeType:r,showAttention:l}),!0)}function C(e,{interactionType:o="destination_filter_toggle",changeType:r="destination_filter_toggle",showAttention:l=!1}={}){if(!_())return!1;let m=u(t.busDestinationFilters,e);return m.length===t.busDestinationFilters.length?!1:(t.busDestinationFilters=m,i({interactionType:o,changeType:r,showAttention:l}),!0)}function O(e){return t.busStops.find(o=>o.id===e)||null}function B(e){let o=s.uniqueNonEmptyStrings([...Array.isArray(e?.stopCodes)?e.stopCodes:[],e?.code]);return o.length===0&&e?.id&&o.push(String(e.id)),o}function Z(e){return s.uniqueNonEmptyStrings([...Array.isArray(e?.memberStopIds)?e.memberStopIds:[],e?.id])}function P(e,o=null){let r=O(t.busStopId),l=String(o?.stopName||e?.stopName||r?.name||"").trim(),L=s.uniqueNonEmptyStrings([o?.stopCode,...Array.isArray(e?.stopCodes)?e.stopCodes:[],e?.stopCode,...B(r)])[0]||"";return l&&L?`${l} ${L}`:l||L||"\u2014"}function tt(e,o=null){if(_())return P(e,o);let r=String(o?.stopName||e?.stopName||"").trim(),l=String(o?.stopCode||e?.stopCode||"").trim();return r&&l?`${r} ${l}`:r||l||"\u2014"}function U(){if(n.dataScopeEl){if(typeof n.dataScopeEl.replaceChildren=="function"){n.dataScopeEl.replaceChildren();return}Array.isArray(n.dataScopeEl.children)&&(n.dataScopeEl.children.length=0),n.dataScopeEl.innerHTML=""}}function q(e,o="default"){let r=document.createElement("span");return r.className="data-scope-chip",o&&r.classList.add(`data-scope-chip--${o}`),r.textContent=e,r}function mt(e){let o=String(t.busStopMemberFilterId||"").trim();if(o){let L=(Array.isArray(e?.station?.departures)?e.station.departures:[]).find(G=>String(G?.stopId||"").trim()===o),R=String(L?.stopCode||"").trim();return R||o}if(!t.stopFilterPinned)return"";let r=O(t.busStopId),l=String(B(r)[0]||"").trim();return l||String(r?.name||t.busStopId||"").trim()}function ct(e){if(!n.dataScopeEl)return;if(U(),n.dataScopeEl.textContent="",!_()){n.dataScopeEl.classList.add("hidden");return}let o=[],r=mt(e);r&&o.push(q(r,"stop"));for(let l of t.busLineFilters)o.push(q(l,"line"));for(let l of t.busDestinationFilters)o.push(q(l,"destination"));if(o.length===0){n.dataScopeEl.classList.add("hidden");return}for(let l of o)n.dataScopeEl.appendChild(l);n.dataScopeEl.classList.remove("hidden")}function Et(e,o,r,l){if(!e)return;if(e.innerHTML="",!Array.isArray(o)||o.length===0){let L=document.createElement("span");L.className="chip-empty",L.textContent="No options",e.appendChild(L);return}let m=new Set(r);for(let L of o){let R=document.createElement("button");R.type="button",R.className="chip-toggle",m.has(L.value)?(R.classList.add("is-active"),R.setAttribute("aria-pressed","true")):R.setAttribute("aria-pressed","false"),R.textContent=`${L.value} (${L.count})`,R.addEventListener("click",()=>l(L.value)),e.appendChild(R)}}function Bt(){let e=Array.isArray(t.latestResponse?.station?.departures)?t.latestResponse.station.departures:[],o=new Map;for(let r of e){let l=String(r?.stopId||"").trim();if(!l)continue;let m=o.get(l);m?(m.count+=1,m.stopCode||(m.stopCode=String(r?.stopCode||"").trim()),m.stopName||(m.stopName=String(r?.stopName||"").trim())):o.set(l,{id:l,count:1,stopCode:String(r?.stopCode||"").trim(),stopName:String(r?.stopName||"").trim()})}return[...o.values()].sort((r,l)=>l.count-r.count||r.id.localeCompare(l.id)).map(r=>{let l=Lt({stopId:r.id,stopCode:r.stopCode||"",stopName:r.stopName||""},t.latestResponse?.station||null);return{...r,selectableStopId:l.selectableStopId}})}function xt(){if(!n.busStopFiltersEl)return;n.busStopFiltersEl.innerHTML="";let e=Bt();if(e.length===0){let r=document.createElement("span");r.className="chip-empty",r.textContent="No stops",n.busStopFiltersEl.appendChild(r);return}let o=String(t.busStopMemberFilterId||"").trim();for(let r of e){let l=document.createElement("button");l.type="button",l.className="chip-toggle",l.dataset.value=r.id,!!(o&&r.id===o)?(l.classList.add("is-active"),l.setAttribute("aria-pressed","true")):l.setAttribute("aria-pressed","false");let L=r.stopCode||r.id;l.textContent=L,l.addEventListener("click",()=>Tt(r.selectableStopId,r.id)),n.busStopFiltersEl.appendChild(l)}}function _t(e){if(!n.busStopSelectEl||!n.busStopSelectListEl)return;let o=n.busStopSelectEl.getAttribute("aria-expanded")==="true",r=typeof e=="boolean"?e:!o;n.busStopSelectEl.setAttribute("aria-expanded",String(r)),n.busStopSelectListEl.classList.toggle("hidden",!r)}function vt(e){if(!t.suppressBusStopChange){if(!e||e===t.busStopId){_t(!1);return}if(t.busStopId=e,t.stopFilterPinned=!0,t.busStopMemberFilterId=null,_t(!1),n.busStopSelectLabelEl){let o=t.busStops.find(r=>r.id===e);n.busStopSelectLabelEl.textContent=o?`${o.name} (${o.distanceMeters}m)`:e}i({interactionType:"stop_select",changeType:"stop_select",requireLoad:!0,extraContext:{selectedStopId:e}})}}function Ct(){return t.busStops[0]?.id||null}function It(e,o=null){let r=String(e||"").trim();if(!r||!t.stopFilterPinned||String(t.busStopId||"").trim()!==r)return!1;let m=String(t.busStopMemberFilterId||"").trim(),L=String(o||"").trim();return L?m===L:!m}function Tt(e,o=null){if(!_())return!1;let r=String(e||"").trim()||null,l=String(o||"").trim()||null,m=String(t.busStopId||"").trim()||null,L=String(t.busStopMemberFilterId||"").trim()||null,R=Ct(),G=r||m||R;if(!G)return!1;let ut=!!t.stopFilterPinned,ft=It(G,l),z=m,et=ut,it=L;ft?(et=!1,it=null,z=R||G):(z=G,et=!0,it=l);let bt=z!==m;if(z===m&&et===ut&&it===L)return!1;if(t.busStopId=z,t.stopFilterPinned=et,t.busStopMemberFilterId=it,n.busStopSelectLabelEl){let St=O(t.busStopId);n.busStopSelectLabelEl.textContent=St?`${St.name} (${St.distanceMeters}m)`:"Nearest stop"}return i({interactionType:"result_card_stop_toggle",changeType:"result_card_stop_toggle",showAttention:!0,requireLoad:bt,extraContext:{selectedStopId:t.busStopId||"",selectedMemberStopId:t.busStopMemberFilterId||""}}),!0}function Lt(e,o=null){let r=String(e?.stopId||"").trim();if(r){let m=t.busStops.find(L=>Z(L).includes(r));if(m?.id)return{selectableStopId:m.id,memberStopId:r}}let l=s.uniqueNonEmptyStrings([e?.stopCode,...Array.isArray(o?.stopCodes)?o.stopCodes:[],o?.stopCode]);for(let m of l){let L=t.busStops.find(R=>B(R).includes(m));if(L?.id)return{selectableStopId:L.id,memberStopId:r||null}}return{selectableStopId:t.busStopId||Ct(),memberStopId:r||null}}function Nt(e,o=null){return Lt(e,o).selectableStopId}function W(e){e&&(e.classList?.remove?.("result-filter-trigger","is-active"),e.removeAttribute?.("role"),e.removeAttribute?.("tabindex"),e.removeAttribute?.("aria-pressed"),e.removeAttribute?.("aria-label"),e.onclick=null,e.onkeydown=null)}function ht(e,{active:o=!1,onActivate:r,ariaLabel:l}){if(!e||typeof r!="function"){W(e);return}e.classList?.add?.("result-filter-trigger"),e.classList?.toggle?.("is-active",!!o),e.setAttribute?.("role","button"),e.setAttribute?.("tabindex","0"),e.setAttribute?.("aria-pressed",String(!!o)),e.setAttribute?.("aria-label",String(l||"Toggle filter"));let m=()=>r();e.onclick=()=>m(),e.onkeydown=L=>{let R=L?.key;R!=="Enter"&&R!==" "&&R!=="Spacebar"||(L?.preventDefault?.(),m())}}function Mt(e,o){let r=String(o||"").trim();if(!_()||!r){W(e);return}ht(e,{active:t.busLineFilters.includes(r),onActivate:()=>wt(r),ariaLabel:`Toggle line filter ${r}`})}function Rt(e,o){let r=String(o||"").trim();if(!_()||!r){W(e);return}ht(e,{active:t.busDestinationFilters.includes(r),onActivate:()=>At(r),ariaLabel:`Toggle destination filter ${r}`})}function Ft(e,o,r){if(!_()){W(e);return}ht(e,{active:It(o,r),onActivate:()=>Tt(o,r),ariaLabel:"Toggle stop filter"})}function wt(e){return E(e,{interactionType:"result_card_line_toggle",changeType:"result_card_line_toggle",showAttention:!0})}function At(e){return C(e,{interactionType:"result_card_destination_toggle",changeType:"result_card_destination_toggle",showAttention:!0})}function Ot(){let e=_();if(y(e),!!e){if(p(),n.busStopSelectListEl){if(t.suppressBusStopChange=!0,n.busStopSelectListEl.innerHTML="",t.busStops.length===0)n.busStopSelectLabelEl&&(n.busStopSelectLabelEl.textContent=`No nearby ${T().singular} stops`),n.busStopSelectEl&&(n.busStopSelectEl.disabled=!0);else{n.busStopSelectEl&&(n.busStopSelectEl.disabled=!1);let o=t.busStopId;(!o||!t.busStops.some(r=>r.id===o))&&(o=t.busStops[0].id);for(let r of t.busStops){let l=document.createElement("li");l.setAttribute("role","option"),l.dataset.value=r.id,l.textContent=`${r.name} (${r.distanceMeters}m)`,r.id===o&&l.setAttribute("aria-selected","true"),l.addEventListener("click",()=>vt(r.id)),n.busStopSelectListEl.appendChild(l)}if(n.busStopSelectLabelEl){let r=t.busStops.find(l=>l.id===o);n.busStopSelectLabelEl.textContent=r?`${r.name} (${r.distanceMeters}m)`:"Select stop"}}t.suppressBusStopChange=!1}xt(),Et(n.busLineFiltersEl,t.busFilterOptions.lines,t.busLineFilters,o=>E(o)),Et(n.busDestinationFiltersEl,t.busFilterOptions.destinations,t.busDestinationFilters,o=>C(o))}}function yt(e,o=null){if(!n.nextSummaryEl||!n.nextMinsEl||!n.nextLineEl||!n.nextTrackEl||!n.nextDestinationEl)return;if(!e){n.nextSummaryEl.classList.add("hidden"),n.nextSummaryEl.classList.remove("next-summary-now","next-summary-soon","next-summary-later"),W(n.nextLineEl),W(n.nextDestinationEl),W(n.nextTrackEl);return}let r=A(e.departureIso);if(n.nextMinsEl.textContent=w(e.departureIso),n.nextLineEl.textContent=e.line||"\u2014",n.nextLineEl.classList.toggle("next-letter-now",r<3),n.nextTrackEl.textContent=_()?tt(o,e):e.track?`Track ${e.track}`:"Track \u2014",n.nextDestinationEl.textContent=e.destination||"\u2014",_()){let l=Lt(e,o);Mt(n.nextLineEl,e.line),Rt(n.nextDestinationEl,e.destination),Ft(n.nextTrackEl,l.selectableStopId,l.memberStopId)}else W(n.nextLineEl),W(n.nextDestinationEl),W(n.nextTrackEl);n.nextSummaryEl.classList.remove("next-summary-now","next-summary-soon","next-summary-later"),r<3?n.nextSummaryEl.classList.add("next-summary-now"):r<=10?n.nextSummaryEl.classList.add("next-summary-soon"):n.nextSummaryEl.classList.add("next-summary-later"),n.nextSummaryEl.classList.remove("hidden")}function Ut(e){if(!e||!e.station)return _()?e?.message||`No nearby ${T().singular} stops found.`:e?.message||"No nearby train stations found.";let r=X(e.station.departures)[0];if(!r)return _()?t.busLineFilters.length>0||t.busDestinationFilters.length>0||K()?`No upcoming ${T().plural} match selected filters.`:"No upcoming departures from this stop.":t.helsinkiOnly?"No Helsinki-bound trains in upcoming departures.":"No upcoming commuter trains right now.";let l=_()?T().singular:"train";return`${l.charAt(0).toUpperCase()+l.slice(1)} in ${w(r.departureIso)}`}function Dt(e){if(!(e instanceof Error))return"Could not refresh departures. Please try again.";if(e.name==="AbortError")return"Request timed out. Please try again.";let o=(e.message||"").trim();return o==="Temporary server error. Please try again."?o:o==="Invalid lat/lon"?"Location coordinates were invalid. Please refresh your location.":o==="Invalid mode"?"Unsupported transport mode.":"Could not refresh departures. Please try again."}function Pt(e){return e?.code===1?"Location permission denied.":e?.code===2?"Location unavailable. Please try again.":e?.code===3?"Location request timed out. Please try again.":"Unable to get your location."}function qt(e){let o=String(e?.code||"").trim();return o==="voice_unsupported"?"Voice location is not supported in this browser.":o==="voice_permission_denied"?"Microphone permission denied.":o==="voice_no_microphone"?"No microphone was found for voice location.":o==="voice_no_speech"?"No speech detected. Please try again.":o==="voice_recognition_timeout"?"Voice listening timed out. Please try again.":o==="voice_language_not_supported"?"Voice language was not supported on this device.":o==="voice_query_too_short"?"Please describe your location with a few words.":o==="voice_location_not_found"?"Could not match that place. Try a nearby landmark or street.":o==="voice_location_selection_cancelled"?"Location selection was cancelled.":o==="voice_location_selection_invalid"?"Please choose one of the suggested locations.":o==="voice_recognition_network"?"Voice recognition failed due to a network error. On iPhone, try enabling Siri & Dictation.":"Could not use voice location. Please try again."}function Vt(){n.skeletonEl&&n.skeletonEl.classList.remove("hidden")}function kt(){n.skeletonEl&&n.skeletonEl.classList.add("hidden")}function $t(e){if(kt(),Ot(),ct(e),!e||!e.station){n.resultEl.classList.add("hidden"),yt(null);return}let o=e.station;n.resultEl.classList.remove("hidden"),n.stationTitleEl.textContent=o.stopName,n.stationMetaEl.textContent=`${o.distanceMeters}m away`,n.departuresEl.innerHTML="";let r=X(o.departures);if(r.length===0){yt(null);let m=document.createElement("li");m.className="empty-row",_()?m.textContent=t.busLineFilters.length>0||t.busDestinationFilters.length>0||K()?`No upcoming ${T().plural} match selected filters.`:"No upcoming departures from this stop.":m.textContent=t.helsinkiOnly?"No Helsinki-bound trains in upcoming departures.":"No upcoming commuter trains right now.",n.departuresEl.appendChild(m);return}yt(r[0],o);let l=r.slice(1);if(l.length===0){let m=document.createElement("li");m.className="empty-row",m.textContent=_()?`No additional upcoming ${T().plural} right now.`:"No additional upcoming commuter trains right now.",n.departuresEl.appendChild(m);return}for(let m=0;m<l.length;m++){let L=l[m],R=document.createElement("li");R.className=`departure-row ${F(L.departureIso)}`,R.style.setProperty("--i",m);let G=document.createElement("div");G.className="letter-badge",G.textContent=L.line||"?",_()&&Mt(G,L.line);let ut=document.createElement("div");ut.className="train";let ft=document.createElement("div");ft.className="destination",ft.textContent=L.destination||"\u2014",_()&&Rt(ft,L.destination),ut.appendChild(ft);let z=document.createElement("span");if(z.className="track",_()){z.textContent=tt(o,L);let St=Lt(L,o);Ft(z,St.selectableStopId,St.memberStopId)}else z.textContent=L.track?`Track ${L.track}`:"Track \u2014";ut.appendChild(z);let et=document.createElement("div");et.className="time";let it=document.createElement("span");it.className="remaining",it.textContent=w(L.departureIso);let bt=document.createElement("span");bt.className="clock-time",bt.textContent=new Date(L.departureIso).toLocaleTimeString([],{hour:"2-digit",minute:"2-digit",hour12:!1}),et.appendChild(it),et.appendChild(bt),R.appendChild(G),R.appendChild(ut),R.appendChild(et),n.departuresEl.appendChild(R)}}function Ht(){n.nowClockEl&&(n.nowClockEl.textContent=new Date().toLocaleTimeString([],{hour:"2-digit",minute:"2-digit",second:"2-digit",hour12:!1}))}Object.assign(s,{formatMinutes:w,minutesUntil:A,departureRowClass:F,isHelsinkiBound:M,sanitizeStopSelections:k,getVisibleDepartures:X,updateModeButtons:st,updateModeLabels:nt,toggleResultsLimitDropdown:lt,selectResultsLimit:J,renderResultsLimitControl:dt,updateHelsinkiFilterButton:gt,countActiveStopFilters:pt,buildStopFilterSummary:ot,syncStopFiltersPanelUi:p,setStopFiltersPanelOpen:S,toggleStopFiltersPanel:g,setStopControlsVisibility:y,getStopMeta:O,getStopCodes:B,buildStopDisplay:P,buildModeStopDisplay:tt,updateDataScope:ct,renderFilterButtons:Et,toggleStopDropdown:_t,selectStop:vt,toggleLineFilter:E,toggleDestinationFilter:C,toggleLineFilterFromResultCard:wt,toggleDestinationFilterFromResultCard:At,toggleStopFromResultCard:Tt,isStopTargetActive:It,resolveStopTargetFromDeparture:Lt,resolveStopIdFromDeparture:Nt,setResultFilterTrigger:ht,clearResultFilterTrigger:W,triggerStopFilterAttention:a,renderStopControls:Ot,updateNextSummary:yt,buildStatusFromResponse:Ut,getLoadErrorStatus:Dt,getGeolocationErrorStatus:Pt,getVoiceLocationErrorStatus:qt,showSkeleton:Vt,hideSkeleton:kt,render:$t,updateClock:Ht})})();(()=>{let N=window.HMApp,{api:s,dom:n,state:t,constants:x}=N,{MODE_TRAM:D,MODE_METRO:v,MODE_BUS:c}=x;function I(a){return a===c||a===D||a===v}function V(a){return new Promise(d=>setTimeout(d,a))}async function Q(a,d={},p=x.FETCH_TIMEOUT_MS){let S=new AbortController,g=setTimeout(()=>S.abort(),p);try{return await fetch(a,{...d,signal:S.signal})}finally{clearTimeout(g)}}async function $(a,d={}){let p;try{p=await Q(a,d)}catch{return await V(350),Q(a,d)}return p.status>=500?(await V(350),Q(a,d)):p}function rt(a){let d=new Map,p=new Map;for(let g of a||[]){let y=String(g?.line||"").trim();y&&d.set(y,(d.get(y)||0)+1);let b=String(g?.destination||"").trim();b&&p.set(b,(p.get(b)||0)+1)}let S=g=>[...g.entries()].sort((y,b)=>b[1]-y[1]||y[0].localeCompare(b[0])).map(([y,b])=>({value:y,count:b}));return{lines:S(d),destinations:S(p)}}function f(a){let d=Array.isArray(a?.stops)?a.stops.filter(E=>E&&E.id&&E.name).map(E=>({id:E.id,name:E.name,code:String(E.code||"").trim()||null,memberStopIds:s.uniqueNonEmptyStrings([...Array.isArray(E.memberStopIds)?E.memberStopIds:[],E.id]),stopCodes:s.uniqueNonEmptyStrings([...Array.isArray(E.stopCodes)?E.stopCodes:[],E.code]),distanceMeters:Number(E.distanceMeters)||0})):[];t.busStops=d;let p=String(a?.selectedStopId||"").trim()||null,S=E=>d.some(C=>C.id===E),g=String(t.busStopId||"").trim()||null,y=!!(g&&!S(g)&&!(p&&S(p)));p&&S(p)?t.busStopId=p:(!t.busStopId||!S(t.busStopId))&&(t.busStopId=d[0]?.id||null);let b=d[0]?.id||null;t.busStopId?b&&t.busStopId!==b?t.stopFilterPinned=!0:y&&(t.stopFilterPinned=!1):t.stopFilterPinned=!1,t.deferInitialStopContext&&(t.deferInitialStopContext=!1,t.deferredBusStopId=null,t.deferredBusLineFilters=[],t.deferredBusDestinationFilters=[],t.busLineFilters=[],t.busDestinationFilters=[],t.stopFilterPinned=!1,t.busStopMemberFilterId=null),t.hasCompletedInitialStopModeLoad=!0;let i=Array.isArray(a?.station?.departures)?a.station.departures:[],u=new Set(i.map(E=>String(E?.stopId||"").trim()).filter(Boolean));t.stopFilterPinned?t.busStopMemberFilterId&&!u.has(String(t.busStopMemberFilterId).trim())&&(t.busStopMemberFilterId=null):t.busStopMemberFilterId=null,t.busFilterOptions=rt(i),s.sanitizeStopSelections()}function h(a,d){let p=new Error(d);return p.code=a,p}function _(a){return String(a?.code||"").trim().toLowerCase()}function T(){return s.uniqueNonEmptyStrings(["fi-FI","en-US",...Array.isArray(navigator.languages)?navigator.languages:[],navigator.language])}function w(){return typeof window.SpeechRecognition=="function"?window.SpeechRecognition:typeof window.webkitSpeechRecognition=="function"?window.webkitSpeechRecognition:null}function A(){return!!w()}function F(a){return a==="not-allowed"||a==="service-not-allowed"?h("voice_permission_denied","Microphone permission denied."):a==="audio-capture"?h("voice_no_microphone","No microphone available."):a==="language-not-supported"?h("voice_language_not_supported","Speech language is not supported."):a==="network"?h("voice_recognition_network","Voice recognition network error."):a==="no-speech"?h("voice_no_speech","No speech detected."):h("voice_not_understood","Voice recognition failed.")}function M(a){let d=w();return d?new Promise((p,S)=>{let g=new d,y=String(a||navigator.language||"fi-FI").trim();g.lang=y||"fi-FI",g.continuous=!1,g.interimResults=!0,g.maxAlternatives=1;let b=!1,i="",u=null,E=!1,C=()=>{clearTimeout(u),u=null},O=()=>{if(!(E||b)){E=!0;try{g.stop()}catch{}}},B=()=>{C(),u=setTimeout(O,x.VOICE_SILENCE_STOP_MS)},Z=()=>{clearTimeout(tt),C(),g.onresult=null,g.onerror=null,g.onend=null,g.onspeechend=null,g.onsoundend=null,g.onaudioend=null,g.onnomatch=null},P=(U,q)=>{b||(b=!0,Z(),U(q))},tt=setTimeout(()=>{try{g.abort()}catch{}P(S,h("voice_recognition_timeout","Voice recognition timed out."))},x.VOICE_RECOGNITION_TIMEOUT_MS);g.onresult=U=>{for(let q=U?.resultIndex||0;q<(U?.results?.length||0);q+=1){let mt=U.results[q],ct=String(mt?.[0]?.transcript||"").trim();if(ct&&(i=ct,B(),mt?.isFinal)){O();return}}},g.onerror=U=>{let q=String(U?.error||"").trim().toLowerCase();P(S,F(q))},g.onend=()=>{if(b)return;let U=String(i||"").trim();if(!U){P(S,h("voice_no_speech","No speech detected."));return}P(p,U)},g.onspeechend=()=>{O()},g.onsoundend=()=>{B()},g.onaudioend=()=>{B()},g.onnomatch=()=>{P(S,h("voice_not_understood","Could not understand speech."))};try{g.start()}catch(U){let q=String(U?.name||"").trim().toLowerCase();if(q==="notallowederror"||q==="securityerror"){P(S,h("voice_permission_denied","Microphone permission denied."));return}P(S,h("voice_not_understood","Unable to start voice recognition."))}}):Promise.reject(h("voice_unsupported","Voice recognition not supported."))}function k(a){return a==="voice_no_speech"||a==="voice_not_understood"||a==="voice_recognition_timeout"||a==="voice_language_not_supported"}async function X(){let a=T(),d=null;for(let p of a)try{return await M(p)}catch(S){if(d=S,!k(_(S)))break}throw d||h("voice_not_understood","Voice recognition failed.")}function st(a){return Array.isArray(a)?a.map(d=>{let p=Number(d?.lat),S=Number(d?.lon);return!Number.isFinite(p)||!Number.isFinite(S)?null:{lat:p,lon:S,label:String(d?.label||"").trim()}}).filter(Boolean):[]}function nt(){n.voiceLocationChoicesEl&&n.voiceLocationChoicesEl.classList.add("hidden"),n.voiceLocationChoicesTitleEl&&(n.voiceLocationChoicesTitleEl.textContent=""),n.voiceLocationChoicesOptionsEl&&(n.voiceLocationChoicesOptionsEl.innerHTML=""),n.voiceLocationChoicesCancelEl&&(n.voiceLocationChoicesCancelEl.onclick=null)}function lt(a,d){if(typeof window.prompt!="function")throw h("voice_location_selection_cancelled","Location selection was cancelled.");let p=d.map((y,b)=>`${b+1}. ${y.label||`${y.lat}, ${y.lon}`}`).join(`
`),S=window.prompt(`Multiple matches found for "${s.safeString(a,80)}". Select number:
${p}`,"1");if(S==null)throw h("voice_location_selection_cancelled","Location selection was cancelled.");let g=Number.parseInt(String(S).trim(),10);if(!Number.isInteger(g)||g<1||g>d.length)throw h("voice_location_selection_invalid","Invalid location selection.");return d[g-1]}async function J(a,d){if(!Array.isArray(d)||d.length===0)throw h("voice_location_not_found","No matching location found.");return!n.voiceLocationChoicesEl||!n.voiceLocationChoicesTitleEl||!n.voiceLocationChoicesOptionsEl||!n.voiceLocationChoicesCancelEl?lt(a,d):new Promise((p,S)=>{let g=!1,y=(b,i)=>{g||(g=!0,nt(),b(i))};n.voiceLocationChoicesTitleEl.textContent=`Multiple matches for "${s.safeString(a,80)}". Choose one:`,s.setStatus("Multiple matches found. Choose one below."),n.voiceLocationChoicesOptionsEl.innerHTML="";for(let b of d){let i=document.createElement("button");i.type="button",i.className="voice-location-choice-option",i.textContent=b.label||`${b.lat.toFixed(5)}, ${b.lon.toFixed(5)}`,i.addEventListener("click",()=>y(p,b),{once:!0}),n.voiceLocationChoicesOptionsEl.appendChild(i)}n.voiceLocationChoicesCancelEl.onclick=()=>y(S,h("voice_location_selection_cancelled","Location selection was cancelled.")),n.voiceLocationChoicesEl.classList.remove("hidden")})}async function dt(a){let d=String(a||"").trim();if(d.length<x.VOICE_QUERY_MIN_LENGTH)throw h("voice_query_too_short","Voice query too short.");let p=new URLSearchParams({text:d});t.currentCoords&&(p.set("lat",String(t.currentCoords.lat)),p.set("lon",String(t.currentCoords.lon)));let S=Array.isArray(navigator.languages)&&navigator.languages[0]||navigator.language||"";S&&p.set("lang",String(S));let g;try{g=await $(`/api/v1/geocode?${p.toString()}`)}catch{throw h("voice_geocode_failed","Location lookup failed.")}if(!(g.headers.get("content-type")||"").includes("application/json"))throw h("voice_geocode_failed","Unexpected location lookup response.");let b=await g.json();if(!g.ok)throw h("voice_geocode_failed",String(b?.error||"Location lookup failed.").trim());let i=st(b?.choices);if(b?.ambiguous&&i.length>1){let C=await J(d,i);return{lat:C.lat,lon:C.lon,label:C.label,query:d}}let u=Number(b?.location?.lat),E=Number(b?.location?.lon);if(!Number.isFinite(u)||!Number.isFinite(E))throw h("voice_location_not_found","No matching location found.");return{lat:u,lon:E,label:String(b?.location?.label||"").trim(),query:d}}function gt(a){return a==="voice_unsupported"||a==="voice_no_speech"||a==="voice_recognition_timeout"||a==="voice_recognition_network"||a==="voice_not_understood"}function pt(a){if(!gt(a)||typeof window.prompt!="function")return null;let d=a==="voice_unsupported"?"Voice input is limited in this browser. Type your location instead:":"Could not capture your voice on this device. Type your location:",p=window.prompt(`${d}
Example: Kamppi Helsinki`,"");return String(p||"").trim()||null}async function ot(a){let d=String(a||"").trim();nt(),s.setStatus(`Looking up "${s.safeString(d,80)}"...`);let p=await dt(d);return s.setResolvedLocationHint({query:d,label:p.label,lat:p.lat,lon:p.lon}),t.currentCoords={lat:p.lat,lon:p.lon},s.setPermissionRequired(!1),await H(p.lat,p.lon),!0}async function K(){if(t.isLoading||t.isVoiceListening)return!1;nt(),s.setVoiceListening(!0),s.setStatus("Listening... speak now, then pause.");try{if(!A()){let d=h("voice_unsupported","Voice recognition not supported."),p=pt(_(d));return p?ot(p):(s.setStatus(s.getVoiceLocationErrorStatus(d)),!1)}let a=await X();return ot(a)}catch(a){let d=_(a),p=pt(d);if(p)try{return await ot(p)}catch(S){return console.error("voice fallback location error:",S),s.reportClientError("voice-location-fallback",S,{mode:t.mode,sourceCode:d||"unknown"}),s.setStatus(s.getVoiceLocationErrorStatus(S)),!1}return(!d||d==="unknown")&&console.error("voice location error:",a),s.reportClientError("voice-location",a,{mode:t.mode,code:d||"unknown"}),s.setStatus(s.getVoiceLocationErrorStatus(a)),!1}finally{s.setVoiceListening(!1)}}async function H(a,d){let p=++t.latestLoadToken,S=t.mode,g=t.busStopId,y=I(S)&&!t.hasCompletedInitialStopModeLoad;s.setLoading(!0),s.setStatus("Loading departures...");try{let b=new URLSearchParams({lat:String(a),lon:String(d),mode:S.toUpperCase(),results:String(s.getActiveResultsLimit(S))}),i=I(S)&&(t.deferInitialStopContext||!t.hasCompletedInitialStopModeLoad);I(S)&&g&&!i&&b.set("stopId",g);let u=await $(`/api/v1/departures?${b.toString()}`);if(!(u.headers.get("content-type")||"").includes("application/json"))throw u.ok?new Error("Unexpected server response."):new Error("Request failed");let C=await u.json();if(!u.ok)throw new Error(C.error||"Request failed");if(p!==t.latestLoadToken)return;I(S)&&(f(C),s.persistUiState(),y&&s.trackInitialNearestStopResolved(C,S)),t.latestResponse=C,s.render(C),s.setPermissionRequired(!1),s.setLastUpdated(new Date),s.setStatus(s.buildStatusFromResponse(C)),s.trackFirstSuccessfulRender(C,S)}catch(b){if(p!==t.latestLoadToken)return;t.latestResponse=null,console.error("load departures error:",b),s.reportClientError("load",b,{mode:S}),s.setStatus(s.getLoadErrorStatus(b)),n.resultEl.classList.add("hidden"),s.updateNextSummary(null)}finally{p===t.latestLoadToken&&s.setLoading(!1)}}function Y(){if(nt(),s.setResolvedLocationHint(null),!navigator.geolocation)return s.setStatus("Geolocation not supported in this browser."),s.setPermissionRequired(!0),!1;if(t.isLoading||t.isVoiceListening)return!1;s.setStatus("Getting your location..."),s.setLoading(!0);let a=y=>({enableHighAccuracy:y,timeout:y?15e3:1e4,maximumAge:0}),d=(y,b)=>b?!1:y?.code===2||y?.code===3,p=y=>{t.currentCoords={lat:y.coords.latitude,lon:y.coords.longitude},t.locationGranted=!0,s.setStorageItem("location:granted","1"),s.setPermissionRequired(!1),s.setLoading(!1),H(t.currentCoords.lat,t.currentCoords.lon)},S=y=>{y.code===1?s.setPermissionRequired(!0):s.setPermissionRequired(!1),s.setStatus(s.getGeolocationErrorStatus(y)),t.latestResponse=null,n.resultEl.classList.add("hidden"),s.updateNextSummary(null),s.setLoading(!1)},g=y=>{navigator.geolocation.getCurrentPosition(p,b=>{if(d(b,y)){g(!0);return}S(b)},a(y))};return g(!1),!0}function j(){if(!t.isVoiceListening){if(t.currentCoords){H(t.currentCoords.lat,t.currentCoords.lon);return}Y()}}function at(a={}){let d=!!a.modeOnly;s.updateModeButtons(),s.updateModeLabels(),!d&&(s.renderResultsLimitControl(),s.updateHelsinkiFilterButton(),s.renderStopControls(),s.updateDataScope(t.latestResponse))}Object.assign(s,{delay:V,fetchWithTimeout:Q,fetchWithRetryOnce:$,updateStopModeStateFromResponse:f,buildFilterOptionsFromDepartures:rt,load:H,requestLocationAndLoad:Y,requestVoiceLocationAndLoad:K,supportsVoiceLocation:A,captureVoiceQuery:M,captureVoiceQueryWithRetry:X,getVoiceRecognitionLanguages:T,shouldRetryVoiceRecognition:k,resolveVoiceLocationQuery:dt,refreshDeparturesOnly:j,applyModeUiState:at})})();(()=>{let N=window.HMApp,{api:s,dom:n,state:t,constants:x}=N,{MODE_RAIL:D,MODE_TRAM:v,MODE_METRO:c,MODE_BUS:I}=x;function V(){if(t.currentCoords){s.load(t.currentCoords.lat,t.currentCoords.lon);return}s.requestLocationAndLoad()}function Q(f){if(typeof window.requestAnimationFrame=="function"){window.requestAnimationFrame(f);return}setTimeout(f,0)}function $(f){t.mode!==f&&(s.trackFirstManualInteraction("mode_change",{toMode:f}),t.mode=f,f!==D&&(t.helsinkiOnly=!1),s.applyModeUiState({modeOnly:!0}),Q(()=>{s.applyModeUiState(),s.persistUiState(),V()}))}n.locateBtn?.addEventListener("click",()=>{s.trackFirstManualInteraction("refresh_location_click"),s.requestLocationAndLoad()}),n.voiceLocateBtn?.addEventListener("click",()=>{s.trackFirstManualInteraction("voice_location_click"),s.requestVoiceLocationAndLoad()}),n.modeRailBtn?.addEventListener("click",()=>{$(D)}),n.modeTramBtn?.addEventListener("click",()=>{$(v)}),n.modeMetroBtn?.addEventListener("click",()=>{$(c)}),n.modeBusBtn?.addEventListener("click",()=>{$(I)}),n.resultsLimitSelectEl?.addEventListener("click",f=>{f.stopPropagation(),s.toggleResultsLimitDropdown()}),document.addEventListener("click",f=>{n.resultsLimitSelectWrapEl&&(n.resultsLimitSelectWrapEl.contains(f.target)||s.toggleResultsLimitDropdown(!1))}),n.resultsLimitSelectEl?.addEventListener("keydown",f=>{let h=n.resultsLimitSelectListEl;if(!h)return;let _=n.resultsLimitSelectEl.getAttribute("aria-expanded")==="true";if(f.key==="Escape"){s.toggleResultsLimitDropdown(!1),n.resultsLimitSelectEl.focus(),f.preventDefault();return}if(f.key==="Enter"||f.key===" "){if(!_){s.toggleResultsLimitDropdown(!0),f.preventDefault();return}let T=h.querySelector(".is-focused");T?.dataset?.value&&s.selectResultsLimit(T.dataset.value),f.preventDefault();return}if(f.key==="ArrowDown"||f.key==="ArrowUp"){if(f.preventDefault(),!_){s.toggleResultsLimitDropdown(!0);return}let T=[...h.querySelectorAll("li[role='option']")];if(T.length===0)return;let w=T.findIndex(F=>F.classList.contains("is-focused")),A;f.key==="ArrowDown"?A=w<T.length-1?w+1:0:A=w>0?w-1:T.length-1;for(let F of T)F.classList.remove("is-focused");T[A].classList.add("is-focused"),T[A].scrollIntoView({block:"nearest"})}}),n.busStopSelectEl?.addEventListener("click",f=>{f.stopPropagation(),s.toggleStopDropdown()}),document.addEventListener("click",f=>{n.busStopSelectWrapEl&&(n.busStopSelectWrapEl.contains(f.target)||s.toggleStopDropdown(!1))}),n.busStopSelectEl?.addEventListener("keydown",f=>{let h=n.busStopSelectListEl;if(!h)return;let _=n.busStopSelectEl.getAttribute("aria-expanded")==="true";if(f.key==="Escape"){s.toggleStopDropdown(!1),n.busStopSelectEl.focus(),f.preventDefault();return}if(f.key==="Enter"||f.key===" "){if(!_){s.toggleStopDropdown(!0),f.preventDefault();return}let T=h.querySelector(".is-focused");T?.dataset?.value&&s.selectStop(T.dataset.value),f.preventDefault();return}if(f.key==="ArrowDown"||f.key==="ArrowUp"){if(f.preventDefault(),!_){s.toggleStopDropdown(!0);return}let T=[...h.querySelectorAll("li[role='option']")];if(T.length===0)return;let w=T.findIndex(F=>F.classList.contains("is-focused")),A;f.key==="ArrowDown"?A=w<T.length-1?w+1:0:A=w>0?w-1:T.length-1;for(let F of T)F.classList.remove("is-focused");T[A].classList.add("is-focused"),T[A].scrollIntoView({block:"nearest"})}}),n.stopFiltersToggleBtnEl?.addEventListener("click",()=>{s.trackFirstManualInteraction("stop_filters_panel_toggle",{currentMode:t.mode}),s.toggleStopFiltersPanel()}),n.helsinkiOnlyBtn?.addEventListener("click",()=>{t.mode===D&&(s.trackFirstManualInteraction("helsinki_only_toggle"),t.helsinkiOnly=!t.helsinkiOnly,s.persistUiState(),s.updateHelsinkiFilterButton(),t.latestResponse&&(s.render(t.latestResponse),s.setStatus(s.buildStatusFromResponse(t.latestResponse))))}),n.locationPromptAllowEl?.addEventListener("click",()=>{s.hideLocationPrompt(),s.requestLocationAndLoad()}),n.permissionRetryBtnEl?.addEventListener("click",()=>{s.trackFirstManualInteraction("permission_retry_click"),s.requestLocationAndLoad()}),s.hydrateInitialState(),s.applyModeUiState(),s.updateClock(),setInterval(s.updateClock,1e3),s.getStorageItem("location:granted")==="1"?s.requestLocationAndLoad():(s.showLocationPrompt(),s.setStatus("Tap Allow Location to get started.")),setInterval(s.refreshDeparturesOnly,3e4),window.addEventListener("error",f=>{s.reportClientError("error",f.error||f.message||"Unknown error",{source:f.filename||"",line:f.lineno||null,column:f.colno||null})}),window.addEventListener("unhandledrejection",f=>{s.reportClientError("unhandledrejection",f.reason||"Unhandled promise rejection")}),(()=>{let f=document.getElementById("themeToggle");if(!f)return;let h=document.documentElement,_=window.matchMedia("(prefers-color-scheme: dark)"),T=()=>{let M=s.getStorageItem("theme");return M==="dark"||M==="light"?M:null},w=M=>{h.setAttribute("data-theme",M==="light"?"light":"dark")},A=()=>{let M=T();if(M){w(M);return}w(_.matches?"dark":"light")},F=M=>{T()||w(M.matches?"dark":"light")};A(),typeof _.addEventListener=="function"?_.addEventListener("change",F):typeof _.addListener=="function"&&_.addListener(F),f.addEventListener("click",()=>{let M=h.getAttribute("data-theme")==="dark"?"light":"dark";w(M),s.setStorageItem("theme",M)})})()})();})();
